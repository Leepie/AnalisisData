<!DOCTYPE html>
<html lang="ms">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>DATAANALISIS â€” DEBUG</title>

  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Chart.js CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-gray-50 text-gray-800">

  <header class="bg-white shadow p-4">
    <h1 class="text-xl font-bold">Data Analisis (Debug)</h1>
    <p class="text-sm text-gray-500">Percubaan Debug CSV</p>
  </header>

  <main class="p-4">
    <button onclick="generateOverallAnalysis()" class="bg-blue-600 text-white px-4 py-2 rounded">
      Jana Analisis
    </button>

    <div class="mt-4">
      <p>Gred Purata: <span id="schoolGPS">--</span></p>
      <p>Layak Sijil: <span id="footerCertificatePercent">--%</span></p>
      <p>Jumlah Murid: <span id="studentCount">--</span></p>
    </div>
  </main>

  <script>
    const csvUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTYrHZLkbHUM-5jja039uj6kW8gImj4V3pdg253c8C8wZfjVPusU2XT_0M9qjA6kq-X1wiFI4z2FIDq/pub?gid=22937657&single=true&output=csv";

    let parsedData = [];
    let headerMap = {};
    let subjectColumns = [];

    function loadData() {
      fetch(csvUrl)
        .then(response => response.text())
        .then(csv => {
          console.log("CSV mentah (500 aksara pertama):", csv.slice(0, 500));

          parsedData = parseCSV(csv);
          console.log("Jumlah rekod CSV:", parsedData.length);
        })
        .catch(error => {
          console.error("Ralat semasa memuat data:", error);
        });
    }

    function parseCSV(csv) {
      const lines = csv.trim().split('\n');
      const headers = lines[0].split(',').map(h => h.trim());
      console.log("Header CSV:", headers);

      // bina peta header
      headers.forEach(h => { headerMap[h.toLowerCase()] = h; });

      // auto detect kolum gred (lajur berakhir dengan "G")
      subjectColumns = headers.filter(h => h.endsWith("G"));
      console.log("Kolum Gred Dikesan:", subjectColumns);

      return lines.slice(1).map(line => {
        const values = line.split(',');
        let obj = {};
        headers.forEach((h, i) => obj[h] = values[i]?.trim() || '');
        return obj;
      });
    }

    const gradeValueMapping = {
      "A+": 0.00, "A": 1.00, "A-": 2.00,
      "B+": 3.00, "B": 4.00, "C+": 5.00,
      "C": 6.00, "D": 7.00, "E": 8.00, "G": 9.00
    };

    function generateOverallAnalysis() {
      if (!parsedData || parsedData.length === 0) {
        alert("Data belum dimuatkan.");
        return;
      }

      const kelasHeader = headerMap["kelas"];
      const namaHeader = headerMap["nama"];
      if (!kelasHeader || !namaHeader) {
        alert("Kolum 'KELAS' atau 'NAMA' tidak ditemui!");
        return;
      }

      const muridMap = {};
      parsedData.forEach(row => {
        const nama = row[namaHeader];
        if (!muridMap[nama]) muridMap[nama] = [];

        subjectColumns.forEach(col => {
          const gred = row[col]?.trim().toUpperCase();
          if (gradeValueMapping.hasOwnProperty(gred)) {
            muridMap[nama].push(gred);
          }
        });
      });

      let jumlahMurid = 0, jumlahGredNilai = 0, jumlahSubjek = 0, muridLayak = 0;

      for (const nama in muridMap) {
        const gredList = muridMap[nama];
        if (gredList.length === 0) continue;

        jumlahMurid++;
        let adaG = false;

        gredList.forEach(gred => {
          const nilai = gradeValueMapping[gred];
          jumlahGredNilai += nilai;
          jumlahSubjek++;
          if (gred === "G") adaG = true;
        });

        if (gredList.length >= 6 && !adaG) muridLayak++;
      }

      const GPS = (jumlahSubjek > 0) ? (jumlahGredNilai / jumlahSubjek).toFixed(2) : "--";
      const peratusLayak = (jumlahMurid > 0) ? ((muridLayak / jumlahMurid) * 100).toFixed(1) + "%" : "--%";

      document.getElementById("schoolGPS").textContent = GPS;
      document.getElementById("footerCertificatePercent").textContent = peratusLayak;
      document.getElementById("studentCount").textContent = jumlahMurid;

      console.log("GPS:", GPS, "| Layak Sijil:", peratusLayak, "| Murid:", jumlahMurid);
    }

    window.onload = loadData;
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="ms">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>DATAANALISIS â€” CUBAAN</title>

  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Chart.js CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-gray-50 text-gray-800">

  <!-- Header -->
  <header class="bg-gradient-to-r from-blue-600 to-indigo-600 text-white shadow p-6 flex items-center justify-between">
    <div>
      <h1 class="text-2xl font-bold">ðŸ“Š Data Analisis</h1>
      <p class="text-sm opacity-90">Percubaan SPM 2025</p>
    </div>
  </header>

  <!-- Kandungan -->
  <main class="p-6 space-y-6 max-w-6xl mx-auto">
    <!-- Kawalan -->
    <div class="bg-white rounded shadow p-4 flex flex-col md:flex-row items-center gap-4">
      <label for="kelasFilter" class="text-sm font-medium text-gray-700">Pilih Kelas</label>
      <select id="kelasFilter" class="border rounded px-3 py-2">
        <option>PILIH KELAS</option>
        <option>SEMUA KELAS</option>
      </select>
      <button onclick="generateOverallAnalysis()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded font-medium">
        Jana Analisis
      </button>
    </div>

    <!-- Kad Statistik -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 text-white">
      <div class="bg-blue-500 rounded-xl p-6 shadow flex flex-col justify-between">
        <p class="text-sm opacity-80">Gred Purata</p>
        <p class="text-3xl font-bold" id="schoolGPS">--</p>
      </div>
      <div class="bg-green-500 rounded-xl p-6 shadow flex flex-col justify-between">
        <p class="text-sm opacity-80">Layak Sijil</p>
        <p class="text-3xl font-bold" id="footerCertificatePercent">--%</p>
      </div>
      <div class="bg-purple-500 rounded-xl p-6 shadow flex flex-col justify-between">
        <p class="text-sm opacity-80">Jumlah Murid</p>
        <p class="text-3xl font-bold" id="studentCount">--</p>
      </div>
    </div>

    <!-- Carta -->
    <div class="bg-white rounded-xl shadow p-6">
      <h2 class="text-lg font-semibold mb-4">ðŸ“ˆ Carta Taburan Gred</h2>
      <canvas id="gradeChart" height="120"></canvas>
    </div>
  </main>

  <script>
    const csvUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTYrHZLkbHUM-5jja039uj6kW8gImj4V3pdg253c8C8wZfjVPusU2XT_0M9qjA6kq-X1wiFI4z2FIDq/pub?gid=22937657&single=true&output=csv";

    let parsedData = [];
    let headerMap = {};
    let subjectColumns = [];
    let chartInstance = null;

    function loadData() {
      fetch(csvUrl)
        .then(response => response.text())
        .then(csv => {
          parsedData = parseCSV(csv);
          console.log("Jumlah rekod CSV:", parsedData.length);
          autoIsiDropdownKelas(parsedData);
        })
        .catch(error => {
          console.error("Ralat semasa memuat data:", error);
        });
    }

    // --- parse CSV ---
    function parseCSV(csv) {
      const lines = csv.trim().split('\n');

      const lineSubjek = lines[1].split(',').map(h => h.trim());
      const lineJenis  = lines[2].split(',').map(h => h.trim());

      let currentSubjek = "";
      const headers = lineSubjek.map((subjek, i) => {
        if (subjek) {
          currentSubjek = subjek;
        }
        if (lineJenis[i]) {
          return `${currentSubjek} ${lineJenis[i]}`.trim();
        }
        return currentSubjek || subjek;
      });

      console.log("Header CSV (gabungan):", headers);

      headers.forEach(h => { headerMap[h.toLowerCase()] = h; });

      subjectColumns = headers.filter(h => h.endsWith("G"));
      console.log("Kolum Gred Dikesan:", subjectColumns);

      return lines.slice(3).map(line => {
        const values = line.split(',');
        let obj = {};
        headers.forEach((h, i) => obj[h] = values[i]?.trim() || '');
        return obj;
      });
    }

    // --- cari kolum ---
    function cariKolum(keyword) {
      keyword = keyword.toLowerCase();
      return Object.values(headerMap).find(h => h.toLowerCase().includes(keyword));
    }

    // --- auto isi dropdown kelas ---
    function autoIsiDropdownKelas(data) {
      const kelasHeader = cariKolum("kelas");
      if (!kelasHeader) return;

      const kelasSet = new Set(data.map(r => r[kelasHeader]?.trim()).filter(Boolean));
      const kelasFilter = document.getElementById("kelasFilter");

      kelasFilter.innerHTML = `<option>PILIH KELAS</option><option>SEMUA KELAS</option>`;
      kelasSet.forEach(k => {
        const opt = document.createElement("option");
        opt.value = k;
        opt.textContent = k;
        kelasFilter.appendChild(opt);
      });

      console.log("Dropdown Kelas Auto-isi:", [...kelasSet]);
    }

    // --- nilai gred ---
    const gradeValueMapping = {
      "A+": 0.00, "A": 1.00, "A-": 2.00,
      "B+": 3.00, "B": 4.00, "C+": 5.00,
      "C": 6.00, "D": 7.00, "E": 8.00, "G": 9.00
    };

    const gradeLabels = ["A+","A","A-","B+","B","C+","C","D","E","G"];

    // --- analisis keseluruhan ---
    function generateOverallAnalysis() {
      if (!parsedData || parsedData.length === 0) {
        alert("Data belum dimuatkan.");
        return;
      }

      const kelasHeader = cariKolum("kelas");
      const namaHeader  = cariKolum("nama");

      const kelasTerpilih = document.getElementById("kelasFilter").value;

      let dataTapis = [];
      if (kelasTerpilih === "SEMUA KELAS") {
        dataTapis = parsedData;
      } else {
        dataTapis = parsedData.filter(row =>
          row[kelasHeader]?.trim().toUpperCase() === kelasTerpilih.trim().toUpperCase()
        );
      }

      const muridMap = {};
      dataTapis.forEach(row => {
        const nama = row[namaHeader];
        if (!muridMap[nama]) muridMap[nama] = [];
        subjectColumns.forEach(col => {
          const gred = row[col]?.trim().toUpperCase();
          if (gradeValueMapping.hasOwnProperty(gred)) {
            muridMap[nama].push(gred);
          }
        });
      });

      let jumlahMurid = 0, jumlahGredNilai = 0, jumlahSubjek = 0, muridLayak = 0;
      const gradeCounts = Object.fromEntries(gradeLabels.map(g => [g, 0]));

      for (const nama in muridMap) {
        const gredList = muridMap[nama];
        if (gredList.length === 0) continue;

        jumlahMurid++;
        let adaG = false;

        gredList.forEach(gred => {
          const nilai = gradeValueMapping[gred];
          jumlahGredNilai += nilai;
          jumlahSubjek++;
          gradeCounts[gred]++;
          if (gred === "G") adaG = true;
        });

        if (gredList.length >= 6 && !adaG) muridLayak++;
      }

      const GPS = (jumlahSubjek > 0) ? (jumlahGredNilai / jumlahSubjek).toFixed(2) : "--";
      const peratusLayak = (jumlahMurid > 0) ? ((muridLayak / jumlahMurid) * 100).toFixed(1) + "%" : "--%";

      document.getElementById("schoolGPS").textContent = GPS;
      document.getElementById("footerCertificatePercent").textContent = peratusLayak;
      document.getElementById("studentCount").textContent = jumlahMurid;

      // --- update carta ---
      updateGradeChart(gradeCounts);
    }

    // --- carta taburan gred ---
    function updateGradeChart(gradeCounts) {
      const ctx = document.getElementById("gradeChart").getContext("2d");

      if (chartInstance) {
        chartInstance.destroy();
      }

      chartInstance = new Chart(ctx, {
        type: "bar",
        data: {
          labels: gradeLabels,
          datasets: [{
            label: "Bilangan Gred",
            data: gradeLabels.map(g => gradeCounts[g] || 0),
            backgroundColor: [
              "#3b82f6","#2563eb","#4f46e5",
              "#10b981","#059669","#f59e0b",
              "#ef4444","#dc2626","#6b7280","#111827"
            ]
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { display: false }
          },
          scales: {
            y: { beginAtZero: true }
          }
        }
      });
    }

    window.onload = loadData;
  </script>
</body>
</html>

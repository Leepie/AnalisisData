<!DOCTYPE html>
<html lang="ms">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>PPSA vs PraSPM</title>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    /* Header */
    header{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    .pulse-dot{position:relative}
    .pulse-dot::after{content:"";position:absolute;inset:-6px;border-radius:9999px;border:2px solid rgba(34,197,94,.4);animation:pulse 1.6s cubic-bezier(.4,0,.2,1) infinite}
    @keyframes pulse{0%{transform:scale(.6);opacity:.9}70%{transform:scale(1.4);opacity:0}100%{transform:scale(1.4);opacity:0}}

    /* Tab menu cards */
    .analysis-tabs .card-hover{
      height:5.5rem;border:1px solid #e5e7eb;border-radius:14px;background:#fff;
      display:flex;align-items:center;justify-content:center;flex-direction:column;
      box-shadow:0 1px 2px rgba(16,24,40,.06);
      transition:transform .08s ease, box-shadow .15s ease;
    }
    .analysis-tabs .card-hover:hover{transform:translateY(-3px);box-shadow:0 10px 20px rgba(16,24,40,.12)}
    .analysis-tabs .tab-active{
      background:linear-gradient(135deg,#3b82f6 0%,#4f46e5 100%) !important;color:#fff !important;border-color:transparent !important;
      box-shadow:0 12px 24px rgba(79,70,229,.26);
    }
    .analysis-tabs .card-hover .text-lg{font-size:22px;line-height:1}
    .analysis-tabs .card-hover .text-sm{font-size:15px;font-weight:400}

    /* Panel Analisis Keseluruhan + input */
    body{background:#f8fafc;color:#111827;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    .sticky-card{position:sticky;top:0;z-index:40}
    .field-label{font-size:0.95rem;color:#374151;font-weight:600}
    .select-like{
      width:100%;border:1px solid #e5e7eb;border-radius:0.75rem;padding:0.75rem 1rem;font-size:0.95rem;background:#fff;
      box-shadow:0 1px 2px rgba(16,24,40,.04);outline:none;transition:border-color .15s, box-shadow .15s;
    }
    .select-like:focus{border-color:#3b82f6;box-shadow:0 0 0 3px rgba(59,130,246,.25)}
    .btn-primary{
      display:inline-flex;align-items:center;justify-content:center;width:100%;padding:0.875rem 1rem;border-radius:0.9rem;font-weight:700;
      color:#fff;background:#3b5bfd;box-shadow:0 1px 3px rgba(59,91,253,.25);transition:transform .06s, filter .15s;
    }
    .btn-primary:hover{filter:brightness(1.05)}
    .btn-primary:active{transform:scale(.985)}
    .container-max{max-width:1200px;margin-left:auto;margin-right:auto}

    /* Carta (kekal saiz) */
    .chart-fixed{height:320px}
    @media (max-width:1024px){.chart-fixed{height:300px}}
    @media (max-width:640px){.chart-fixed{height:260px}}
    #gradeChart{width:100% !important;height:100% !important;display:block}

    /* Butang sort GPMP (3-laras) */
    .sort-btn{display:inline-flex;flex-direction:column;align-items:center;justify-content:center;margin-left:6px;cursor:pointer}
    .sort-btn svg{width:12px;height:12px;fill:#d1d5db}
    .sort-btn.asc .up{fill:#fff}
    .sort-btn.desc .down{fill:#fff}
  </style>
</head>
<body class="bg-gray-50 text-gray-800">

  <!-- HEADER -->
  <header class="bg-white shadow-sm border-b">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
      <div class="flex items-center justify-between">
        <div class="flex items-center space-x-4">
          <img src="https://upload.wikimedia.org/wikipedia/ms/b/ba/Sekolah_Menengah_Kebangsaan_Dato%27_Kamaruddin.jpg"
               alt="SMK Dato' Kamaruddin Logo" class="h-16 w-16 object-contain rounded-full border"/>
          <div>
            <h1 class="text-2xl font-bold text-gray-900">PraSPM</h1>
            <p class="text-sm text-gray-600">AEE6058</p>
            <p class="text-sm font-medium text-gray-800">SMK Dato` Kamaruddin</p>
            <div class="flex items-center space-x-2 mt-1">
              <div class="w-2 h-2 bg-green-500 rounded-full pulse-dot"></div>
              <span class="text-xs text-gray-600">XCode Mr LePaK</span>
            </div>
          </div>
        </div>

        <div class="flex space-x-6">
          <div class="text-center">
            <div class="text-3xl font-bold text-blue-600" id="gpsValue">-</div>
            <div class="text-sm text-gray-600">Gred Purata Sekolah</div>
          </div>
          <div class="text-center">
            <div class="text-3xl font-bold text-green-600" id="layakSijilValue">-</div>
            <div class="text-sm text-gray-600">Peratus Layak Sijil</div>
          </div>
        </div>
      </div>
    </div>
  </header>

  <!-- MENU TAB -->
  <div class="analysis-tabs max-w-[1200px] mx-auto px-4 pt-6 pb-1">
    <div class="grid grid-cols-1 md:grid-cols-5 gap-4 mb-1">
      <button onclick="switchTab('keseluruhan')" id="tab-keseluruhan"
              class="tab-active card-hover p-4 rounded-lg text-center transition-all">
        <div class="text-lg mb-1">üìä</div>
        <div class="text-sm">Analisis Keseluruhan</div>
      </button>
      <button onclick="switchTab('matapelajaran')" id="tab-matapelajaran" class="bg-white card-hover p-4 rounded-lg text-center transition-all">
        <div class="text-lg mb-1">üìö</div>
        <div class="text-sm">Analisis Mata Pelajaran</div>
      </button>
      <button onclick="switchTab('layaksijil')" id="tab-layaksijil" class="bg-white card-hover p-4 rounded-lg text-center transition-all">
        <div class="text-lg mb-1">üéì</div>
        <div class="text-sm">Analisis Layak Sijil</div>
      </button>
      <button onclick="switchTab('combatzone')" id="tab-combatzone" class="bg-white card-hover p-4 rounded-lg text-center transition-all">
        <div class="text-lg mb-1">‚ö†Ô∏è</div>
        <div class="text-sm">Analisis Combat Zone</div>
      </button>
      <button onclick="switchTab('individu')" id="tab-individu" class="bg-white card-hover p-4 rounded-lg text-center transition-all">
        <div class="text-lg mb-1">üë§</div>
        <div class="text-sm">Analisis Individu</div>
      </button>
    </div>
  </div>

  <!-- PANEL: Analisis Keseluruhan (Sticky) -->
  <section data-tab-panel="keseluruhan" class="sticky-card bg-white/80 backdrop-blur border-b border-gray-100">
    <div class="container-max px-4 py-3">
      <div class="bg-white rounded-2xl shadow-sm border border-gray-100 px-4 sm:px-6 py-5">
        <h2 class="text-xl font-semibold text-gray-800 flex items-center gap-2 mb-5">
          <span>üìä</span> Analisis Keseluruhan
        </h2>

        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
          <div>
            <label for="kelasFilter" class="field-label">Kelas</label>
            <select id="kelasFilter" class="select-like mt-1">
              <option value="">Pilih Kelas</option>
            </select>
          </div>
          <div>
            <label for="bidangFilter" class="field-label">Bidang</label>
            <select id="bidangFilter" class="select-like mt-1">
              <option value="Semua Bidang">Semua Bidang</option>
              <option value="Bahasa">Bahasa</option>
              <option value="Kemanusiaan">Kemanusiaan</option>
              <option value="Sains & Matematik">Sains & Matematik</option>
              <option value="Teknik & Vokasional">Teknik & Vokasional</option>
            </select>
          </div>
          <div>
            <label for="topStudentsCount" class="field-label">Murid Terbaik</label>
            <select id="topStudentsCount" class="select-like mt-1">
              <option value="5">Top 5</option>
              <option value="10">Top 10</option>
              <option value="20">Top 20</option>
            </select>
          </div>
          <div>
            <button id="btnJana" class="btn-primary mt-6 md:mt-0" onclick="generateOverallAnalysis()">
              Jana Analisis
            </button>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- KPI CARDS (Hidden until Generate) -->
  <section class="container-max px-4 pt-4 pb-6 hidden" data-tab-panel="keseluruhan" data-reveal>
    <div class="grid grid-cols-1 md:grid-cols-3 gap-5">
      <div class="rounded-2xl border border-blue-100 bg-blue-50 shadow-sm h-[5.5rem]">
        <div class="h-full px-6 flex items-center justify-between">
          <div>
            <p class="text-blue-800/80 text-sm">Gred Purata</p>
            <div id="kpiGPS" class="text-blue-800 text-3xl font-extrabold leading-tight">--</div>
          </div>
          <div class="text-2xl">üìä</div>
        </div>
      </div>
      <div class="rounded-2xl border border-green-100 bg-green-50 shadow-sm h-[5.5rem]">
        <div class="h-full px-6 flex items-center justify-between">
          <div>
            <p class="text-green-800/90 text-sm">Layak Sijil</p>
            <div id="kpiLayak" class="text-green-800 text-3xl font-extrabold leading-tight">--</div>
          </div>
          <div class="text-2xl">üéì</div>
        </div>
      </div>
      <div class="rounded-2xl border border-purple-100 bg-purple-50 shadow-sm h-[5.5rem]">
        <div class="h-full px-6 flex items-center justify-between">
          <div>
            <p class="text-purple-800/90 text-sm">Jumlah Murid</p>
            <div id="kpiMurid" class="text-purple-800 text-3xl font-extrabold leading-tight">--</div>
          </div>
          <div class="text-2xl">üë•</div>
        </div>
      </div>
    </div>
  </section>

  <!-- KAD: MURID TERBAIK (Hidden until Generate) -->
  <section class="container-max px-4 pb-6 hidden" data-tab-panel="keseluruhan" data-reveal>
    <div class="bg-white rounded-2xl shadow-sm border border-gray-100">
      <div class="px-5 sm:px-6 py-3 flex items-center gap-2">
        <span class="text-2xl">üèÜ</span>
        <h2 class="text-xl font-semibold text-gray-800">Murid Terbaik</h2>
      </div>

      <div class="overflow-x-auto">
        <table class="w-full text-[14px] border-collapse">
          <thead>
            <tr class="bg-gradient-to-r from-purple-500 to-indigo-500 text-white">
              <th class="px-2.5 py-2 text-center">Ked.</th>
              <th class="px-2.5 py-2 text-left">Nama</th>
              <th class="px-2.5 py-2 text-center">Kelas</th>
              <th class="px-2.5 py-2 text-center">GP Murid</th>
              <th class="px-2.5 py-2 text-center">A+</th>
              <th class="px-2.5 py-2 text-center">A</th>
              <th class="px-2.5 py-2 text-center">A-</th>
              <th class="px-2.5 py-2 text-center">B+</th>
              <th class="px-2.5 py-2 text-center">B</th>
              <th class="px-2.5 py-2 text-center">C+</th>
              <th class="px-2.5 py-2 text-center">C</th>
            </tr>
          </thead>
          <tbody id="muridTerbaikBody" class="divide-y"></tbody>
        </table>
      </div>
      <div class="h-3"></div>
    </div>
  </section>

  <!-- KAD: CARTA TABURAN GRED (Hidden until Generate) -->
  <section class="container-max px-4 pb-6 hidden" data-tab-panel="keseluruhan" data-reveal>
    <div class="bg-white rounded-2xl shadow-sm border border-gray-100">
      <div class="px-5 sm:px-6 py-3 flex items-center gap-2">
        <span class="text-2xl">üìà</span>
        <h2 class="text-xl font-semibold text-gray-800">Carta Taburan Gred</h2>
      </div>
      <div class="px-3 pb-4">
        <div class="chart-fixed">
          <canvas id="gradeChart"></canvas>
        </div>
      </div>
    </div>
  </section>

  <!-- KAD: JADUAL ANALISIS MATA PELAJARAN (Hidden until Generate) -->
  <section class="container-max px-4 pb-10 hidden" data-tab-panel="keseluruhan" data-reveal>
    <div class="bg-white rounded-2xl shadow-sm border border-gray-100">
      <div class="px-5 sm:px-6 py-3 flex items-center gap-2">
        <span class="text-2xl">üìö</span>
        <h2 class="text-xl font-semibold text-gray-800">Jadual Analisis Mata Pelajaran</h2>
      </div>

      <div class="overflow-x-auto">
        <table class="w-full text-[14px] border-collapse whitespace-nowrap min-w-[1100px]">
          <thead>
            <tr class="bg-green-600 text-white">
              <th class="px-2.5 py-2 text-center">Mata Pelajaran</th>
              <th class="px-2.5 py-2 text-center">Hadir</th>
              <th class="px-2.5 py-2 text-center">TH</th>
              <th class="px-2.5 py-2 text-center">A+</th>
              <th class="px-2.5 py-2 text-center">A</th>
              <th class="px-2.5 py-2 text-center">A-</th>
              <th class="px-2.5 py-2 text-center">B+</th>
              <th class="px-2.5 py-2 text-center">B</th>
              <th class="px-2.5 py-2 text-center">C+</th>
              <th class="px-2.5 py-2 text-center">C</th>
              <th class="px-2.5 py-2 text-center">D</th>
              <th class="px-2.5 py-2 text-center">E</th>
              <th class="px-2.5 py-2 text-center">G</th>
              <th class="px-2.5 py-2 text-center">%Lulus</th>
              <th class="px-2.5 py-2 text-center">%Gagal</th>
              <th class="px-2.5 py-2 text-center">
                GPMP
                <span id="gpmpSortBtn" class="sort-btn align-middle">
                  <svg class="up" viewBox="0 0 24 24"><path d="M7 14l5-5 5 5z"/></svg>
                  <svg class="down" viewBox="0 0 24 24"><path d="M7 10l5 5 5-5z"/></svg>
                </span>
              </th>
            </tr>
          </thead>
          <tbody id="analisisSubjekBody" class="divide-y"></tbody>
        </table>
      </div>

      <div class="h-3"></div>
    </div>
  </section>

  <!-- FOOTER: bar kecil + tulisan kecil -->
  <footer class="mt-10">
    <!-- Bar nipis -->
    <div class="h-0.5 bg-gradient-to-r from-blue-500 via-indigo-500 to-purple-500 opacity-70"></div>
    <!-- Teks kecil -->
    <div class="text-center text-[11px] sm:text-xs text-gray-500 py-3">
      ¬© 2025 <span class="font-medium">XCode Mr LePaK</span> - Analisis PPSA vs PraSPM
    </div>
  </footer>

  <script>
    /* ========= CSV & UTIL ========= */
    const csvUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRck15kwRkf75NPm1IouErXU_CDgHjMEGw1nm0FNCu1XAkIb3EF0XV36Mq66wui_0imgyC9OKzoVQl9/pub?gid=22937657&single=true&output=csv";
    const gradeValueMapping = { "A+":0,"A":1,"A-":2,"B+":3,"B":4,"C+":5,"C":6,"D":7,"E":8,"G":9 };
    const chartGradeLabels = ["A+","A","A-","B+","B","C+","C","D","E","G"];
    const topGradeLabels = ["A+","A","A-","B+","B","C+","C"];

    // Peta nama subjek
    const subjectNameMap = {
      "BM":"BAHASA MELAYU","BI":"BAHASA INGGERIS","M":"MATEMATIK","SN":"SAINS",
      "MT":"MATEMATIK TAMBAHAN","SEJ":"SEJARAH","PAI":"PENDIDIKAN ISLAM","PM":"PENDIDIKAN MORAL",
      "PSV":"PENDIDIKAN SENI VISUAL","PJK":"PENDIDIKAN JASMANI DAN KESIHATAN","BIO":"BIOLOGI",
      "KIM":"KIMIA","FIZ":"FIZIK","SS":"SAINS SUKAN","SK":"SAINS KOMPUTER","SRT":"SAINS RUMAH TANGGA",
      "PER":"PERTANIAN","PP":"PERNIAGAAN","PA":"PRINSIP PERAKAUNAN","TAS":"TASAWWUR ISLAM","PAIM":"PENDIDIKAN ISLAM MPAK",
      "GEO":"GEOGRAFI","BT":"BAHASA TAMIL","KT":"KESUSASTERAAN TAMIL","RC":"REKA CIPTA","SPER":"SAINS PERTANIAN"
    };

    // Kumpulan Bidang ‚Üí kod subjek
    const subjectGroupMap = {
      "Bahasa": ["BM","BI","BT","KT"],
      "Kemanusiaan": ["PAI","PM","SEJ","GEO","PSV","PJK","PAIM","TAS"],
      "Sains & Matematik": ["M","SN","MT","FIZ","BIO","KIM"],
      "Teknik & Vokasional": ["SK","SRT","PER","PP","PA","SS","RC","SPER"]
    };
    function filterSubjectsByBidang(subjects, bidang){
      if(!bidang || bidang==="Semua Bidang") return subjects;
      const allowed = subjectGroupMap[bidang] || [];
      return subjects.filter(s => allowed.includes(s));
    }

    let headerMap = {}, subjectColumns = [], cachedData = null, gradeChartInstance = null;

    // Jadual subjek (sort 3-laras)
    let subjectStatsCurrent = [], subjectStatsOriginal = [], gpmpSortState = "none";

    function cariKolum(keyword){
      const k = keyword.toLowerCase();
      return Object.values(headerMap).find(h => (h||"").toLowerCase().includes(k));
    }
    function cariKolumGredSubjek(kod){
      const upper = kod.toUpperCase();
      return Object.values(headerMap).find(h => {
        const H = (h||"").toUpperCase();
        return H.startsWith(upper + " ") && /\b(G|GRED|GRADE)\b/.test(H);
      });
    }
    function parseCSV(csv){
      const lines = csv.trim().split(/\r?\n/);
      const lineSubjek = (lines[1]||"").split(',').map(s=>s.trim());
      const lineJenis  = (lines[2]||"").split(',').map(s=>s.trim());
      let currentSubjek = "";
      const headers = lineSubjek.map((subjek,i)=>{
        if(subjek) currentSubjek = subjek;
        return lineJenis[i] ? `${currentSubjek} ${lineJenis[i]}`.trim() : currentSubjek;
      });
      headerMap = {}; headers.forEach(h => headerMap[(h||"").toLowerCase()] = h);
      subjectColumns = headers.filter(h => /\b(G|GRED|GRADE)\b/i.test(h||""));
      const dataRows = lines.slice(3).map(row => {
        const vals = row.split(','); const obj = {};
        headers.forEach((h, i) => obj[h] = (vals[i]||"").trim()); return obj;
      });
      return dataRows;
    }

    function autoIsiDropdownKelas(data){
      const kelasHeader = cariKolum("kelas");
      if(!kelasHeader) return;
      const kelasSet = new Set(
        data.map(r => (r[kelasHeader] || "").trim())
            .filter(k => k && k.toUpperCase() !== "SEMUA KELAS" && k !== "1")
      );
      const sel = document.getElementById("kelasFilter");
      sel.innerHTML = "";
      const optDefault = document.createElement("option");
      optDefault.value = ""; optDefault.textContent = "Pilih Kelas"; sel.appendChild(optDefault);
      const optAll = document.createElement("option");
      optAll.value = "SEMUA KELAS"; optAll.textContent = "SEMUA KELAS"; sel.appendChild(optAll);
      [...kelasSet].sort((a,b)=>a.localeCompare(b,'ms',{numeric:true})).forEach(k=>{
        const o=document.createElement("option"); o.value=k; o.textContent=k; sel.appendChild(o);
      });
    }

    // Inisialisasi
    document.addEventListener('DOMContentLoaded', async ()=>{
      try{
        const res = await fetch(csvUrl);
        const csv = await res.text();
        cachedData = parseCSV(csv);
        autoIsiDropdownKelas(cachedData);

        // Header KPI (keseluruhan sekolah)
        kiraHeaderKPI(cachedData);
      }catch(e){ console.error(e); }

      // Buka tab keseluruhan, tapi kekalkan komponen hasil sebagai hidden
      showTab('keseluruhan');

      // Auto refresh bila bidang/kelas berubah (jika hasil sudah dipaparkan)
      document.getElementById('bidangFilter')?.addEventListener('change', ()=>{
        const revealed = Array.from(document.querySelectorAll('[data-tab-panel="keseluruhan"][data-reveal]'))
                          .some(el => !el.classList.contains('hidden'));
        if(revealed){ generateOverallAnalysis(); }
      });
      document.getElementById('kelasFilter')?.addEventListener('change', ()=>{
        const revealed = Array.from(document.querySelectorAll('[data-tab-panel="keseluruhan"][data-reveal]'))
                          .some(el => !el.classList.contains('hidden'));
        if(revealed){ generateOverallAnalysis(); }
      });
    });

    function kiraHeaderKPI(data){
      const gpsElHeader = document.getElementById('gpsValue');
      const sijilElHeader = document.getElementById('layakSijilValue');

      let jumlahNilai = 0, bilGred = 0, jumlahMurid = 0, layak = 0;
      const bmCol  = cariKolumGredSubjek("BM");
      const sejCol = cariKolumGredSubjek("SEJ");

      data.forEach(row=>{
        let adaGred = false;
        subjectColumns.forEach(col=>{
          const g = (row[col]||"").toUpperCase();
          if(gradeValueMapping.hasOwnProperty(g)){ jumlahNilai += gradeValueMapping[g]; bilGred++; adaGred=true; }
        });
        if(adaGred){
          jumlahMurid++;
          const bm=(bmCol?row[bmCol]:"").toUpperCase();
          const sej=(sejCol?row[sejCol]:"").toUpperCase();
          if(bm && sej && bm!=="G" && sej!=="G") layak++;
        }
      });
      const gps = bilGred ? (jumlahNilai/bilGred).toFixed(2) : "-";
      const peratusLayak = jumlahMurid ? ((layak/jumlahMurid)*100).toFixed(1)+"%" : "-";
      gpsElHeader.textContent = gps;
      sijilElHeader.textContent = peratusLayak;
    }

    /* ========= CARTA ========= */
    function renderGradeChart(data, bidang){
      let subjects = [...new Set(subjectColumns.map(c => c.split(" ")[0]))]
        .filter(s => s.toUpperCase() !== "GRED" && s !== "G");

      subjects = filterSubjectsByBidang(subjects, bidang);

      const countsPerSubject = {};
      subjects.forEach(sub => countsPerSubject[sub] = Object.fromEntries(chartGradeLabels.map(g=>[g,0])));

      data.forEach(row=>{
        subjectColumns.forEach(col=>{
          const gred=(row[col]||"").trim().toUpperCase();
          const sub=col.split(" ")[0];
          if(chartGradeLabels.includes(gred) && subjects.includes(sub)){
            countsPerSubject[sub][gred]++;
          }
        });
      });

      subjects = subjects.sort((a,b)=>a.localeCompare(b,'ms',{numeric:true}));

      const gradeColors = {
        "A+":"#16a34a","A":"#22c55e","A-":"#86efac",
        "B+":"#eab308","B":"#facc15",
        "C+":"#fb923c","C":"#f97316",
        "D":"#f87171","E":"#ef4444","G":"#991b1b"
      };

      const datasets = chartGradeLabels.map(g=>({
        label:g,
        data:subjects.map(s=>countsPerSubject[s][g]),
        backgroundColor:gradeColors[g],
        stack:"stack0",
        borderWidth:0
      }));

      const ctx = document.getElementById('gradeChart').getContext('2d');
      if(gradeChartInstance) gradeChartInstance.destroy();
      gradeChartInstance = new Chart(ctx,{
        type:'bar',
        data:{labels:subjects, datasets},
        options:{
          responsive:true,
          maintainAspectRatio:false,
          plugins:{ legend:{position:'top', labels:{usePointStyle:true, boxWidth:12, padding:12}} },
          scales:{ x:{stacked:true,ticks:{maxRotation:0,minRotation:0}}, y:{stacked:true,beginAtZero:true} }
        }
      });
    }

    /* ========= ANALISIS SUBJEK ========= */
    function computeSubjectStats(data, bidang){
      let subjects = [...new Set(subjectColumns.map(c=>c.split(" ")[0]))]
        .filter(s=>s.toUpperCase()!=="GRED" && s!=="G");

      subjects = filterSubjectsByBidang(subjects, bidang);

      const stats = subjects.map(sub=>{
        let counts = Object.fromEntries(chartGradeLabels.map(g=>[g,0]));
        let hadir = 0, th = 0, totalNilai = 0;

        data.forEach(row=>{
          const col = subjectColumns.find(c => c.startsWith(sub+" "));
          const g = (row[col]||"").toUpperCase();
          if(gradeValueMapping.hasOwnProperty(g)){
            counts[g]++; hadir++; totalNilai += gradeValueMapping[g];
          }else if(g==="TH"){ th++; }
        });

        const lulus = hadir - (counts["G"]||0);
        const gagal = (counts["G"]||0);
        const peratusLulus = hadir ? ((lulus/hadir)*100).toFixed(1) : "0.0";
        const peratusGagal = hadir ? ((gagal/hadir)*100).toFixed(1) : "0.0";
        const gpmp = hadir ? (totalNilai/hadir).toFixed(2) : "--";

        return { sub, counts, hadir, th, peratusLulus, peratusGagal, gpmp };
      });

      return stats;
    }

    function renderSubjectTable(){
      const body = document.getElementById("analisisSubjekBody");
      body.innerHTML = "";

      let rows = [...subjectStatsCurrent];
      if(gpmpSortState==="asc"){
        rows.sort((a,b)=>(parseFloat(a.gpmp)||99) - (parseFloat(b.gpmp)||99));
      }else if(gpmpSortState==="desc"){
        rows.sort((a,b)=>(parseFloat(b.gpmp)||-1) - (parseFloat(a.gpmp)||-1));
      }else{
        rows = [...subjectStatsOriginal]; // Asal
      }

      rows.forEach(s=>{
        const label = subjectNameMap[s.sub] ? `[${s.sub}] - ${subjectNameMap[s.sub]}` : s.sub;
        body.innerHTML += `
          <tr class="text-gray-800">
            <td class="px-2.5 py-2 text-left font-medium">${label}</td>
            <td class="px-2.5 py-2 text-center text-blue-600">${s.hadir}</td>
            <td class="px-2.5 py-2 text-center">${s.th}</td>
            ${["A+","A","A-","B+","B","C+","C","D","E","G"].map(g=>{
              const cls=(g==="A+"||g==="A"||g==="A-")?"bg-green-50":(g==="B+"||g==="B")?"bg-yellow-50":"bg-red-50";
              return `<td class="px-2.5 py-2 text-center ${cls}">${s.counts[g]||0}</td>`;
            }).join("")}
            <td class="px-2.5 py-2 text-center text-green-600 font-medium">${s.peratusLulus}%</td>
            <td class="px-2.5 py-2 text-center text-red-600 font-medium">${s.peratusGagal}%</td>
            <td class="px-2.5 py-2 text-center text-purple-600 font-bold">${s.gpmp}</td>
          </tr>`;
      });
    }

    // Butang GPMP 3-laras
    document.addEventListener('click',(e)=>{
      if(e.target.closest('#gpmpSortBtn')){
        const btn = document.getElementById('gpmpSortBtn');
        if(gpmpSortState==="none"){gpmpSortState="asc";btn.classList.remove('desc');btn.classList.add('asc');}
        else if(gpmpSortState==="asc"){gpmpSortState="desc";btn.classList.remove('asc');btn.classList.add('desc');}
        else {gpmpSortState="none";btn.classList.remove('asc','desc');}
        renderSubjectTable();
      }
    });

    /* ========= JANAKAN DATA BILA BUTANG DITEKAN ========= */
    async function generateOverallAnalysis(){
      const btn = document.getElementById('btnJana');
      const kpiGPS = document.getElementById('kpiGPS');
      const kpiLayak = document.getElementById('kpiLayak');
      const kpiMurid = document.getElementById('kpiMurid');
      const topBody = document.getElementById('muridTerbaikBody');

      const oldText = btn.textContent;
      btn.textContent = 'Menjana...';
      btn.disabled = true; btn.style.opacity = 0.85;

      try{
        if(!cachedData){
          const res = await fetch(csvUrl);
          const csv = await res.text();
          cachedData = parseCSV(csv);
        }

        const kelasSel  = document.getElementById('kelasFilter').value;
        const bidangSel = document.getElementById('bidangFilter').value;
        const kelasHeader = cariKolum("kelas");

        let data = cachedData;
        if(kelasSel && kelasSel !== "SEMUA KELAS"){
          data = cachedData.filter(r => (r[kelasHeader]||"") === kelasSel);
        }

        // KPI
        let jumlahNilai = 0, bilGred = 0, jumlahMurid = 0, layak = 0;
        const bmCol  = cariKolumGredSubjek("BM");
        const sejCol = cariKolumGredSubjek("SEJ");

        data.forEach(row=>{
          let adaGred = false;
          subjectColumns.forEach(col=>{
            const g = (row[col]||"").toUpperCase();
            if(gradeValueMapping.hasOwnProperty(g)){ jumlahNilai += gradeValueMapping[g]; bilGred++; adaGred=true; }
          });
          if(adaGred){
            jumlahMurid++;
            const bm  = (bmCol ? row[bmCol]  : "").toUpperCase();
            const sej = (sejCol? row[sejCol] : "").toUpperCase();
            if(bm && sej && bm!=="G" && sej!=="G") layak++;
          }
        });

        const gps = bilGred ? (jumlahNilai / bilGred).toFixed(2) : "--";
        const peratusLayak = jumlahMurid ? ((layak / jumlahMurid) * 100).toFixed(1) + "%" : "--";
        kpiGPS.textContent = gps;
        kpiLayak.textContent = peratusLayak;
        kpiMurid.textContent = jumlahMurid ? String(jumlahMurid) : "--";

        // Murid Terbaik
        const namaHeader  = cariKolum("nama");
        let muridList = [];
        data.forEach(row=>{
          let gredList = [];
          subjectColumns.forEach(c=>{
            const g = (row[c]||"").toUpperCase();
            if(gradeValueMapping.hasOwnProperty(g)){ gredList.push(g); }
          });
          if(gredList.length){
            const gp = (gredList.reduce((a,g)=>a+gradeValueMapping[g],0)/gredList.length).toFixed(2);
            const counts = topGradeLabels.reduce((acc,g)=>{acc[g]=gredList.filter(x=>x===g).length;return acc;},{});
            muridList.push({nama:row[namaHeader]||"-", kelas:row[kelasHeader]||"-", gp:parseFloat(gp), counts});
          }
        });
        muridList.sort((a,b)=>a.gp-b.gp);
        const topN = parseInt(document.getElementById('topStudentsCount').value||"5",10);
        const top = muridList.slice(0, topN);

        topBody.innerHTML = "";
        top.forEach((m,i)=>{
          topBody.innerHTML += `
            <tr class="text-gray-800">
              <td class="px-2.5 py-2 text-center">${i+1}</td>
              <td class="px-2.5 py-2 text-left">${m.nama}</td>
              <td class="px-2.5 py-2 text-center">${m.kelas}</td>
              <td class="px-2.5 py-2 text-center text-blue-600 font-semibold">${m.gp.toFixed(2)}</td>
              ${topGradeLabels.map(g=>`<td class="px-2.5 py-2 text-center">${m.counts[g]||0}</td>`).join("")}
            </tr>`;
        });

        // Carta & Jadual (ikut Bidang)
        renderGradeChart(data, bidangSel);
        subjectStatsCurrent  = computeSubjectStats(data, bidangSel);
        subjectStatsOriginal = [...subjectStatsCurrent];
        gpmpSortState = "none";
        document.getElementById('gpmpSortBtn').classList.remove('asc','desc');
        renderSubjectTable();

        // Tunjuk semua kad selepas jana
        document.querySelectorAll('[data-tab-panel="keseluruhan"][data-reveal]')
          .forEach(el => el.classList.remove('hidden'));

      }catch(e){
        console.error(e);
      }finally{
        btn.textContent = oldText;
        btn.disabled = false; btn.style.opacity = 1;
      }
    }

    /* ========= TAB ========= */
    function switchTab(which){
      const ids=['keseluruhan','matapelajaran','layaksijil','combatzone','individu'];
      ids.forEach(id=>{
        const el=document.getElementById('tab-'+id);
        if(!el) return;
        el.classList.remove('tab-active'); el.classList.add('bg-white');
      });
      const active=document.getElementById('tab-'+which);
      if(active){ active.classList.remove('bg-white'); active.classList.add('tab-active'); }
      if(typeof window.showTab==='function'){ window.showTab(which); }
    }

    // Pastikan komponen hasil kekal hidden sehingga Jana
    function showTab(which){
      document.querySelectorAll('[data-tab-panel]').forEach(p => p.classList.add('hidden'));
      const panels = document.querySelectorAll(`[data-tab-panel="${which}"]`);
      panels.forEach(p => p.classList.remove('hidden'));
      document.querySelectorAll(`[data-tab-panel="${which}"][data-reveal]`)
        .forEach(p => p.classList.add('hidden'));
    }

    document.addEventListener('DOMContentLoaded', () => showTab('keseluruhan'));
  </script>

</body>
</html>

<!DOCTYPE html>
<html lang="ms">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>PPSA â€” Analisis Keseluruhan (Sticky)</title>

  <!-- Tailwind + Chart.js -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root{ --donut-h:190px; --bar-h:300px; }
    .card{ background:#fff; border-radius:18px; box-shadow:0 1px 0 rgba(17,24,39,.06); }
    .kpi-num{ font-size:2.2rem; font-weight:800; line-height:1; }
    /* --- sticky panel --- */
    #stickyPanel{ position:sticky; top:0; z-index:50; }
    #stickyPanel.is-stuck{ box-shadow:0 6px 18px rgba(15,23,42,.10); }
    #donutLulus,#donutHadir{ height:var(--donut-h) !important; }
    #barGred{ height:var(--bar-h) !important; }
  </style>
</head>
<body class="bg-gray-50 text-gray-800">

  <!-- Header ringkas -->
  <header class="bg-white border-b">
    <div class="max-w-7xl mx-auto flex items-center gap-3 p-4">
      <img src="https://upload.wikimedia.org/wikipedia/ms/b/ba/Sekolah_Menengah_Kebangsaan_Dato%27_Kamaruddin.jpg"
           alt="Logo" class="w-10 h-10 rounded-full border">
      <div>
        <h1 class="text-xl font-extrabold leading-tight">PPSA</h1>
        <p class="text-sm text-gray-600 -mt-0.5">Sistem Analisis Prestasi Akademik<br>
          <a class="text-blue-600 font-medium" href="#" onclick="return false;">SMK Dato' Kamaruddin</a>
        </p>
      </div>
      <div class="ml-auto text-xs text-gray-500">Data Percubaan SPM 2025</div>
    </div>
  </header>

  <main class="max-w-7xl mx-auto p-4 sm:p-6 space-y-6">

    <!-- === Kad 1: Analisis Keseluruhan (STICKY) === -->
    <section id="stickyPanel" class="card px-5 py-6 transition-all">
      <h2 class="text-lg sm:text-xl font-extrabold flex items-center gap-2 mb-5">
        <span class="text-green-600">ðŸ“Š</span> Analisis Keseluruhan
      </h2>

      <div class="grid lg:grid-cols-4 gap-4 items-end">
        <!-- Kelas -->
        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-2">Kelas</label>
          <select id="kelasSelect" class="w-full rounded-xl border px-4 py-3 font-semibold bg-white">
            <option value="">Pilih Kelas</option>
          </select>
        </div>

        <!-- Subjek (ganti Bidang) -->
        <div class="lg:col-span-2">
          <label class="block text-sm font-semibold text-gray-700 mb-2">Subjek</label>
          <select id="subjekSelect" class="w-full rounded-xl border px-4 py-3 font-semibold bg-white"></select>
        </div>

        <!-- Murid Terbaik (kekal untuk kegunaan akan datang) -->
        <div class="hidden">
          <label class="block text-sm font-semibold text-gray-700 mb-2">Murid Terbaik</label>
          <select id="topStudentsCount" class="w-full rounded-xl border px-4 py-3 font-semibold bg-white">
            <option value="5">Top 5</option><option value="10">Top 10</option><option value="20">Top 20</option>
          </select>
        </div>

        <!-- Jana -->
        <div class="lg:col-span-1 flex lg:justify-end">
          <button id="btnJana" class="w-full lg:w-auto bg-[#335EF7] hover:brightness-95 text-white font-bold rounded-2xl px-6 py-3">
            Jana Analisis
          </button>
        </div>
      </div>
    </section>

    <!-- === Baris KPI (imej 2) === -->
    <section class="grid md:grid-cols-2 gap-6">
      <!-- Keputusan -->
      <div class="card p-6">
        <h3 class="text-2xl font-extrabold mb-4">Keputusan Matapelajaran</h3>
        <hr class="border-gray-200 mb-6">
        <div class="grid grid-cols-3 gap-4">
          <div><div class="text-gray-500 font-medium">Jumlah Lulus</div><div id="kpiLulus" class="kpi-num">--</div></div>
          <div><div class="text-gray-500 font-medium">Jumlah Gagal</div><div id="kpiGagal" class="kpi-num">--</div></div>
          <div><div class="text-gray-500 font-medium">% Lulus</div><div id="kpiPeratus" class="kpi-num">--%</div></div>
        </div>
        <div class="mt-6 flex items-center gap-3">
          <div class="bg-purple-50 text-purple-900 font-extrabold rounded-lg px-4 py-3 text-sm tracking-wide">GRED PURATA</div>
          <div id="kpiGP" class="ml-auto text-4xl font-extrabold">--</div>
        </div>
      </div>

      <!-- Bilangan Pelajar -->
      <div class="card p-6">
        <h3 class="text-2xl font-extrabold mb-4">Bilangan Pelajar</h3>
        <hr class="border-gray-200 mb-6">
        <div class="grid grid-cols-3 gap-4">
          <div><div class="text-gray-500 font-medium">Jumlah Calon</div><div id="kpiCalon" class="kpi-num">--</div></div>
          <div><div class="text-gray-500 font-medium">Jumlah Hadir</div><div id="kpiHadir" class="kpi-num">--</div></div>
          <div><div class="text-gray-500 font-medium">% Hadir</div><div id="kpiPHadir" class="kpi-num">--%</div></div>
        </div>
      </div>
    </section>

    <!-- === Donut (imej 3 atas) === -->
    <section class="grid md:grid-cols-2 gap-6">
      <div class="card p-6">
        <h4 class="text-xl font-extrabold mb-3">Lulus vs Gagal</h4>
        <canvas id="donutLulus"></canvas>
        <p class="text-xs text-gray-500 text-center mt-2">(% dikira daripada hadir)</p>
      </div>
      <div class="card p-6">
        <h4 class="text-xl font-extrabold mb-3">Kehadiran</h4>
        <canvas id="donutHadir"></canvas>
        <p class="text-xs text-gray-500 text-center mt-2">(% dikira daripada calon)</p>
      </div>
    </section>

    <!-- === Bar (imej 3 bawah) === -->
    <section class="card p-6">
      <h4 class="text-xl font-extrabold text-purple-700 text-center mb-3">Taburan Gred</h4>
      <canvas id="barGred"></canvas>
    </section>

  </main>

  <script>
    /* ============== CSV & Pemetaan ============== */
    const csvUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTYrHZLkbHUM-5jja039uj6kW8gImj4V3pdg253c8C8wZfjVPusU2XT_0M9qjA6kq-X1wiFI4z2FIDq/pub?gid=22937657&single=true&output=csv";

    const GRADE_VAL = {"A+":0,"A":1,"A-":2,"B+":3,"B":4,"C+":5,"C":6,"D":7,"E":8,"G":9};
    const GRADE_LABELS = ["A+","A","A-","B+","B","C+","C","D","E","G","TH"];
    const SUBJECT_FULL = {
      "BM":"BAHASA MELAYU","BI":"BAHASA INGGERIS","BT":"BAHASA TAMIL","KT":"KESUSASTERAAN TAMIL",
      "M":"MATEMATIK","SN":"SAINS","MT":"MATEMATIK TAMBAHAN",
      "PAI":"PENDIDIKAN ISLAM","TAS":"TASAWWUR ISLAM","PAIM":"PENDIDIKAN ISLAM MPAK",
      "PM":"PENDIDIKAN MORAL","SEJ":"SEJARAH","GEO":"GEOGRAFI","PSV":"PENDIDIKAN SENI VISUAL",
      "PJK":"PENDIDIKAN JASMANI DAN KESIHATAN",
      "BIO":"BIOLOGI","KIM":"KIMIA","FIZ":"FIZIK",
      "SS":"SAINS SUKAN","SK":"SAINS KOMPUTER","SRT":"SAINS RUMAH TANGGA",
      "PER":"PERTANIAN","SPER":"SAINS PERTANIAN","PP":"PERNIAGAAN","PA":"PRINSIP PERAKAUNAN","RC":"REKA CIPTA"
    };

    let data=[], headerMap={}, subjectCols=[];
    let donut1=null, donut2=null, bar1=null;

    function parseCSV(csv){
      const lines = csv.trim().split('\n');
      const S1 = lines[1].split(',').map(x=>x.trim());
      const S2 = lines[2].split(',').map(x=>x.trim());
      let cur="";
      const headers = S1.map((v,i)=>{ if(v) cur=v; return S2[i] ? `${cur} ${S2[i]}`.trim() : cur; });
      headers.forEach(h=> headerMap[h.toLowerCase()]=h);
      subjectCols = headers.filter(h=>/\b(G|GRED|GRADE)\b/i.test(h));
      return lines.slice(3).map(row=>{
        const v=row.split(','); const o={}; headers.forEach((h,i)=>o[h]=(v[i]??'').trim()); return o;
      });
    }
    const H = k => Object.values(headerMap).find(h=>h.toLowerCase().includes(k)) || "";

    function populateDropdowns(){
      const kelasH = H("kelas");
      const kelasSel = document.getElementById("kelasSelect");
      const kelasSet = new Set(data.map(r=>r[kelasH]?.trim()).filter(Boolean));
      [...kelasSet].sort((a,b)=>a.localeCompare(b,'ms',{numeric:true}))
        .forEach(k=>{ const o=document.createElement('option');o.value=k;o.textContent=k;kelasSel.appendChild(o); });

      const subSel = document.getElementById("subjekSelect");
      const codes=[...new Set(subjectCols.map(c=>c.split(" ")[0]))]
        .filter(s=>s.toUpperCase()!=="GRED" && s!=="G")
        .sort((a,b)=>a.localeCompare(b,'ms',{numeric:true}));
      const all=document.createElement('option'); all.value="ALL"; all.textContent="SEMUA SUBJEK"; subSel.appendChild(all);
      codes.forEach(code=>{ const o=document.createElement('option'); o.value=code; o.textContent=SUBJECT_FULL[code]||code; subSel.appendChild(o); });
      if(subSel.options.length>1) subSel.selectedIndex=1; // pilih subjek pertama
    }

    function compute(){
      const kelasH = H("kelas");
      const kelas  = document.getElementById("kelasSelect").value;
      const subjek = document.getElementById("subjekSelect").value;
      const rows = (!kelas ? data : data.filter(r=>r[kelasH]===kelas));

      const totals = {"A+":0,"A":0,"A-":0,"B+":0,"B":0,"C+":0,"C":0,"D":0,"E":0,"G":0,"TH":0};
      let calon=0, hadir=0, lulus=0, gagal=0, sumGP=0;

      if(subjek==="ALL"){
        calon = rows.length;
        rows.forEach(r=>{
          // kira ikut purata gred bagi pelajar; lulus jika tiada 'G' dalam mana-mana subjek
          const greds = subjectCols.map(c=>(r[c]||"").toUpperCase()).filter(Boolean);
          if(greds.some(g=>g==="TH")) { /* TH tidak dikira hadir */ }
          const valid = greds.filter(g=>Object.hasOwn(GRADE_VAL,g));
          if(valid.length){
            hadir++;
            sumGP += valid.map(g=>GRADE_VAL[g]).reduce((a,b)=>a+b,0)/valid.length;
            if(greds.includes("G")) gagal++; else lulus++;
          }
          valid.forEach(g=> totals[g]++ );
          if(greds.includes("TH")) totals["TH"]++;
        });
      } else {
        const col = subjectCols.find(c=>c.startsWith(subjek+" "));
        if(!col) return null;
        calon = rows.length;
        rows.forEach(r=>{
          const g=(r[col]||"").toUpperCase();
          if(g==="TH"){ totals["TH"]++; return; }
          if(Object.hasOwn(GRADE_VAL,g)){
            totals[g]++; hadir++; sumGP+=GRADE_VAL[g];
            if(g==="G") gagal++; else lulus++;
          }
        });
      }

      const gp = hadir ? (sumGP/hadir).toFixed(2) : "--";
      const pLulus = hadir ? ((lulus/hadir)*100).toFixed(2) : "0.00";
      const pHadir = calon ? ((hadir/calon)*100).toFixed(2) : "0.00";
      return {calon, hadir, lulus, gagal, gp, pLulus, pHadir, totals};
    }

    function renderKPI(s){
      kpiLulus.textContent=s.lulus;
      kpiGagal.textContent=s.gagal;
      kpiPeratus.textContent=`${s.pLulus}%`;
      kpiCalon.textContent=s.calon;
      kpiHadir.textContent=s.hadir;
      kpiPHadir.textContent=`${s.pHadir}%`;
      kpiGP.textContent=s.gp;
    }

    function renderDonuts(s){
      donut1 && donut1.destroy(); donut2 && donut2.destroy();
      donut1 = new Chart(donutLulus.getContext('2d'),{
        type:'doughnut',
        data:{labels:['LULUS','GAGAL'],datasets:[{data:[s.lulus,s.gagal]}]},
        options:{plugins:{legend:{position:'bottom'}},cutout:'58%', maintainAspectRatio:false}
      });
      donut2 = new Chart(donutHadir.getContext('2d'),{
        type:'doughnut',
        data:{labels:['HADIR','TH'],datasets:[{data:[s.hadir, s.calon - s.hadir]}]},
        options:{plugins:{legend:{position:'bottom'}},cutout:'58%', maintainAspectRatio:false}
      });
    }

    function renderBar(s){
      bar1 && bar1.destroy();
      const seq = GRADE_LABELS.map(k=>s.totals[k]||0);
      bar1 = new Chart(barGred.getContext('2d'),{
        type:'bar',
        data:{labels:GRADE_LABELS,datasets:[{label:'Bil.',data:seq}]} ,
        options:{plugins:{legend:{display:false}}, maintainAspectRatio:false, scales:{y:{beginAtZero:true, precision:0}}}
      });
    }

    function jana(){ const s=compute(); if(!s) return; renderKPI(s); renderDonuts(s); renderBar(s); }

    // --- sticky visual state (shadow apabila melekat) ---
    const panel = document.getElementById('stickyPanel');
    new IntersectionObserver(([e])=>{ panel.classList.toggle('is-stuck', e.intersectionRatio < 1); }, {threshold:[1]}).observe(panel);

    // MULA
    fetch(csvUrl).then(r=>r.text()).then(txt=>{
      data = parseCSV(txt);
      populateDropdowns();
      jana();
    });

    btnJana.addEventListener('click', jana);
    kelasSelect.addEventListener('change', jana);
    subjekSelect.addEventListener('change', jana);
  </script>
</body>
</html>

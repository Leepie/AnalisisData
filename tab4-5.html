<!DOCTYPE html>
<html lang="ms">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>XCode Analisis PPSA vs PraSPM</title>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <script>
  // Jadikan legend semua carta berbentuk bulat secara lalai
  if (window.Chart) {
    Chart.defaults.plugins.legend.labels.usePointStyle = true;
    Chart.defaults.plugins.legend.labels.pointStyle = 'circle';
    Chart.defaults.plugins.legend.labels.boxWidth  = 12; // pilihan
    Chart.defaults.plugins.legend.labels.boxHeight = 12; // pilihan
  }
</script>


  <style>
    /* Header */
    header{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    .pulse-dot{position:relative}
    .pulse-dot::after{content:"";position:absolute;inset:-6px;border-radius:9999px;border:2px solid rgba(34,197,94,.4);animation:pulse 1.6s cubic-bezier(.4,0,.2,1) infinite}
    @keyframes pulse{0%{transform:scale(.6);opacity:.9}70%{transform:scale(1.4);opacity:0}100%{transform:scale(1.4);opacity:0}}

    /* Tab menu cards */
    .analysis-tabs .card-hover{
      height:5.5rem;border:1px solid #e5e7eb;border-radius:14px;background:#fff;
      display:flex;align-items:center;justify-content:center;flex-direction:column;
      box-shadow:0 1px 2px rgba(16,24,40,.06);
      transition:transform .08s ease, box-shadow .15s ease;
    }
    .analysis-tabs .card-hover:hover{transform:translateY(-3px);box-shadow:0 10px 20px rgba(16,24,40,.12)}
    .analysis-tabs .tab-active{
      background:linear-gradient(135deg,#3b82f6 0%,#4f46e5 100%) !important;color:#fff !important;border-color:transparent !important;
      box-shadow:0 12px 24px rgba(79,70,229,.26);
    }
    .analysis-tabs .card-hover .text-lg{font-size:22px;line-height:1}
    .analysis-tabs .card-hover .text-sm{font-size:15px;font-weight:400}

    /* Kawalan borang/kad */
    body{background:#f8fafc;color:#111827;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    .sticky-card{position:sticky;top:0;z-index:40}
    .field-label{font-size:.95rem;color:#374151;font-weight:600}
    .select-like{
      width:100%;border:1px solid #e5e7eb;border-radius:0.75rem;
      padding:0.75rem 1rem;font-size:.95rem;background:#fff;
      box-shadow:0 1px 2px rgba(16,24,40,.04);
      outline:none;transition:border-color .15s,box-shadow .15s;
    }
    .select-like:focus{border-color:#3b82f6;box-shadow:0 0 0 3px rgba(59,130,246,.25)}
    .btn-primary{
      display:inline-flex;align-items:center;justify-content:center;width:100%;
      padding:.875rem 1rem;border-radius:.9rem;font-weight:700;color:#fff;
      background:#3b5bfd;box-shadow:0 1px 3px rgba(59,91,253,.25);
      transition:transform .06s,filter .15s,background .15s;
    }
    .btn-primary:hover{filter:brightness(1.05)}
    .btn-primary:active{transform:scale(.985)}
    .container-max{max-width:1200px;margin-left:auto;margin-right:auto}

    /* Carta tetap */
    .chart-fixed{height:320px}
    @media (max-width:1024px){.chart-fixed{height:300px}}
    @media (max-width:640px){.chart-fixed{height:260px}}
    #gradeChart{width:100% !important;height:100% !important;display:block}

    /* Butang sort (diguna semula) */
    .sort-btn{display:inline-flex;flex-direction:column;align-items:center;justify-content:center;margin-left:6px;cursor:pointer}
    .sort-btn svg{width:12px;height:12px;fill:#d1d5db}
    .sort-btn.asc .up{fill:#fff}
    .sort-btn.desc .down{fill:#fff}
  </style>
</head>
<body class="bg-gray-50 text-gray-800">

  <!-- =================== HEADER =================== -->
  <header class="bg-white shadow-sm border-b">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
      <div class="flex items-center justify-between">
        <div class="flex items-center space-x-4">
          <img src="https://upload.wikimedia.org/wikipedia/ms/b/ba/Sekolah_Menengah_Kebangsaan_Dato%27_Kamaruddin.jpg"
               alt="SMK Dato' Kamaruddin Logo" class="h-16 w-16 object-contain rounded-full border"/>
          <div>
            <h1 class="text-2xl font-bold text-gray-900">PraSPM</h1>
            <p class="text-sm text-gray-600">AEE6058</p>
            <p class="text-sm font-medium text-gray-800">SMK Dato` Kamaruddin</p>
            <div class="flex items-center space-x-2 mt-1">
              <div class="w-2 h-2 bg-green-500 rounded-full pulse-dot"></div>
              <span class="text-xs text-gray-600">Data PraSPM</span>
            </div>
          </div>
        </div>

        <div class="flex space-x-6">
          <div class="text-center">
            <div class="text-3xl font-bold text-blue-600" id="gpsValue">-</div>
            <div class="text-sm text-gray-600">Gred Purata Sekolah</div>
          </div>
          <div class="text-center">
            <div class="text-3xl font-bold text-green-600" id="layakSijilValue">-</div>
            <div class="text-sm text-gray-600">Peratus Layak Sijil</div>
          </div>
        </div>
      </div>
    </div>
  </header>

  <!-- =================== MENU TAB =================== -->
  <div class="analysis-tabs max-w-[1200px] mx-auto px-4 pt-6 pb-1">
    <div class="grid grid-cols-1 md:grid-cols-5 gap-4 mb-1">
      <button onclick="switchTab('keseluruhan')" id="tab-keseluruhan"
              class="tab-active card-hover p-4 rounded-lg text-center transition-all">
        <div class="text-lg mb-1">üìä</div>
        <div class="text-sm">Analisis Keseluruhan</div>
      </button>
      <button onclick="switchTab('matapelajaran')" id="tab-matapelajaran" class="bg-white card-hover p-4 rounded-lg text-center transition-all">
        <div class="text-lg mb-1">üìö</div>
        <div class="text-sm">Analisis Mata Pelajaran</div>
      </button>
      <button onclick="switchTab('layaksijil')" id="tab-layaksijil" class="bg-white card-hover p-4 rounded-lg text-center transition-all">
        <div class="text-lg mb-1">üéì</div>
        <div class="text-sm">Analisis Layak Sijil</div>
      </button>
      <button onclick="switchTab('combatzone')" id="tab-combatzone" class="bg-white card-hover p-4 rounded-lg text-center transition-all">
        <div class="text-lg mb-1">‚ö†Ô∏è</div>
        <div class="text-sm">Analisis Combat Zone</div>
      </button>
      <button onclick="switchTab('individu')" id="tab-individu" class="bg-white card-hover p-4 rounded-lg text-center transition-all">
        <div class="text-lg mb-1">üë§</div>
        <div class="text-sm">Analisis Individu</div>
      </button>
    </div>
  </div>

  <!-- =================== TAB 1: Analisis Keseluruhan (kekal) =================== -->
  <!-- (‚Ä¶semua kandungan Tab 1 kekal seperti versi sebelum ini, tidak diubah‚Ä¶) -->
  <!-- Sticky card -->
  <section data-tab-panel="keseluruhan" class="sticky-card bg-white/80 backdrop-blur border-b border-gray-100">
    <div class="container-max px-4 py-3">
      <div class="bg-white rounded-2xl shadow-sm border border-gray-100 px-4 sm:px-6 py-5">
        <h2 class="text-xl font-semibold text-gray-800 flex items-center gap-2 mb-5">
          <span>üìä</span> Analisis Keseluruhan
        </h2>

        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
          <div>
            <label for="kelasFilter" class="field-label">Kelas</label>
            <select id="kelasFilter" class="select-like mt-1">
              <option value="">Pilih Kelas</option>
            </select>
          </div>
          <div>
            <label for="bidangFilter" class="field-label">Bidang</label>
            <select id="bidangFilter" class="select-like mt-1">
              <option value="Semua Bidang">Semua Bidang</option>
              <option value="Bahasa">Bahasa</option>
              <option value="Kemanusiaan">Kemanusiaan</option>
              <option value="Sains & Matematik">Sains & Matematik</option>
              <option value="Teknik & Vokasional">Teknik & Vokasional</option>
            </select>
          </div>
          <div>
            <label for="topStudentsCount" class="field-label">Murid Terbaik</label>
            <select id="topStudentsCount" class="select-like mt-1">
              <option value="5">Top 5</option>
              <option value="10">Top 10</option>
              <option value="20">Top 20</option>
            </select>
          </div>
          <div>
            <button id="btnJana" class="btn-primary mt-6 md:mt-0" onclick="generateOverallAnalysis()">Jana Analisis</button>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- KPI, Murid Terbaik, Carta & Jadual Subjek -->
  <section class="container-max px-4 pt-4 pb-6 hidden" data-tab-panel="keseluruhan" data-reveal>
    <div class="grid grid-cols-1 md:grid-cols-3 gap-5">
      <div class="rounded-2xl border border-blue-100 bg-blue-50 shadow-sm h-[5.5rem]">
        <div class="h-full px-6 flex items-center justify-between">
          <div>
            <p class="text-blue-800/80 text-sm">Gred Purata</p>
            <div id="kpiGPS" class="text-blue-800 text-3xl font-extrabold leading-tight">--</div>
          </div>
          <div class="text-2xl">üìä</div>
        </div>
      </div>
      <div class="rounded-2xl border border-green-100 bg-green-50 shadow-sm h-[5.5rem]">
        <div class="h-full px-6 flex items-center justify-between">
          <div>
            <p class="text-green-800/90 text-sm">Layak Sijil</p>
            <div id="kpiLayak" class="text-green-800 text-3xl font-extrabold leading-tight">--</div>
          </div>
          <div class="text-2xl">üéì</div>
        </div>
      </div>
      <div class="rounded-2xl border border-purple-100 bg-purple-50 shadow-sm h-[5.5rem]">
        <div class="h-full px-6 flex items-center justify-between">
          <div>
            <p class="text-purple-800/90 text-sm">Jumlah Murid</p>
            <div id="kpiMurid" class="text-purple-800 text-3xl font-extrabold leading-tight">--</div>
          </div>
          <div class="text-2xl">üë•</div>
        </div>
      </div>
    </div>
  </section>

  <section class="container-max px-4 pb-6 hidden" data-tab-panel="keseluruhan" data-reveal>
    <div class="bg-white rounded-2xl shadow-sm border border-gray-100">
      <div class="px-5 sm:px-6 py-3 flex items-center gap-2">
        <span class="text-2xl">üèÜ</span>
        <h2 class="text-xl font-semibold text-gray-800">Murid Terbaik</h2>
      </div>
      <div class="overflow-x-auto">
        <table class="w-full text-[14px] border-collapse">
          <thead>
            <tr class="bg-gradient-to-r from-purple-500 to-indigo-500 text-white">
              <th class="px-2.5 py-2 text-center">Ked.</th>
              <th class="px-2.5 py-2 text-center">Nama</th>
              <th class="px-2.5 py-2 text-center">Kelas</th>
              <th class="px-2.5 py-2 text-center">GP Murid</th>
              <th class="px-2.5 py-2 text-center">A+</th>
              <th class="px-2.5 py-2 text-center">A</th>
              <th class="px-2.5 py-2 text-center">A-</th>
              <th class="px-2.5 py-2 text-center">B+</th>
              <th class="px-2.5 py-2 text-center">B</th>
              <th class="px-2.5 py-2 text-center">C+</th>
              <th class="px-2.5 py-2 text-center">C</th>
            </tr>
          </thead>
          <tbody id="muridTerbaikBody" class="divide-y"></tbody>
        </table>
      </div>
      <div class="h-3"></div>
    </div>
  </section>

  <section class="container-max px-4 pb-6 hidden" data-tab-panel="keseluruhan" data-reveal>
    <div class="bg-white rounded-2xl shadow-sm border border-gray-100">
      <div class="px-5 sm:px-6 py-3 flex items-center gap-2">
        <span class="text-2xl">üìà</span>
        <h2 class="text-xl font-semibold text-gray-800">Carta Taburan Gred</h2>
      </div>
      <div class="px-3 pb-4">
        <div class="chart-fixed">
          <canvas id="gradeChart"></canvas>
        </div>
      </div>
    </div>
  </section>

  <section class="container-max px-4 pb-10 hidden" data-tab-panel="keseluruhan" data-reveal>
    <div class="bg-white rounded-2xl shadow-sm border border-gray-100">
      <div class="px-5 sm:px-6 py-3 flex items-center gap-2">
        <span class="text-2xl">üìö</span>
        <h2 class="text-xl font-semibold text-gray-800">Jadual Analisis Mata Pelajaran</h2>
      </div>
      <div class="overflow-x-auto">
        <table class="w-full text-[14px] border-collapse whitespace-nowrap min-w-[1100px]">
          <thead>
            <tr class="bg-green-600 text-white">
              <th class="px-2.5 py-2 text-center">Mata Pelajaran</th>
              <th class="px-2.5 py-2 text-center">Hadir</th>
              <th class="px-2.5 py-2 text-center">TH</th>
              <th class="px-2.5 py-2 text-center">A+</th>
              <th class="px-2.5 py-2 text-center">A</th>
              <th class="px-2.5 py-2 text-center">A-</th>
              <th class="px-2.5 py-2 text-center">B+</th>
              <th class="px-2.5 py-2 text-center">B</th>
              <th class="px-2.5 py-2 text-center">C+</th>
              <th class="px-2.5 py-2 text-center">C</th>
              <th class="px-2.5 py-2 text-center">D</th>
              <th class="px-2.5 py-2 text-center">E</th>
              <th class="px-2.5 py-2 text-center">G</th>
              <th class="px-2.5 py-2 text-center">%Lulus</th>
              <th class="px-2.5 py-2 text-center">%Gagal</th>
              <th class="px-2.5 py-2 text-center">
                GPMP
                <span id="gpmpSortBtn" class="sort-btn align-middle">
                  <svg class="up" viewBox="0 0 24 24"><path d="M7 14l5-5 5 5z"/></svg>
                  <svg class="down" viewBox="0 0 24 24"><path d="M7 10l5 5 5-5z"/></svg>
                </span>
              </th>
            </tr>
          </thead>
          <tbody id="analisisSubjekBody" class="divide-y"></tbody>
        </table>
      </div>
      <div class="h-3"></div>
    </div>
  </section>

  <!-- =================== TAB 2: Analisis Mata Pelajaran =================== -->
  <section data-tab-panel="matapelajaran" class="sticky-card bg-white/80 backdrop-blur border-b border-gray-100 hidden">
    <div class="container-max px-4 py-4">
      <div class="bg-white rounded-2xl shadow-sm border border-gray-100 px-4 sm:px-6 py-5">
        <h2 class="text-xl font-semibold text-gray-800 flex items-center gap-2 mb-5">
          <span>üìä</span> Analisis Mata Pelajaran
        </h2>

        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
          <div>
            <label for="kelasFilterMP" class="field-label">Kelas</label>
            <select id="kelasFilterMP" class="select-like mt-1">
              <option value="">Pilih Kelas</option>
            </select>
          </div>

          <div class="md:col-span-2">
            <label for="subjekFilter" class="field-label">Subjek</label>
            <select id="subjekFilter" class="select-like mt-1">
              <option value="">Pilih Subjek</option>
            </select>
          </div>

          <div>
            <button class="btn-primary mt-6 md:mt-0" onclick="generateSubjectCards()">
              Jana Analisis
            </button>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Kad Jadual Pecahan Kelas -->
  <section class="container-max px-4 pb-8 hidden" data-tab-panel="matapelajaran" id="pecahanKelasCard">
    <div class="bg-white rounded-2xl shadow-sm border border-gray-100">
      <div class="px-5 sm:px-6 py-3 flex items-center gap-2">
        <span class="text-2xl">üìä</span>
        <h2 class="text-xl font-semibold text-gray-800">Jadual Pecahan Kelas</h2>
      </div>
      <div class="overflow-x-auto">
        <table class="w-full text-[14px] border-collapse whitespace-nowrap min-w-[1100px]">
          <thead>
            <tr class="bg-gradient-to-r from-indigo-500 to-blue-600 text-white">
              <th class="px-2.5 py-2 text-center">Kelas</th>
              <th class="px-2.5 py-2 text-center">Hadir</th>
              <th class="px-2.5 py-2 text-center">TH</th>
              <th class="px-2.5 py-2 text-center">A+</th>
              <th class="px-2.5 py-2 text-center">A</th>
              <th class="px-2.5 py-2 text-center">A-</th>
              <th class="px-2.5 py-2 text-center">B+</th>
              <th class="px-2.5 py-2 text-center">B</th>
              <th class="px-2.5 py-2 text-center">C+</th>
              <th class="px-2.5 py-2 text-center">C</th>
              <th class="px-2.5 py-2 text-center">D</th>
              <th class="px-2.5 py-2 text-center">E</th>
              <th class="px-2.5 py-2 text-center">G</th>
              <th class="px-2.5 py-2 text-center">%Lulus</th>
              <th class="px-2.5 py-2 text-center">%Gagal</th>
              <th class="px-2.5 py-2 text-center">
                GPMP
                <span id="gpmpKelasSortBtn" class="sort-btn align-middle">
                  <svg class="up" viewBox="0 0 24 24"><path d="M7 14l5-5 5 5z"/></svg>
                  <svg class="down" viewBox="0 0 24 24"><path d="M7 10l5 5 5-5z"/></svg>
                </span>
              </th>
            </tr>
          </thead>
          <tbody id="pecahanKelasBody" class="divide-y"></tbody>
        </table>
      </div>
      <div class="h-3"></div>
    </div>
  </section>

  <!-- Kad Senarai Murid (DIKEMAS KINI: opsyen per halaman + sort Markah & Gred) -->
  <section class="container-max px-4 pb-10 hidden" data-tab-panel="matapelajaran" id="senaraiMuridCard">
    <div class="bg-white rounded-2xl shadow-sm border border-gray-100">
      <div class="px-5 sm:px-6 py-3 flex items-center justify-between">
        <div class="flex items-center gap-2">
          <span class="text-2xl">üë•</span>
          <h2 class="text-xl font-semibold text-gray-800">Senarai Murid</h2>
        </div>
        <div>
          <!-- Tambah: 5,10,15,20,25, Semua -->
          <select id="senaraiPageSize" class="border rounded-lg px-3 py-2 text-sm">
            <option value="5" selected>5 per halaman</option>
            <option value="10">10 per halaman</option>
            <option value="15">15 per halaman</option>
            <option value="20">20 per halaman</option>
            <option value="25">25 per halaman</option>
            <option value="ALL">Semua</option>
          </select>
        </div>
      </div>

      <div class="overflow-x-auto">
        <table class="w-full text-[14px] border-collapse whitespace-nowrap">
          <thead>
            <tr class="bg-gradient-to-r from-purple-500 to-pink-500 text-white">
              <th class="px-3 py-2 text-center">Bil</th>
              <th class="px-3 py-2 text-center">Nama</th>
              <th class="px-3 py-2 text-center">Kelas</th>
              <th class="px-3 py-2 text-center">
                Markah
                <!-- 3-laras sort Markah -->
                <span id="senaraiMarkahSortBtn" class="sort-btn inline-flex align-middle ml-1">
                  <svg class="up" viewBox="0 0 24 24"><path d="M7 14l5-5 5 5z"/></svg>
                  <svg class="down" viewBox="0 0 24 24"><path d="M7 10l5 5 5-5z"/></svg>
                </span>
              </th>
              <th class="px-3 py-2 text-center">
                Gred
                <!-- 3-laras sort Gred -->
                <span id="senaraiGredSortBtn" class="sort-btn inline-flex align-middle ml-1">
                  <svg class="up" viewBox="0 0 24 24"><path d="M7 14l5-5 5 5z"/></svg>
                  <svg class="down" viewBox="0 0 24 24"><path d="M7 10l5 5 5-5z"/></svg>
                </span>
              </th>
            </tr>
          </thead>
          <tbody id="senaraiMuridBody" class="divide-y"></tbody>
        </table>
      </div>

      <div class="flex flex-col sm:flex-row items-center justify-between px-5 sm:px-6 py-3 gap-3">
        <div id="senaraiInfo" class="text-xs sm:text-sm text-gray-600"></div>
        <div class="flex items-center gap-2">
          <button id="senaraiPrev" class="px-4 py-2 rounded-lg bg-gray-100 text-gray-600">Sebelum</button>
          <div id="senaraiPageLabel" class="text-xs sm:text-sm text-gray-600">Halaman 1 daripada 1</div>
          <button id="senaraiNext" class="px-4 py-2 rounded-lg bg-gray-100 text-gray-600">Seterusnya</button>
        </div>
      </div>
    </div>
  </section>

<!-- =============== TAB 3: Analisis Layak Sijil =============== -->

<!-- Sticky Card (atas, kekal) -->
<section data-tab-panel="layaksijil" 
         class="ls-sticky-card bg-white/80 backdrop-blur border-b border-gray-100 hidden">
  <div class="ls-container px-4 py-4">
    <div class="bg-white rounded-2xl shadow-sm border border-gray-100 px-4 sm:px-6 py-5">
      <h2 class="text-xl font-semibold text-gray-800 flex items-center gap-2 mb-5">
        <span>üìä</span> Analisis Layak Sijil
      </h2>

      <div class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
        <!-- Dropdown Kelas -->
        <div class="md:col-span-3">
          <label for="ls-kelasFilter" class="ls-field-label">Kelas</label>
          <select id="ls-kelasFilter" class="ls-select mt-1">
            <option value="">Pilih Kelas</option>
          </select>
        </div>

        <!-- Butang Jana Analisis -->
        <div>
          <button class="ls-btn mt-6 md:mt-0"
            onclick="window.generateEligibilityCards && generateEligibilityCards()">
            Jana Analisis
          </button>
        </div>
      </div>
    </div>
  </div>
</section>


<!-- ‚úÖ Kad Ringkasan (asing, bawah sticky, asalnya hidden) -->
<section id="kadLayakSection" data-tab-panel="layaksijil" data-reveal 
         class="container-max px-4 pt-4 pb-6 hidden">
  <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">

    <!-- Kad Layak -->
    <div class="rounded-2xl border border-green-100 bg-green-50 shadow-sm h-[6.5rem]">
      <div class="h-full px-6 flex items-center justify-between">
        <div>
          <p class="text-green-800/90 text-sm">Layak Sijil</p>
          <div id="countLayak" class="text-green-800 text-3xl font-extrabold leading-tight">0</div>
          <p id="percentLayak" class="text-green-700 text-sm font-medium">0%</p>
        </div>
        <div class="text-3xl">üéì</div>
      </div>
    </div>

    <!-- Kad Tidak Layak -->
    <div class="rounded-2xl border border-red-100 bg-red-50 shadow-sm h-[6.5rem]">
      <div class="h-full px-6 flex items-center justify-between">
        <div>
          <p class="text-red-800/90 text-sm">Tidak Layak</p>
          <div id="countTidakLayak" class="text-red-800 text-3xl font-extrabold leading-tight">0</div>
          <p id="percentTidak" class="text-red-700 text-sm font-medium">0%</p>
        </div>
        <div class="text-3xl">‚ùå</div>
      </div>
    </div>

    <!-- Kad Jumlah -->
    <div class="rounded-2xl border border-indigo-100 bg-indigo-50 shadow-sm h-[6.5rem]">
      <div class="h-full px-6 flex items-center justify-between">
        <div>
          <p class="text-indigo-800/90 text-sm">Jumlah Murid</p>
          <div id="countJumlah" class="text-indigo-800 text-3xl font-extrabold leading-tight">0</div>
        </div>
        <div class="text-3xl">üë•</div>
      </div>
    </div>

  </div>
</section>
  
<!-- Tab 3: üìä Jadual Analisis BM & SEJ (asalnya hidden) -->
<section id="jadualBmSej" data-tab-panel="layaksijil" data-reveal 
         class="container-max px-4 pb-8 hidden">
  <div class="bg-white rounded-2xl shadow-sm border border-gray-100">
    <div class="px-5 sm:px-6 py-3 flex items-center gap-2">
      <span class="text-2xl">üìä</span>
      <h2 class="text-xl font-semibold text-gray-800">Jadual Analisis BM & SEJ</h2>
    </div>
    <div class="overflow-x-auto">
      <table class="w-full text-[14px] border-collapse min-w-[600px]">
        <thead>
          <tr class="bg-gradient-to-r from-blue-500 to-indigo-600 text-white">
            <th class="px-3 py-2 text-center">MATA PELAJARAN</th>
            <th class="px-3 py-2 text-center">Hadir</th>
            <th class="px-3 py-2 text-center">TH</th>
            <th class="px-3 py-2 text-center">A+</th>
            <th class="px-3 py-2 text-center">A</th>
            <th class="px-3 py-2 text-center">A-</th>
            <th class="px-3 py-2 text-center">B+</th>
            <th class="px-3 py-2 text-center">B</th>
            <th class="px-3 py-2 text-center">C+</th>
            <th class="px-3 py-2 text-center">C</th>
            <th class="px-3 py-2 text-center">D</th>
            <th class="px-3 py-2 text-center">E</th>
            <th class="px-3 py-2 text-center">G</th>
            <th class="px-3 py-2 text-center">%Lulus</th>
            <th class="px-3 py-2 text-center">%Gagal</th>
            <th class="px-3 py-2 text-center">GPMP</th>
          </tr>
        </thead>
        <tbody id="bmSejBody" class="divide-y"></tbody>
      </table>
    </div>
  </div>
</section>

<!-- ‚úÖ Kad Analisis Silang BM & SEJ -->
<section id="kadSilangBmSej" data-tab-panel="layaksijil" data-reveal 
         class="container-max px-4 pt-4 pb-6 hidden">
  <div class="bg-white rounded-2xl shadow-sm border border-gray-100">
    <div class="px-5 sm:px-6 py-3 flex items-center gap-2 border-b">
      <span class="text-2xl">üîÑ</span>
      <h2 class="text-xl font-semibold text-gray-800">Analisis Silang BM & SEJ</h2>
    </div>
    <div class="overflow-x-auto">
      <table class="w-full text-sm border-collapse">
        <thead>
          <tr class="bg-gradient-to-r from-teal-500 to-cyan-600 text-white">
            <th class="px-3 py-2">BM / SEJ</th>
            <th class="px-3 py-2">SEJ Lulus</th>
            <th class="px-3 py-2">SEJ Gagal</th>
            <th class="px-3 py-2">SEJ TH</th>
            <th class="px-3 py-2 bg-yellow-500">Jumlah</th>
          </tr>
        </thead>
        <tbody id="silangBmSejBody" class="divide-y"></tbody>
      </table>
    </div>
  </div>
</section>

 <!-- ‚úÖ Kad Senarai Murid (Tab 3: Layak Sijil) -->
<section id="kadSenaraiLayak" data-tab-panel="layaksijil" data-reveal 
         class="container-max px-4 pt-4 pb-10 hidden">
  <div class="bg-white rounded-2xl shadow-sm border border-gray-100">
    <div class="px-5 sm:px-6 py-3 flex items-center justify-between">
      <div class="flex items-center gap-2">
        <span class="text-2xl">üë•</span>
        <h2 class="text-xl font-semibold text-gray-800">Senarai Murid</h2>
      </div>
      <div>
        <!-- Pilihan bilangan per halaman -->
        <select id="layakPageSize" class="border rounded-lg px-3 py-2 text-sm">
          <option value="5" selected>5 per halaman</option>
          <option value="10">10 per halaman</option>
          <option value="15">15 per halaman</option>
          <option value="20">20 per halaman</option>
          <option value="ALL">Semua</option>
        </select>
      </div>
    </div>

    <div class="overflow-x-auto">
      <table class="w-full text-[14px] border-collapse whitespace-nowrap">
 <thead>
  <tr class="bg-gradient-to-r from-pink-500 to-purple-600 text-white">
    <th class="px-3 py-2 text-center">Bil</th>
    <th class="px-3 py-2 text-center">Nama</th>
    <th class="px-3 py-2 text-center">Kelas</th>
    <th class="px-3 py-2 text-center">
      Markah BM
      <span id="layakBmMarkahSortBtn" class="sort-btn inline-flex align-middle ml-1">
        <svg class="up" viewBox="0 0 24 24"><path d="M7 14l5-5 5 5z"/></svg>
        <svg class="down" viewBox="0 0 24 24"><path d="M7 10l5 5 5-5z"/></svg>
      </span>
    </th>
    <th class="px-3 py-2 text-center">Gred BM</th>
    <th class="px-3 py-2 text-center">
      Markah SEJ
      <span id="layakSejMarkahSortBtn" class="sort-btn inline-flex align-middle ml-1">
        <svg class="up" viewBox="0 0 24 24"><path d="M7 14l5-5 5 5z"/></svg>
        <svg class="down" viewBox="0 0 24 24"><path d="M7 10l5 5 5-5z"/></svg>
      </span>
    </th>
    <th class="px-3 py-2 text-center">Gred SEJ</th>
    <th class="px-3 py-2 text-center">
      Status
      <span id="layakStatusSortBtn" class="sort-btn inline-flex align-middle ml-1">
        <svg class="up" viewBox="0 0 24 24"><path d="M7 14l5-5 5 5z"/></svg>
        <svg class="down" viewBox="0 0 24 24"><path d="M7 10l5 5 5-5z"/></svg>
      </span>
    </th>
  </tr>
</thead>

        <tbody id="senaraiLayakBody" class="divide-y"></tbody>
      </table>
    </div>

    <div class="flex flex-col sm:flex-row items-center justify-between px-5 sm:px-6 py-3 gap-3">
      <div id="layakInfo" class="text-xs sm:text-sm text-gray-600"></div>
      <div class="flex items-center gap-2">
        <button id="layakPrev" class="px-4 py-2 rounded-lg bg-gray-100 text-gray-600">Sebelum</button>
        <div id="layakPageLabel" class="text-xs sm:text-sm text-gray-600">Halaman 1 daripada 1</div>
        <button id="layakNext" class="px-4 py-2 rounded-lg bg-gray-100 text-gray-600">Seterusnya</button>
      </div>
    </div>
  </div>
</section>


<!-- Sticky Bar -->
<!-- =============== TAB 4: Analisis Combat Zone =============== -->

    <!-- Sticky card -->
 <!-- =============== TAB 4: Analisis Combat Zone =============== -->

<!-- Sticky Card -->
<section data-tab-panel="combatzone" 
         class="cz-sticky-card bg-white/80 backdrop-blur border-b border-gray-100 hidden">
  <div class="cz-container px-4 py-4">
    <div class="bg-white rounded-2xl shadow-sm border border-gray-100 px-4 sm:px-6 py-5">
      <h2 class="text-xl font-semibold text-gray-800 flex items-center gap-2 mb-5">
        <span>‚ö†Ô∏è</span> Analisis Combat Zone
      </h2>

      <div class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
        <div>
          <label for="cz-kelasFilter" class="cz-field-label">Kelas</label>
          <select id="cz-kelasFilter" class="cz-select mt-1">
            <option value="">Pilih Kelas</option>
          </select>
        </div>
        <div class="md:col-span-2">
          <label for="cz-subjekFilter" class="cz-field-label">Subjek</label>
          <select id="cz-subjekFilter" class="cz-select mt-1">
            <option value="">Pilih Subjek</option>
          </select>
        </div>
        <div>
          <button id="btnCombatZone" class="cz-btn mt-6 md:mt-0"
                  onclick="window.generateCombatZone && generateCombatZone()">
            Jana Analisis Combat Zone
          </button>
        </div>
      </div>
    </div>
  </div>
</section>


<!-- ‚úÖ Kad Ringkasan Combat Zone -->
<section id="kadCombatZoneSection" data-tab-panel="combatzone" data-reveal 
         class="container-max px-4 pt-4 pb-6 hidden">

  <div id="combatZoneKPIs" class="grid grid-cols-1 md:grid-cols-6 gap-4">

    <!-- Kualiti 1 -->
    <div class="bg-gradient-to-br from-yellow-50 to-yellow-100 rounded-lg p-4 border border-yellow-200">
      <div class="flex items-center justify-between h-full">
        <div>
          <p class="text-yellow-600 text-xs font-medium">üèÜ Kualiti 1</p>
          <p id="countKualiti1" class="text-lg font-bold text-yellow-800">0</p>
          <p id="percentKualiti1" class="text-xs text-yellow-600">A+, A, A-</p>
        </div>
        <div class="text-yellow-500 text-2xl">üèÜ</div>
      </div>
    </div>

    <!-- Kualiti 2 -->
    <div class="bg-gradient-to-br from-gray-50 to-gray-100 rounded-lg p-4 border border-gray-200">
      <div class="flex items-center justify-between h-full">
        <div>
          <p class="text-gray-600 text-xs font-medium">ü•à Kualiti 2</p>
          <p id="countKualiti2" class="text-lg font-bold text-gray-800">0</p>
          <p id="percentKualiti2" class="text-xs text-gray-600">B+, B</p>
        </div>
        <div class="text-gray-500 text-2xl">ü•à</div>
      </div>
    </div>

    <!-- Pertahanan 1 -->
    <div class="bg-gradient-to-br from-blue-50 to-blue-100 rounded-lg p-4 border border-blue-200">
      <div class="flex items-center justify-between h-full">
        <div>
          <p class="text-blue-600 text-xs font-medium">üõ°Ô∏è Pertahanan 1</p>
          <p id="countPertahanan1" class="text-lg font-bold text-blue-800">0</p>
          <p id="percentPertahanan1" class="text-xs text-blue-600">C+, C</p>
        </div>
        <div class="text-blue-500 text-2xl">üõ°Ô∏è</div>
      </div>
    </div>

    <!-- Pertahanan 2 -->
    <div class="bg-gradient-to-br from-orange-50 to-orange-100 rounded-lg p-4 border border-orange-200">
      <div class="flex items-center justify-between h-full">
        <div>
          <p class="text-orange-600 text-xs font-medium">‚ö†Ô∏è Pertahanan 2</p>
          <p id="countPertahanan2" class="text-lg font-bold text-orange-800">0</p>
          <p id="percentPertahanan2" class="text-xs text-orange-600">D, E</p>
        </div>
        <div class="text-orange-500 text-2xl">‚ö†Ô∏è</div>
      </div>
    </div>

    <!-- Kuantiti -->
    <div class="bg-gradient-to-br from-red-50 to-red-100 rounded-lg p-4 border border-red-200">
      <div class="flex items-center justify-between h-full">
        <div>
          <p class="text-red-600 text-xs font-medium">üìä Kuantiti</p>
          <p id="countKuantiti" class="text-lg font-bold text-red-800">0</p>
          <p id="percentKuantiti" class="text-xs text-red-600">G, TH</p>
        </div>
        <div class="text-red-500 text-2xl">üìä</div>
      </div>
    </div>

    <!-- Jumlah Murid -->
    <div class="bg-gradient-to-br from-purple-50 to-purple-100 rounded-lg p-4 border border-purple-200">
      <div class="flex items-center justify-between h-full">
        <div>
          <p class="text-purple-600 text-xs font-medium">üë• Jumlah Murid</p>
          <p id="countJumlahCZ" class="text-lg font-bold text-purple-800">0</p>
          <p class="text-xs text-purple-600">100%</p>
        </div>
        <div class="text-purple-500 text-2xl">üë•</div>
      </div>
    </div>

  </div>
</section>

</section>




  
<!-- ‚úÖ Jadual Pecahan Combat Zone Mengikut Kelas -->
<section id="combatZoneClassBreakdownSection" 
         data-tab-panel="combatzone" data-reveal 
         class="container-max px-4 pb-6 hidden">

  <div class="bg-white rounded-lg shadow-sm p-6">
    <h3 class="text-lg font-semibold mb-4 text-gray-800">
      üìä Jadual Pecahan Mengikut Kelas
    </h3>
    <div class="overflow-x-auto">
      <table class="w-full border-collapse">
        <thead>
          <tr class="bg-gradient-to-r from-red-500 to-orange-600 text-white">
            <th class="px-4 py-3 text-left text-sm font-medium">Kelas</th>
            <th class="px-4 py-3 text-center text-sm font-medium">Jumlah</th>
            <th class="px-4 py-3 text-center text-sm font-medium">üèÜ Kualiti 1</th>
            <th class="px-4 py-3 text-center text-sm font-medium">ü•à Kualiti 2</th>
            <th class="px-4 py-3 text-center text-sm font-medium">üõ°Ô∏è Pertahanan 1</th>
            <th class="px-4 py-3 text-center text-sm font-medium">‚ö†Ô∏è Pertahanan 2</th>
            <th class="px-4 py-3 text-center text-sm font-medium">üìä Kuantiti</th>
          </tr>
        </thead>
        <tbody id="combatZoneClassBreakdownTable" 
               class="divide-y divide-gray-200 text-sm">
          <!-- baris dinamik diisi JS -->
        </tbody>
      </table>
    </div>
  </div>

</section>

<!-- TAB 4 Senarai Murid Mengikut Kategori -->
<section id="combatZoneCategorySection" 
         data-tab-panel="combatzone" data-reveal 
         class="container-max px-4 pb-6 hidden">

  <div class="bg-white rounded-lg shadow-sm p-6">
    <h3 class="text-lg font-semibold mb-4 text-gray-800">
      üë• Senarai Murid Mengikut Kategori
    </h3>

    <!-- Butang Tab Kategori -->
    <div class="flex gap-2 mb-4 flex-wrap">
      <button id="combatZoneTab-kualiti1" 
              class="px-3 py-1 rounded bg-gray-200 text-gray-700"
              onclick="switchCombatZoneCategory('kualiti1')">
        üèÜ Kualiti 1 (<span id="kualiti1TabCount">0</span>)
      </button>
      <button id="combatZoneTab-kualiti2" 
              class="px-3 py-1 rounded bg-gray-200 text-gray-700"
              onclick="switchCombatZoneCategory('kualiti2')">
        ü•à Kualiti 2 (<span id="kualiti2TabCount">0</span>)
      </button>
      <button id="combatZoneTab-pertahanan1" 
              class="px-3 py-1 rounded bg-gray-200 text-gray-700"
              onclick="switchCombatZoneCategory('pertahanan1')">
        üõ°Ô∏è Pertahanan 1 (<span id="pertahanan1TabCount">0</span>)
      </button>
      <button id="combatZoneTab-pertahanan2" 
              class="px-3 py-1 rounded bg-gray-200 text-gray-700"
              onclick="switchCombatZoneCategory('pertahanan2')">
        ‚ö†Ô∏è Pertahanan 2 (<span id="pertahanan2TabCount">0</span>)
      </button>
      <button id="combatZoneTab-kuantiti" 
              class="px-3 py-1 rounded bg-gray-200 text-gray-700"
              onclick="switchCombatZoneCategory('kuantiti')">
        üìä Kuantiti (<span id="kuantitiTabCount">0</span>)
      </button>
    </div>

    <!-- Jadual Senarai Murid -->
    <div class="overflow-x-auto">
      <table class="w-full border-collapse text-sm">
        <thead>
          <tr class="bg-gradient-to-r from-purple-500 to-pink-500 text-white">
            <th class="px-4 py-2 text-left">Bil</th>
            <th class="px-4 py-2 text-left">Nama</th>
            <th class="px-4 py-2 text-center">Kelas</th>
            <th class="px-4 py-2 text-center">GP Murid</th>
          </tr>
        </thead>
        <tbody id="combatZoneCategoryStudentTable">
          <tr>
            <td colspan="4" class="p-4 text-gray-400 text-center">
              Tiada data
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</section>

 <!-- ====== GAYA KHAS Combat Zone ====== -->
<style>
  .cz-sticky-card{
    position:sticky;
    top:0;
    z-index:40
  }
  .cz-field-label{
    font-size:.65rem;
    color:#374151;
    font-weight:600
  }
  .cz-select{
    width:100%;
    border:1px solid #e5e7eb;
    border-radius:0.55rem;
    padding:0.75rem 1rem;
    font-size:.95rem;
    background:#fff;
    box-shadow:0 1px 2px rgba(16,24,40,.04);
  }
  .cz-select:focus{
    border-color:#ef4444;
    box-shadow:0 0 0 3px rgba(239,68,68,.25)
  }
  .cz-btn{
    display:inline-flex;
    align-items:center;
    justify-content:center;
    width:100%;
    padding:.875rem 1rem;
    border-radius:.9rem;
    font-weight:700;
    color:#fff;
    background:#dc2626; /* merah */
    box-shadow:0 1px 3px rgba(220,38,38,.25);
    transition:transform .06s,filter .15s,background .15s;
  }
  .cz-btn:hover{filter:brightness(1.05)}
  .cz-btn:active{transform:scale(.985)}
  .cz-container{max-width:1200px;margin-left:auto;margin-right:auto}

  /* ‚úÖ Tambahan khas untuk kad Combat Zone */
  #kadCombatZoneSection .rounded-2xl {
    height: 4.5rem !important;   /* asal 6.5rem ‚Üí jadi lebih nipis */
  }

  #kadCombatZoneSection p.text-sm {
    font-size: 0.8rem !important; /* kecilkan tajuk */
    font-weight: 600;             /* kekalkan tebal supaya jelas */
  }
</style>



  
<!-- ====== GAYA KHAS (namespaced `ls-`) ====== -->
<style>
  /* Asas supaya komponen ini tidak bertembung gaya lain */
  .ls-sticky-card{position:sticky;top:0;z-index:40}
  .ls-field-label{font-size:.95rem;color:#374151;font-weight:600}
  .ls-select{
    width:100%;border:1px solid #e5e7eb;border-radius:0.75rem;
    padding:0.75rem 1rem;font-size:.95rem;background:#fff;
    box-shadow:0 1px 2px rgba(16,24,40,.04);
    outline:none;transition:border-color .15s,box-shadow .15s;
  }
  .ls-select:focus{border-color:#3b82f6;box-shadow:0 0 0 3px rgba(59,130,246,.25)}
  .ls-btn{
    display:inline-flex;align-items:center;justify-content:center;width:100%;
    padding:.875rem 1rem;border-radius:.9rem;font-weight:700;color:#fff;
    background:#3b5bfd;box-shadow:0 1px 3px rgba(59,91,253,.25);
    transition:transform .06s,filter .15s,background .15s;
  }
  .ls-btn:hover{filter:brightness(1.05)}
  .ls-btn:active{transform:scale(.985)}
  .ls-container{max-width:1200px;margin-left:auto;margin-right:auto}
</style>






<!-- ====== SCRIPT KHAS (namespaced, tidak sentuh global lain) ====== -->

<!-- =============== Tamat Kad Sticky Tab Analisis Layak Sijil =============== -->


  <!-- =================== FOOTER =================== -->
  <footer class="mt-10">
    <div class="h-0.5 bg-gradient-to-r from-blue-500 via-indigo-500 to-purple-500 opacity-70"></div>
    <div class="text-center text-[11px] sm:text-xs text-gray-500 py-3">
      ¬© 2025 <span class="font-medium">XCode Mr LePaK</span> - Analisis PPSA vs PraSPM
    </div>
  </footer>

  <script>
    /* ========= CSV & UTIL ========= */
    //https://docs.google.com/spreadsheets/d/e/2PACX-1vRck15kwRkf75NPm1IouErXU_CDgHjMEGw1nm0FNCu1XAkIb3EF0XV36Mq66wui_0imgyC9OKzoVQl9/pub?gid=22937657&single=true&output=csv

    const csvUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRck15kwRkf75NPm1IouErXU_CDgHjMEGw1nm0FNCu1XAkIb3EF0XV36Mq66wui_0imgyC9OKzoVQl9/pub?gid=22937657&single=true&output=csv";
    const gradeValueMapping = { "A+":0,"A":1,"A-":2,"B+":3,"B":4,"C+":5,"C":6,"D":7,"E":8,"G":9 };
    const chartGradeLabels = ["A+","A","A-","B+","B","C+","C","D","E","G"];
    const topGradeLabels = ["A+","A","A-","B+","B","C+","C"];
    const gradeColors={"A+":"#16a34a","A":"#22c55e","A-":"#86efac","B+":"#eab308","B":"#facc15","C+":"#fb923c","C":"#f97316","D":"#f87171","E":"#ef4444","G":"#991b1b"};

    const subjectNameMap = {
      "BM":"BAHASA MELAYU","BI":"BAHASA INGGERIS","M":"MATEMATIK","SN":"SAINS","MT":"MATEMATIK TAMBAHAN","SEJ":"SEJARAH",
      "PAI":"PENDIDIKAN ISLAM","PM":"PENDIDIKAN MORAL","PSV":"PENDIDIKAN SENI VISUAL","PJK":"PENDIDIKAN JASMANI DAN KESIHATAN",
      "BIO":"BIOLOGI","KIM":"KIMIA","FIZ":"FIZIK","SS":"SAINS SUKAN","SK":"SAINS KOMPUTER","SRT":"SAINS RUMAH TANGGA",
      "PER":"PERTANIAN","PP":"PERNIAGAAN","PA":"PRINSIP PERAKAUNAN","TAS":"TASAWWUR ISLAM","PAIM":"PENDIDIKAN ISLAM MPAK",
      "GEO":"GEOGRAFI","BT":"BAHASA TAMIL","KT":"KESUSASTERAAN TAMIL","RC":"REKA CIPTA","SPER":"SAINS PERTANIAN"
    };
    const subjectGroupMap = {
      "Bahasa": ["BM","BI","BT","KT"],
      "Kemanusiaan": ["PAI","PM","SEJ","GEO","PSV","PJK","PAIM","TAS"],
      "Sains & Matematik": ["M","SN","MT","FIZ","BIO","KIM"],
      "Teknik & Vokasional": ["SK","SRT","PER","PP","PA","SS","RC","SPER"]
    };

    let headerMap = {}, subjectColumns = [], cachedData = null, gradeChartInstance = null;

    // GPMP sort (subjek)
    let subjectStatsCurrent = [], subjectStatsOriginal = [], gpmpSortState = "none";
    // GPMP sort (pecahan kelas)
    let pecahanKelasRowsOriginal = [], pecahanKelasRowsCurrent = [], gpmpKelasSortState = "none";

    // Senarai Murid (state)
    const senaraiState = { rows: [], rowsOriginal: [], page: 1, pageSize: 5 }; //ubah
    let markahSortState = "none"; // asc | desc | none
    let gredSortState   = "none"; // asc | desc | none

    // Simpanan sementara senarai murid untuk Combat Zone
    let muridDataCZ = [];


    function cariKolum(keyword){
      const k = keyword.toLowerCase();
      return Object.values(headerMap).find(h => (h||"").toLowerCase().includes(k));
    }
    function cariKolumGredSubjek(kod){
      const upper = kod.toUpperCase();
      return Object.values(headerMap).find(h => {
        const H = (h||"").toUpperCase();
        return H.startsWith(upper + " ") && /\b(G|GRED|GRADE)\b/.test(H);
      });
    }
    function cariKolumMarkahSubjek(kod){
      const upper = kod.toUpperCase();
      return Object.values(headerMap).find(h => {
        const H = (h||"").toUpperCase();
        return H.startsWith(upper + " ") && /\b(M|MARK|MARKAH|MARKS)\b/.test(H);
      });
    }
    function parseCSV(csv){
      const lines = csv.trim().split(/\r?\n/);
      const lineSubjek = (lines[1]||"").split(',').map(s=>s.trim());
      const lineJenis  = (lines[2]||"").split(',').map(s=>s.trim());
      let currentSubjek = "";
      const headers = lineSubjek.map((subjek,i)=>{
        if(subjek) currentSubjek = subjek;
        return lineJenis[i] ? `${currentSubjek} ${lineJenis[i]}`.trim() : currentSubjek;
      });
      headerMap = {}; headers.forEach(h => headerMap[(h||"").toLowerCase()] = h);
      subjectColumns = headers.filter(h => {
  if(!h) return false;
  const upper = h.toUpperCase();
  // tolak PNG / GP / purata atau kolum kiraan
  if(upper.includes("PNG") || upper.includes("GP")) return false;
  return /\b(G|GRED|GRADE)\b/i.test(h);
});

      const dataRows = lines.slice(3).map(row => {
        const vals = row.split(','); const obj = {};
        headers.forEach((h, i) => obj[h] = (vals[i]||"").trim()); return obj;
      });
      return dataRows;
    }

    // Dropdown Kelas (buang '1')
    function autoIsiDropdownKelasKe(data, elId){
      const kelasHeader = cariKolum("kelas");
      if(!kelasHeader) return;
      const kelasSet = new Set(
        data.map(r => (r[kelasHeader] || "").trim())
            .filter(k => k && k.toUpperCase() !== "SEMUA KELAS" && k !== "1")
      );
      const sel = document.getElementById(elId);
      if(!sel) return;
      sel.innerHTML = "";
      const optDefault = document.createElement("option");
      optDefault.value = ""; optDefault.textContent = "Pilih Kelas"; sel.appendChild(optDefault);
      const optAll = document.createElement("option");
      optAll.value = "SEMUA KELAS"; optAll.textContent = "SEMUA KELAS"; sel.appendChild(optAll);
      [...kelasSet].sort((a,b)=>a.localeCompare(b,'ms',{numeric:true})).forEach(k=>{
        const o=document.createElement("option"); o.value=k; o.textContent=k; sel.appendChild(o);
      });
    }
    // Dropdown Subjek auto CSV
    function autoIsiDropdownSubjekKe(elId){
      const sel = document.getElementById(elId);
      if(!sel) return;
      let subjects = [...new Set(subjectColumns.map(c => (c.split(" ")[0] || "").trim()))]
        .filter(s => s && s.toUpperCase()!=="GRED" && s!=="G");
      subjects.sort((a,b)=>{
        const A = (subjectNameMap[a] || a);
        const B = (subjectNameMap[b] || b);
        return A.localeCompare(B,'ms',{numeric:true});
      });
      sel.innerHTML = '<option value="">Pilih Subjek</option>';
      subjects.forEach(code=>{
        const label = (subjectNameMap[code] || code).toUpperCase();
        const opt = document.createElement('option');
        opt.value = code;
        opt.textContent = label;
        sel.appendChild(opt);
      });
    }
    function filterSubjectsByBidang(subjects){
      const bidang = document.getElementById("bidangFilter")?.value || "Semua Bidang";
      if(!bidang || bidang==="Semua Bidang") return subjects;
      const allowed = subjectGroupMap[bidang]||[];
      return subjects.filter(sub=>allowed.includes(sub));
    }

    /* ========= INIT ========= */
    document.addEventListener('DOMContentLoaded', async ()=>{
      try{
        const res = await fetch(csvUrl);
        const csv = await res.text();
        cachedData = parseCSV(csv);

        console.log("Jumlah rekod CSV:", cachedData.length);
console.log("HeaderMap:", headerMap);
console.log("SubjectColumns:", subjectColumns);
console.log("Contoh baris 1:", cachedData[0]);


        // KPI header keseluruhan
        kiraHeaderKPI(cachedData);

        // Dropdown
        autoIsiDropdownKelasKe(cachedData, "kelasFilter");
        autoIsiDropdownKelasKe(cachedData, "kelasFilterMP");
        autoIsiDropdownSubjekKe("subjekFilter");

        //Layak Sijil
        autoIsiDropdownKelasKe(cachedData, "ls-kelasFilter"); // untuk Tab 3

        // ‚úÖ Dropdown Tab 4 (Combat Zone)
    autoIsiDropdownKelasKe(cachedData, "cz-kelasFilter");
    autoIsiDropdownSubjekKe("cz-subjekFilter");

      }catch(e){ console.error(e); }

      showTab('keseluruhan');
    });

    function kiraHeaderKPI(data){
      const gpsElHeader = document.getElementById('gpsValue');
      const sijilElHeader = document.getElementById('layakSijilValue');

      let jumlahNilai = 0, bilGred = 0, jumlahMurid = 0, layak = 0;
      const bmCol  = cariKolumGredSubjek("BM");
      const sejCol = cariKolumGredSubjek("SEJ");

      data.forEach(row=>{
        let adaGred = false;
        subjectColumns.forEach(col=>{
          const g = (row[col]||"").toUpperCase();
          if(gradeValueMapping.hasOwnProperty(g)){ jumlahNilai += gradeValueMapping[g]; bilGred++; adaGred=true; }
        });
        if(adaGred){
          jumlahMurid++;
          const bm=(bmCol?row[bmCol]:"").toUpperCase();
          const sej=(sejCol?row[sejCol]:"").toUpperCase();
          if(bm && sej && bm!=="G" && sej!=="G") layak++;
        }
      });
      const gps = bilGred ? (jumlahNilai/bilGred).toFixed(2) : "-";
      const peratusLayak = jumlahMurid ? ((layak/jumlahMurid)*100).toFixed(1)+"%" : "-";
      gpsElHeader.textContent = gps;
      sijilElHeader.textContent = peratusLayak;
    }

    /* ========= TAB NAV ========= */
    function switchTab(which){
      const ids=['keseluruhan','matapelajaran','layaksijil','combatzone','individu'];
      ids.forEach(id=>{
        const el=document.getElementById('tab-'+id);
        if(!el) return;
        el.classList.remove('tab-active'); el.classList.add('bg-white');
      });
      const active=document.getElementById('tab-'+which);
      if(active){ active.classList.remove('bg-white'); active.classList.add('tab-active'); }
      showTab(which);
    }

function showTab(which){
  document.querySelectorAll('[data-tab-panel]').forEach(p => p.classList.add('hidden'));
  const panels = document.querySelectorAll(`[data-tab-panel="${which}"]`);
  panels.forEach(p => p.classList.remove('hidden'));

  if(which==='keseluruhan'){
    document.querySelectorAll(`[data-tab-panel="${which}"][data-reveal]`)
            .forEach(p => p.classList.add('hidden'));
  }
  if(which==='matapelajaran'){
    document.getElementById('pecahanKelasCard')?.classList.add('hidden');
    document.getElementById('senaraiMuridCard')?.classList.add('hidden');
  }
  if(which==='layaksijil'){
    // ‚úÖ Sembunyikan Kad & Jadual dulu
  document.getElementById('kadLayakSection')?.classList.add('hidden');
  document.getElementById('jadualBmSej')?.classList.add('hidden');
  document.getElementById('kadSilangBmSej')?.classList.add('hidden');
  document.getElementById('kadSenaraiLayak')?.classList.add('hidden'); // ‚úÖ penting
 }
}



    /* ========= TAB 1: (kekal) ========= */
    function generateOverallAnalysis(){
      const kelasHeader=cariKolum("kelas"), namaHeader=cariKolum("nama");
      const kelasTerpilih=document.getElementById("kelasFilter").value;

      let dataTapis=(!kelasTerpilih||kelasTerpilih==="SEMUA KELAS")? cachedData : cachedData.filter(r=>r[kelasHeader]===kelasTerpilih);

      // KPI
      let jumlahMurid=0,jumlahGredNilai=0,jumlahSubjek=0,muridLayak=0;
      const bmCol  = cariKolumGredSubjek("BM");
      const sejCol = cariKolumGredSubjek("SEJ");

      let muridList=[];
      dataTapis.forEach(row=>{
        const nama=row[namaHeader]; let gredList=[];
        subjectColumns.forEach(c=>{
          const g=row[c]?.toUpperCase();
          if(gradeValueMapping.hasOwnProperty(g)){
            gredList.push(g); jumlahGredNilai+=gradeValueMapping[g]; jumlahSubjek++;
          }
        });
        if(gredList.length){
          jumlahMurid++;
          const bm = (bmCol?row[bmCol]:"").toUpperCase();
          const sej = (sejCol?row[sejCol]:"").toUpperCase();
          if (bm && sej && bm !== "G" && sej !== "G") muridLayak++;

          const gp=(gredList.reduce((a,g)=>a+gradeValueMapping[g],0)/gredList.length).toFixed(2);
          const counts = topGradeLabels.reduce((acc,g)=>{acc[g]=gredList.filter(x=>x===g).length; return acc;},{});
          muridList.push({nama, kelas:row[kelasHeader], gp, counts});
        }
      });

      document.getElementById("kpiGPS").textContent = (jumlahSubjek? (jumlahGredNilai/jumlahSubjek).toFixed(2):"--");
      document.getElementById("kpiLayak").textContent = (jumlahMurid? ((muridLayak/jumlahMurid)*100).toFixed(1)+"%":"--");
      document.getElementById("kpiMurid").textContent = jumlahMurid;

      // Murid terbaik
      muridList.sort((a,b)=>a.gp-b.gp);
      const top=document.getElementById("topStudentsCount").value;
      const body=document.getElementById("muridTerbaikBody"); body.innerHTML="";
      muridList.slice(0,top).forEach((m,i)=>{
        body.innerHTML += `
          <tr class="text-center">
            <td class="px-2.5 py-2">${i+1}</td>
            <td class="px-2.5 py-2 text-left">${m.nama}</td>
            <td class="px-2.5 py-2">${m.kelas}</td>
            <td class="px-2.5 py-2 font-bold text-blue-600">${m.gp}</td>
            ${topGradeLabels.map(g=>`<td class="px-2.5 py-2">${m.counts[g]||0}</td>`).join("")}
          </tr>`;
      });

      // Carta
      updateGradeChartBySubject(dataTapis);
      // Jadual subjek
      updateSubjectAnalysis(dataTapis);

      // TUNJUKKAN semua kad hasil (tab 1)
      document.querySelectorAll('[data-tab-panel="keseluruhan"][data-reveal]').forEach(p=>p.classList.remove('hidden'));
    }

    function updateGradeChartBySubject(dataTapis){
      const ctx=document.getElementById("gradeChart").getContext("2d");

      let subjects=[...new Set(subjectColumns.map(c=>c.split(" ")[0]))]
        .filter(s=>s.toUpperCase()!=="GRED" && s!=="G");
      subjects = filterSubjectsByBidang(subjects);

      const countsPerSubject={}; subjects.forEach(sub=>{countsPerSubject[sub]=Object.fromEntries(chartGradeLabels.map(g=>[g,0]))});

      dataTapis.forEach(row=>{
        subjectColumns.forEach(col=>{
          const gred=row[col]?.trim().toUpperCase();
          if(gradeValueMapping.hasOwnProperty(gred)){
            const subjek=col.split(" ")[0];
            if(subjek.toUpperCase()!=="GRED" && subjek!=="G" && subjects.includes(subjek)){
              countsPerSubject[subjek][gred]++;
            }
          }
        });
      });

      const datasets=chartGradeLabels.map(g=>({label:g,data:subjects.map(sub=>countsPerSubject[sub][g]),backgroundColor:gradeColors[g],stack:"s"}));

      if(gradeChartInstance) gradeChartInstance.destroy();
      gradeChartInstance = new Chart(ctx,{
        type:"bar",
        data:{labels:subjects.map(s=>`[${s}]`),datasets},
        options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:"top"}},scales:{x:{stacked:true},y:{stacked:true}}}
      });
    }

    function updateSubjectAnalysis(dataTapis){
      let subjects=[...new Set(subjectColumns.map(c=>c.split(" ")[0]))]
        .filter(s=>s.toUpperCase()!=="GRED" && s!=="G");
      subjects = filterSubjectsByBidang(subjects);

      subjectStatsCurrent = subjects.map(sub=>{
        let counts=Object.fromEntries(chartGradeLabels.map(g=>[g,0]));
        let hadir=0,th=0,totalNilai=0;
        dataTapis.forEach(row=>{
          const col=subjectColumns.find(c=>c.startsWith(sub+" "));
          const gred=row[col]?.toUpperCase();
          if(gradeValueMapping.hasOwnProperty(gred)){counts[gred]++; hadir++; totalNilai+=gradeValueMapping[gred];}
          else if(gred==="TH"){th++;}
        });
        const lulus=hadir-(counts["G"]||0);
        const gagal=(counts["G"]||0);
        const peratusLulus=hadir?((lulus/hadir)*100).toFixed(1):"0.0";
        const peratusGagal=hadir?((gagal/hadir)*100).toFixed(1):"0.0";
        const gpmp=hadir?(totalNilai/hadir).toFixed(2):"--";
        return {sub, counts, hadir, th, peratusLulus, peratusGagal, gpmp};
      });

      subjectStatsOriginal=[...subjectStatsCurrent];
      renderSubjectTable();
    }

    function renderSubjectTable(){
      const body=document.getElementById("analisisSubjekBody"); body.innerHTML="";
      let stats=[...subjectStatsCurrent];

      if(gpmpSortState==="asc"){stats.sort((a,b)=>(parseFloat(a.gpmp)||99)-(parseFloat(b.gpmp)||99));}
      else if(gpmpSortState==="desc"){stats.sort((a,b)=>(parseFloat(b.gpmp)||-1)-(parseFloat(a.gpmp)||-1));}
      else {stats=[...subjectStatsOriginal];}

      stats.forEach(s=>{
        const label=subjectNameMap[s.sub]?`[${s.sub}] - ${subjectNameMap[s.sub]}`:s.sub;
        body.innerHTML += `
          <tr class="text-center">
            <td class="px-2.5 py-2 text-left font-medium">${label}</td>
            <td class="px-2.5 py-2 text-blue-600">${s.hadir}</td>
            <td class="px-2.5 py-2">${s.th}</td>
            ${chartGradeLabels.map(g=>{
              const cls=(g==="A+"||g==="A"||g==="A-")?"bg-green-50":(g==="B+"||g==="B")?"bg-yellow-50":"bg-red-50";
              return `<td class="px-2.5 py-2 ${cls}">${s.counts[g]}</td>`;
            }).join("")}
            <td class="px-2.5 py-2 text-green-600 font-medium">${s.peratusLulus}%</td>
            <td class="px-2.5 py-2 text-red-600 font-medium">${s.peratusGagal}%</td>
            <td class="px-2.5 py-2 text-purple-600 font-bold">${s.gpmp}</td>
          </tr>`;
      });
    }

    // Toggle sort GPMP (subjek)
    document.getElementById("gpmpSortBtn").addEventListener("click",()=>{
      if(gpmpSortState==="none"){gpmpSortState="asc";}
      else if(gpmpSortState==="asc"){gpmpSortState="desc";}
      else {gpmpSortState="none";}
      document.getElementById("gpmpSortBtn").classList.remove("asc","desc");
      if(gpmpSortState!=="none"){document.getElementById("gpmpSortBtn").classList.add(gpmpSortState);}
      renderSubjectTable();
    });

    /* ========= TAB 2: Pecahan Kelas & Senarai Murid ========= */
    function generateSubjectCards(){
      const kelasTerpilih = document.getElementById('kelasFilterMP')?.value || "";
      const subjekCode    = document.getElementById('subjekFilter')?.value || "";

      // sembunyikan kad dahulu
      const cardKelas = document.getElementById('pecahanKelasCard');
      const cardSenarai = document.getElementById('senaraiMuridCard');
      if(cardKelas) cardKelas.classList.add('hidden');
      if(cardSenarai) cardSenarai.classList.add('hidden');
      if(!subjekCode){ return; }

      let data = cachedData || [];
      const kelasHeader = cariKolum("kelas");
      if(kelasTerpilih && kelasTerpilih !== "SEMUA KELAS"){
        data = data.filter(r => (r[kelasHeader]||"") === kelasTerpilih);
      }

      // RESET sort GPMP Kelas
      gpmpKelasSortState = "none";
      document.getElementById('gpmpKelasSortBtn')?.classList.remove('asc','desc');

      renderPecahanKelasTable(data, subjekCode);
      if(cardKelas) cardKelas.classList.remove('hidden');

      // Reset sorting & paging Senarai Murid
      markahSortState = "none"; gredSortState = "none";
      document.getElementById('senaraiMarkahSortBtn').classList.remove('asc','desc');
      document.getElementById('senaraiGredSortBtn').classList.remove('asc','desc');

      renderSenaraiMuridTable(data, subjekCode);
      if(cardSenarai) cardSenarai.classList.remove('hidden');
    }

    function renderPecahanKelasTable(data, subjekCode){
      const kelasHeader = cariKolum("kelas");
      const colGred = cariKolumGredSubjek(subjekCode);
      const body = document.getElementById('pecahanKelasBody');
      body.innerHTML = "";

      if(!colGred){
        body.innerHTML = `<tr><td class="px-3 py-3 text-sm text-red-600" colspan="16">
          Tiada kolum gred ditemui untuk subjek dipilih.</td></tr>`;
        return;
      }

      const kelasSet = new Set();
      data.forEach(r=>{
        const k = (r[kelasHeader]||"").trim();
        if(k && k !== "1") kelasSet.add(k);
      });
      const kelasList = [...kelasSet].sort((a,b)=>a.localeCompare(b,'ms',{numeric:true}));

      const rows = kelasList.map(k=>({
        kelas:k, hadir:0, th:0, totalNilai:0,
        counts: Object.fromEntries(chartGradeLabels.map(g=>[g,0]))
      }));

      const rowMap = Object.fromEntries(rows.map(r=>[r.kelas, r]));
      data.forEach(r=>{
        const k = (r[kelasHeader]||"").trim();
        if(k === "1") return;
        const g = (r[colGred]||"").toUpperCase();
        const row = rowMap[k];
        if(!row) return;
        if(gradeValueMapping.hasOwnProperty(g)){
          row.hadir++; row.counts[g]++; row.totalNilai += gradeValueMapping[g];
        }else if(g==="TH"){ row.th++; }
      });

      rows.forEach(r=> r._gpmp = r.hadir ? (r.totalNilai/r.hadir) : null);

      pecahanKelasRowsOriginal = [...rows];
      pecahanKelasRowsCurrent  = [...rows];

      drawPecahanKelasBody();
    }

    function drawPecahanKelasBody(){
      const body = document.getElementById('pecahanKelasBody');
      body.innerHTML = "";

      let arr = [...pecahanKelasRowsCurrent];
      if(gpmpKelasSortState === "asc"){
        arr.sort((a,b)=>((a._gpmp??99)-(b._gpmp??99)));
      }else if(gpmpKelasSortState === "desc"){
        arr.sort((a,b)=>((b._gpmp??-1)-(a._gpmp??-1)));
      }else{
        arr = [...pecahanKelasRowsOriginal];
      }

      arr.forEach(r=>{
        const lulus = r.hadir - (r.counts["G"]||0);
        const gagal = (r.counts["G"]||0);
        const pLulus = r.hadir ? ((lulus/r.hadir)*100).toFixed(1) : "0.0";
        const pGagal = r.hadir ? ((gagal/r.hadir)*100).toFixed(1) : "0.0";
        const gpmpStr  = (r._gpmp!=null) ? r._gpmp.toFixed(2) : "--";

        body.innerHTML += `
          <tr class="text-gray-800 text-center">
            <td class="px-2.5 py-2 text-left font-medium">${r.kelas}</td>
            <td class="px-2.5 py-2 text-blue-600 font-medium">${r.hadir}</td>
            <td class="px-2.5 py-2">${r.th}</td>
            ${["A+","A","A-","B+","B","C+","C","D","E","G"].map(g=>{
              const cls=(g==="A+"||g==="A"||g==="A-")?"bg-green-50":(g==="B+"||g==="B")?"bg-yellow-50":"bg-red-50";
              return `<td class="px-2.5 py-2 ${cls}">${r.counts[g]||0}</td>`;
            }).join("")}
            <td class="px-2.5 py-2 text-green-600 font-medium">${pLulus}%</td>
            <td class="px-2.5 py-2 text-red-600 font-medium">${pGagal}%</td>
            <td class="px-2.5 py-2 text-purple-600 font-bold">${gpmpStr}</td>
          </tr>`;
      });
    }

    // Toggle sort GPMP Kad Pecahan Kelas
    document.addEventListener('click',(e)=>{
      if(e.target.closest('#gpmpKelasSortBtn')){
        const btn = document.getElementById('gpmpKelasSortBtn');
        if(gpmpKelasSortState==="none"){gpmpKelasSortState="asc";btn.classList.remove('desc');btn.classList.add('asc');}
        else if(gpmpKelasSortState==="asc"){gpmpKelasSortState="desc";btn.classList.remove('asc');btn.classList.add('desc');}
        else {gpmpKelasSortState="none";btn.classList.remove('asc','desc');}
        drawPecahanKelasBody();
      }
    });

    /* ======== Kad Senarai Murid (Tab 2) ======== */
    function renderSenaraiMuridTable(data, subjekCode){
      const namaHeader  = cariKolum("nama");
      const kelasHeader = cariKolum("kelas");
      const colGred     = cariKolumGredSubjek(subjekCode);
      const colMark     = cariKolumMarkahSubjek(subjekCode); // mungkin tiada dalam CSV

      const rows = [];
      data.forEach(r=>{
        const kelas = (r[kelasHeader]||"").trim();
        if(kelas === "1") return; // buang kelas '1'
        const gred  = (r[colGred]||"").toUpperCase();
        if(!gradeValueMapping.hasOwnProperty(gred)) return;
        const markahRaw = colMark ? (r[colMark]||"") : "";
        const markah = markahRaw === "" ? null : Number(markahRaw);
        rows.push({ nama: r[namaHeader]||"", kelas, markah, gred });
      });

      // Simpan & lukis halaman pertama
      senaraiState.rows = rows;
      senaraiState.rowsOriginal = [...rows];
      senaraiState.page = 1;
      drawSenaraiMuridPage();
    }

    // guna sort state -> dapatkan data disusun
    function getSortedSenaraiRows(){
      // Jika sort Markah aktif, keutamaan di sini; jika tidak, lihat sort Gred
      if(markahSortState !== "none"){
        const asc = (markahSortState==="asc");
        return [...senaraiState.rows].sort((a,b)=>{
          const A = (a.markah==null||Number.isNaN(a.markah)) ? (asc?Infinity:-Infinity) : a.markah;
          const B = (b.markah==null||Number.isNaN(b.markah)) ? (asc?Infinity:-Infinity) : b.markah;
          return asc ? (A-B) : (B-A);
        });
      }
      if(gredSortState !== "none"){
        const asc = (gredSortState==="asc");
        return [...senaraiState.rows].sort((a,b)=>{
          const A = gradeValueMapping[a.gred] ?? 999;
          const B = gradeValueMapping[b.gred] ?? 999;
          return asc ? (A-B) : (B-A);
        });
      }
      // Asal
      return [...senaraiState.rowsOriginal];
    }

    function drawSenaraiMuridPage(){
      const body = document.getElementById('senaraiMuridBody');
      const info = document.getElementById('senaraiInfo');
      const label = document.getElementById('senaraiPageLabel');

      body.innerHTML = "";

      const sortedRows = getSortedSenaraiRows();
      const total = sortedRows.length;

      let per = senaraiState.pageSize;
      if(!Number.isFinite(per)) per = total || 1; // jika "Semua"

      const totalPages = Math.max(1, Math.ceil(total/per));
      if(senaraiState.page > totalPages) senaraiState.page = totalPages;

      const start = (senaraiState.page-1)*per;
      const end = Math.min(start+per, total);
      const pageRows = sortedRows.slice(start, end);

      const gradeCls = (g)=>{
        if(["A+","A","A-"].includes(g)) return "text-green-600";
        if(["B+","B"].includes(g))    return "text-yellow-600";
        if(["C+","C"].includes(g))    return "text-orange-500";
        return "text-red-600";
      };

      pageRows.forEach((r,i)=>{
        body.innerHTML += `
          <tr>
            <td class="px-3 py-2 text-center">${start + i + 1}</td>
            <td class="px-3 py-2 text-left">${r.nama}</td>
            <td class="px-3 py-2 text-center">${r.kelas}</td>
            <td class="px-3 py-2 text-center">${(r.markah==null||Number.isNaN(r.markah))? "-" : r.markah}</td>
            <td class="px-3 py-2 text-center ${gradeCls(r.gred)} font-medium">${r.gred}</td>
          </tr>`;
      });

      info.textContent = total
        ? `Menunjukkan ${total ? (start+1) : 0} hingga ${end} daripada ${total} rekod`
        : `Tiada rekod ditemui`;
      label.textContent = `Halaman ${senaraiState.page} daripada ${totalPages}`;

      // enable/disable prev/next
      const prevBtn = document.getElementById('senaraiPrev');
      const nextBtn = document.getElementById('senaraiNext');
      if(senaraiState.page<=1){ prevBtn.classList.add('opacity-50','pointer-events-none','cursor-not-allowed'); }
      else{ prevBtn.classList.remove('opacity-50','pointer-events-none','cursor-not-allowed'); }
      if(senaraiState.page>=totalPages){ nextBtn.classList.add('opacity-50','pointer-events-none','cursor-not-allowed'); }
      else{ nextBtn.classList.remove('opacity-50','pointer-events-none','cursor-not-allowed'); }
    }

    // Page size change (termasuk "Semua")
    document.addEventListener('change',(e)=>{
      if(e.target && e.target.id==='senaraiPageSize'){
        const v = e.target.value;
        senaraiState.pageSize = (v==="ALL") ? Number.POSITIVE_INFINITY : parseInt(v,10);
        senaraiState.page = 1;
        drawSenaraiMuridPage();
      }
    });
    // Prev/Next nav
    document.addEventListener('click',(e)=>{
      if(e.target && e.target.id==='senaraiPrev'){
        if(senaraiState.page>1){ senaraiState.page--; drawSenaraiMuridPage(); }
      }
      if(e.target && e.target.id==='senaraiNext'){
        const total = getSortedSenaraiRows().length;
        let per = senaraiState.pageSize;
        if(!Number.isFinite(per)) per = total || 1;
        const totalPages = Math.max(1, Math.ceil(total/per));
        if(senaraiState.page<totalPages){ senaraiState.page++; drawSenaraiMuridPage(); }
      }
    });

    // ====== 3-laras sort: Markah & Gred ======
    function resetOtherSort(except){
      if(except!=='markah'){ markahSortState='none'; document.getElementById('senaraiMarkahSortBtn').classList.remove('asc','desc'); }
      if(except!=='gred'){ gredSortState='none'; document.getElementById('senaraiGredSortBtn').classList.remove('asc','desc'); }
    }
    document.addEventListener('click',(e)=>{
      if(e.target.closest('#senaraiMarkahSortBtn')){
        const btn = document.getElementById('senaraiMarkahSortBtn');
        // kitaran none -> asc -> desc -> none
        if(markahSortState==='none'){ markahSortState='asc'; btn.classList.add('asc'); btn.classList.remove('desc'); }
        else if(markahSortState==='asc'){ markahSortState='desc'; btn.classList.remove('asc'); btn.classList.add('desc'); }
        else { markahSortState='none'; btn.classList.remove('asc','desc'); }
        resetOtherSort('markah');
        drawSenaraiMuridPage();
      }
      if(e.target.closest('#senaraiGredSortBtn')){
        const btn = document.getElementById('senaraiGredSortBtn');
        if(gredSortState==='none'){ gredSortState='asc'; btn.classList.add('asc'); btn.classList.remove('desc'); }
        else if(gredSortState==='asc'){ gredSortState='desc'; btn.classList.remove('asc'); btn.classList.add('desc'); }
        else { gredSortState='none'; btn.classList.remove('asc','desc'); }
        resetOtherSort('gred');
        drawSenaraiMuridPage();
      }
    });


// ====== TAB 3: Analisis Layak Sijil ======
// ====== TAB 3: Analisis Layak Sijil (selari dengan header 73.0%) ======
// ====== TAB 3: Analisis Layak Sijil ======
function generateEligibilityCards(){
  if(!cachedData) return;

  const kelasHeader = cariKolum("kelas");
  const bmCol  = cariKolumGredSubjek("BM");
  const sejCol = cariKolumGredSubjek("SEJ");

  const kelasTerpilih = document.getElementById("ls-kelasFilter").value;
  const data = (!kelasTerpilih || kelasTerpilih === "SEMUA KELAS")
    ? cachedData
    : cachedData.filter(r => (r[kelasHeader]||"") === kelasTerpilih);

  let layak = 0, jumlah = 0;
  data.forEach(row=>{
    // Pastikan murid ada sekurang-kurangnya 1 gred
    let adaGred = false;
    for(const c of subjectColumns){
      const g = (row[c]||"").toUpperCase();
      if(gradeValueMapping.hasOwnProperty(g)){ adaGred = true; break; }
    }
    if(!adaGred) return;

    jumlah++;
    const bm  = (bmCol  ? row[bmCol]  : "").toUpperCase();
    const sej = (sejCol ? row[sejCol] : "").toUpperCase();

    // Layak = ada BM & SEJ, dan kedua-duanya bukan "G" atau "TH"
    if(bm && sej && bm!=="G" && sej!=="G" && bm!=="TH" && sej!=="TH"){
      layak++;
    }
  });

  const tidak = Math.max(0, jumlah - layak);

  // ========== 1. KAD RINGKASAN ==========
  document.getElementById("countLayak").textContent      = layak;
  document.getElementById("countTidakLayak").textContent = tidak;
  document.getElementById("countJumlah").textContent     = jumlah;
  document.getElementById("percentLayak").textContent    = jumlah ? ((layak/jumlah)*100).toFixed(1)+"%" : "0%";
  document.getElementById("percentTidak").textContent    = jumlah ? ((tidak/jumlah)*100).toFixed(1)+"%" : "0%";
  document.getElementById("kadLayakSection")?.classList.remove("hidden");

  // ========== 2. JADUAL BM & SEJ ==========
  renderBmSejTable(data);
  document.getElementById("jadualBmSej")?.classList.remove("hidden");

  // ========== 3. JADUAL SILANG BM-SEJ ==========
  renderSilangBmSej(data);
  document.getElementById("kadSilangBmSej")?.classList.remove("hidden");

  // ========== 4. SENARAI MURID ==========
  renderSenaraiMuridLayak(data);
  document.getElementById("kadSenaraiLayak")?.classList.remove("hidden");
}


    // ‚úÖ Paparkan Senarai Murid T3
function renderSenaraiMuridLayak(data){
  const namaHeader  = cariKolum("nama");
  const kelasHeader = cariKolum("kelas");
  const bmCol  = cariKolumMarkahSubjek("BM");
  const sejCol = cariKolumMarkahSubjek("SEJ");
  const bmGredCol  = cariKolumGredSubjek("BM");
  const sejGredCol = cariKolumGredSubjek("SEJ");

  const rows = [];
  data.forEach(r=>{
    const nama   = (r[namaHeader] || "").trim();
    const kelas  = (r[kelasHeader] || "").trim();

    // üö´ Skip baris pelik: tiada nama, nama = nombor, atau kelas = "1"
    if(!nama || /^\d+$/.test(nama) || kelas === "1") return;

    const markBM = bmCol  ? (r[bmCol]||"-") : "-";
    const markSEJ= sejCol ? (r[sejCol]||"-") : "-";
    const gredBM = bmGredCol  ? (r[bmGredCol]||"-").toUpperCase() : "-";
    const gredSEJ= sejGredCol ? (r[sejGredCol]||"-").toUpperCase() : "-";

    // Status Layak = BM & SEJ bukan "G" atau "TH"
    let status = "Tidak Layak";
    if(gredBM && gredSEJ && gredBM!=="G" && gredSEJ!=="G" && gredBM!=="TH" && gredSEJ!=="TH"){
      status = "Layak";
    }

    rows.push({nama, kelas, markBM, gredBM, markSEJ, gredSEJ, status});
  });

  layakState.rows = rows;
  layakState.rowsOriginal = [...rows];
  layakState.page = 1;
  drawLayakPage();
}
 
    // Fungsi global
function renderSilangBmSej(data){
  const bmCol = cariKolumGredSubjek("BM");
  const sejCol = cariKolumGredSubjek("SEJ");
  if(!bmCol || !sejCol) return;

  const counts = {
    bmLulus:{sejLulus:0, sejGagal:0, sejTH:0},
    bmGagal:{sejLulus:0, sejGagal:0, sejTH:0},
    bmTH:{sejLulus:0, sejGagal:0, sejTH:0},
  };

  let total=0;

  data.forEach(r=>{
    const bm=(r[bmCol]||"").toUpperCase();
    const sej=(r[sejCol]||"").toUpperCase();

    let bmCat = bm==="G" ? "bmGagal" : bm==="TH" ? "bmTH" : "bmLulus";
    let sejCat = sej==="G" ? "sejGagal" : sej==="TH" ? "sejTH" : "sejLulus";

    counts[bmCat][sejCat]++;
    total++;
  });

  const body=document.getElementById("silangBmSejBody");
  body.innerHTML="";

  function row(label, c){
    const rowTotal=c.sejLulus+c.sejGagal+c.sejTH;
    return `
      <tr class="text-center">
        <td class="px-3 py-2 text-left font-medium">${label}</td>
        <td class="px-3 py-2 text-green-600">${c.sejLulus} (${((c.sejLulus/total)*100).toFixed(1)}%)</td>
        <td class="px-3 py-2 text-red-600">${c.sejGagal} (${((c.sejGagal/total)*100).toFixed(1)}%)</td>
        <td class="px-3 py-2">${c.sejTH} (${((c.sejTH/total)*100).toFixed(1)}%)</td>
        <td class="px-3 py-2 font-bold text-blue-600 bg-yellow-50">${rowTotal} (${((rowTotal/total)*100).toFixed(1)}%)</td>
      </tr>`;
  }

  body.innerHTML += row("BM Lulus", counts.bmLulus);
  body.innerHTML += row("BM Gagal", counts.bmGagal);
  body.innerHTML += row("BM TH", counts.bmTH);

  // Jumlah keseluruhan
  const jLulus = counts.bmLulus.sejLulus+counts.bmGagal.sejLulus+counts.bmTH.sejLulus;
  const jGagal = counts.bmLulus.sejGagal+counts.bmGagal.sejGagal+counts.bmTH.sejGagal;
  const jTH    = counts.bmLulus.sejTH+counts.bmGagal.sejTH+counts.bmTH.sejTH;

  body.innerHTML += `
    <tr class="font-bold bg-yellow-100 text-center">
      <td class="px-3 py-2 text-left">Jumlah</td>
      <td class="px-3 py-2 text-green-600">${jLulus} (${((jLulus/total)*100).toFixed(1)}%)</td>
      <td class="px-3 py-2 text-red-600">${jGagal} (${((jGagal/total)*100).toFixed(1)}%)</td>
      <td class="px-3 py-2">${jTH} (${((jTH/total)*100).toFixed(1)}%)</td>
      <td class="px-3 py-2 text-blue-600">${total} (100.0%)</td>
    </tr>`;
}


    
// Render jadual BM & SEJ
function renderBmSejTable(data){
  const body = document.getElementById("bmSejBody");
  body.innerHTML = "";

  ["BM","SEJ"].forEach(subjek=>{
    const colGred = cariKolumGredSubjek(subjek);
    if(!colGred){
      body.innerHTML += `<tr><td colspan="16" class="px-3 py-2 text-center text-red-600">
        Tiada data ${subjek} ditemui.</td></tr>`;
      return;
    }

    const counts = Object.fromEntries(chartGradeLabels.map(g=>[g,0]));
    let hadir=0, th=0, totalNilai=0;

    data.forEach(r=>{
      const g = (r[colGred]||"").toUpperCase();
      if(gradeValueMapping.hasOwnProperty(g)){
        counts[g]++; hadir++; totalNilai += gradeValueMapping[g];
      }else if(g==="TH"){ th++; }
    });

    const lulus = hadir - (counts["G"]||0);
    const gagal = counts["G"]||0;
    const pLulus = hadir ? ((lulus/hadir)*100).toFixed(1) : "0.0";
    const pGagal = hadir ? ((gagal/hadir)*100).toFixed(1) : "0.0";
    const gpmp   = hadir ? (totalNilai/hadir).toFixed(2) : "--";

    body.innerHTML += `
      <tr class="text-center">
        <td class="px-3 py-2 font-medium text-left">
          ${subjectNameMap[subjek] || subjek}
        </td>
        <td class="px-3 py-2 text-blue-600">${hadir}</td>
        <td class="px-3 py-2">${th}</td>
        ${chartGradeLabels.map(g=>{
          const cls=(["A+","A","A-"].includes(g))?"bg-green-50":
                    (["B+","B"].includes(g))?"bg-yellow-50":"bg-red-50";
          return `<td class="px-3 py-2 ${cls}">${counts[g]}</td>`;
        }).join("")}
        <td class="px-3 py-2 text-green-600 font-medium">${pLulus}%</td>
        <td class="px-3 py-2 text-red-600 font-medium">${pGagal}%</td>
        <td class="px-3 py-2 text-purple-600 font-bold">${gpmp}</td>
      </tr>`;
  });
}

// ====== Senarai Murid Layak Sijil (Tab 3) ======
const layakState = { rows: [], rowsOriginal: [], page: 1, pageSize: 5 };
let layakBmMarkahSortState = "none"; 
let layakSejMarkahSortState = "none";
let layakStatusSortState   = "none";



function getSortedLayakRows(){
  let rows = [...layakState.rows];

  if(layakBmMarkahSortState !== "none"){
    const asc = (layakBmMarkahSortState==="asc");
    return rows.sort((a,b)=>{
      const A = a.markBM==="-"? (asc?Infinity:-Infinity) : Number(a.markBM);
      const B = b.markBM==="-"? (asc?Infinity:-Infinity) : Number(b.markBM);
      return asc ? A-B : B-A;
    });
  }
  if(layakSejMarkahSortState !== "none"){
    const asc = (layakSejMarkahSortState==="asc");
    return rows.sort((a,b)=>{
      const A = a.markSEJ==="-"? (asc?Infinity:-Infinity) : Number(a.markSEJ);
      const B = b.markSEJ==="-"? (asc?Infinity:-Infinity) : Number(b.markSEJ);
      return asc ? A-B : B-A;
    });
  }
  if(layakStatusSortState !== "none"){
    const asc = (layakStatusSortState==="asc");
    return rows.sort((a,b)=> asc ? a.status.localeCompare(b.status) : b.status.localeCompare(a.status));
  }
  return rows; // asal
}

function drawLayakPage(){
  const body  = document.getElementById("senaraiLayakBody");
  const info  = document.getElementById("layakInfo");
  const label = document.getElementById("layakPageLabel");
  body.innerHTML = "";

  const sortedRows = getSortedLayakRows();
  const total = sortedRows.length;
  let per = layakState.pageSize;
  if(!Number.isFinite(per)) per = total || 1;

  const totalPages = Math.max(1, Math.ceil(total/per));
  if(layakState.page > totalPages) layakState.page = totalPages;

  const start = (layakState.page-1)*per;
  const end   = Math.min(start+per, total);
  const pageRows = sortedRows.slice(start,end);

  pageRows.forEach((m,i)=>{
    const statusHtml = m.status==="Layak"
      ? `<span class="text-green-600 font-medium">‚úî Layak</span>`
      : `<span class="text-red-600 font-medium">‚úò Tidak Layak</span>`;

    body.innerHTML += `
      <tr>
        <td class="px-3 py-2 text-center">${start+i+1}</td>
        <td class="px-3 py-2 text-left">${m.nama}</td>
        <td class="px-3 py-2 text-center">${m.kelas}</td>
        <td class="px-3 py-2 text-center">${m.markBM}</td>
        <td class="px-3 py-2 text-center">${m.gredBM}</td>
        <td class="px-3 py-2 text-center">${m.markSEJ}</td>
        <td class="px-3 py-2 text-center">${m.gredSEJ}</td>
        <td class="px-3 py-2 text-center">${statusHtml}</td>
      </tr>`;
  });

  info.textContent = total
    ? `Menunjukkan ${start+1} hingga ${end} daripada ${total} rekod`
    : `Tiada rekod ditemui`;
  label.textContent = `Halaman ${layakState.page} daripada ${totalPages}`;

  document.getElementById("layakPrev").disabled = (layakState.page<=1);
  document.getElementById("layakNext").disabled = (layakState.page>=totalPages);
}

// Tukar page size
document.addEventListener("change",(e)=>{
  if(e.target.id==="layakPageSize"){
    const v = e.target.value;
    layakState.pageSize = (v==="ALL") ? Number.POSITIVE_INFINITY : parseInt(v,10);
    layakState.page = 1;
    drawLayakPage();
  }
});

// Prev/Next
document.addEventListener("click",(e)=>{
  if(e.target.id==="layakPrev" && layakState.page>1){
    layakState.page--; drawLayakPage();
  }
  if(e.target.id==="layakNext"){
    const total = layakState.rows.length;
    let per = layakState.pageSize;
    if(!Number.isFinite(per)) per = total||1;
    const totalPages = Math.max(1,Math.ceil(total/per));
    if(layakState.page<totalPages){ layakState.page++; drawLayakPage(); }
  }
});

// ====== 3-laras sort (BM, SEJ, Status) ======
function resetLayakSort(except){
  if(except!=="bm"){
    layakBmMarkahSortState="none";
    document.getElementById("layakBmMarkahSortBtn").classList.remove("asc","desc");
  }
  if(except!=="sej"){
    layakSejMarkahSortState="none";
    document.getElementById("layakSejMarkahSortBtn").classList.remove("asc","desc");
  }
  if(except!=="status"){
    layakStatusSortState="none";
    document.getElementById("layakStatusSortBtn").classList.remove("asc","desc");
  }
}

document.addEventListener("click",(e)=>{
  if(e.target.closest("#layakBmMarkahSortBtn")){
    const btn = document.getElementById("layakBmMarkahSortBtn");
    if(layakBmMarkahSortState==="none"){ layakBmMarkahSortState="asc"; btn.classList.add("asc"); }
    else if(layakBmMarkahSortState==="asc"){ layakBmMarkahSortState="desc"; btn.classList.remove("asc"); btn.classList.add("desc"); }
    else { layakBmMarkahSortState="none"; btn.classList.remove("asc","desc"); }
    resetLayakSort("bm"); drawLayakPage();
  }
  if(e.target.closest("#layakSejMarkahSortBtn")){
    const btn = document.getElementById("layakSejMarkahSortBtn");
    if(layakSejMarkahSortState==="none"){ layakSejMarkahSortState="asc"; btn.classList.add("asc"); }
    else if(layakSejMarkahSortState==="asc"){ layakSejMarkahSortState="desc"; btn.classList.remove("asc"); btn.classList.add("desc"); }
    else { layakSejMarkahSortState="none"; btn.classList.remove("asc","desc"); }
    resetLayakSort("sej"); drawLayakPage();
  }
  if(e.target.closest("#layakStatusSortBtn")){
    const btn = document.getElementById("layakStatusSortBtn");
    if(layakStatusSortState==="none"){ layakStatusSortState="asc"; btn.classList.add("asc"); }
    else if(layakStatusSortState==="asc"){ layakStatusSortState="desc"; btn.classList.remove("asc"); btn.classList.add("desc"); }
    else { layakStatusSortState="none"; btn.classList.remove("asc","desc"); }
    resetLayakSort("status"); drawLayakPage();
  }
});


// Prev/Next
document.addEventListener("click",(e)=>{
  if(e.target.id==="layakPrev" && layakState.page>1){
    layakState.page--; drawLayakPage();
  }
  if(e.target.id==="layakNext"){
    const total = layakState.rows.length;
    let per = layakState.pageSize;
    if(!Number.isFinite(per)) per = total||1;
    const totalPages = Math.max(1,Math.ceil(total/per));
    if(layakState.page<totalPages){ layakState.page++; drawLayakPage(); }
  }
});

    //TUTUP KEJAP TERAPUNG
    // Paparkan seksyen jadual BM & SEJ
//renderBmSejTable(data);
//document.getElementById("jadualBmSej")?.classList.remove("hidden");

    // ‚úÖ Paparkan Senarai Murid T3
  //renderSenaraiMuridLayak(data);
  //document.getElementById("kadSenaraiLayak")?.classList.remove("hidden");


    // ‚úÖ Fungsi Combat Zone - Tab 4
function generateCombatZone(){
  if(!cachedData) return;

  // reset simpanan
  muridDataCZ = [];   

  const kelasHeader    = cariKolum("kelas");
  const namaHeader     = cariKolum("nama");
  const kelasTerpilih  = document.getElementById("cz-kelasFilter").value;
  const subjekTerpilih = document.getElementById("cz-subjekFilter").value;

  // ==================== Loop murid dari CSV ====================
  cachedData.forEach(row=>{
    const kelas = (row[kelasHeader]||"").trim();
    const nama  = (row[namaHeader]||"").trim();
    if(!nama || /^\d+$/.test(nama)) return;

    if(kelasTerpilih && kelasTerpilih !== "SEMUA KELAS" && kelas !== kelasTerpilih) return;

    let gredList = [];
    subjectColumns.forEach(c=>{
      if(subjekTerpilih && !c.startsWith(subjekTerpilih+" ")) return;
      const g = (row[c]||"").toUpperCase();
      if(gradeValueMapping.hasOwnProperty(g)) gredList.push(g);
    });

    if(!gredList.length) return;

    const countA = gredList.filter(g=>["A+","A","A-"].includes(g)).length;
    const countG = gredList.filter(g=>g==="G").length;

    let kategoriKey = "";
    if(countA >= 5){ kategoriKey = "k1"; }
    else if(countA >= 3){ kategoriKey = "k2"; }
    else if(countA === 0 && countG === 0){ kategoriKey = "p1"; }
    else if(countG > 0 && countG <= 2){ kategoriKey = "p2"; }
    else if(countG >= 3){ kategoriKey = "q"; }

    // kira GP
    const sum = gredList.reduce((a,g)=>a+gradeValueMapping[g],0);
    const gp = (sum / gredList.length).toFixed(2);

    // simpan dalam array global
    muridDataCZ.push({ nama, kelas, gp, kategori: kategoriKey });
  });

  // ==================== Kemas kini angka pada butang kategori ====================
  const countMap = { kualiti1:"k1", kualiti2:"k2", pertahanan1:"p1", pertahanan2:"p2", kuantiti:"q" };
  Object.keys(countMap).forEach(kat=>{
    const key = countMap[kat];
    const el = document.getElementById(kat+"TabCount");
    if(el){
      el.textContent = muridDataCZ.filter(m=>m.kategori===key).length;
    }
  });

  // ==================== Jadual Pecahan Mengikut Kelas ====================
  const byClass = {};
  muridDataCZ.forEach(m=>{
    if(!byClass[m.kelas]){
      byClass[m.kelas] = { jumlah:0, k1:0, k2:0, p1:0, p2:0, q:0 };
    }
    byClass[m.kelas].jumlah++;
    byClass[m.kelas][m.kategori]++;
  });

  const tbody = document.getElementById("combatZoneClassBreakdownTable");
  if(tbody){
    tbody.innerHTML = "";
    Object.keys(byClass).sort().forEach(kelas=>{
      const d = byClass[kelas];
      tbody.innerHTML += `
        <tr>
          <td class="px-4 py-2 font-medium">${kelas}</td>
          <td class="px-4 py-2 text-center">${d.jumlah}</td>
          <td class="px-4 py-2 text-center">${d.k1}</td>
          <td class="px-4 py-2 text-center">${d.k2}</td>
          <td class="px-4 py-2 text-center">${d.p1}</td>
          <td class="px-4 py-2 text-center">${d.p2}</td>
          <td class="px-4 py-2 text-center">${d.q}</td>
        </tr>`;
    });

    // Grand Total
    const totals = {
      jumlah: muridDataCZ.length,
      k1: muridDataCZ.filter(m=>m.kategori==="k1").length,
      k2: muridDataCZ.filter(m=>m.kategori==="k2").length,
      p1: muridDataCZ.filter(m=>m.kategori==="p1").length,
      p2: muridDataCZ.filter(m=>m.kategori==="p2").length,
      q:  muridDataCZ.filter(m=>m.kategori==="q").length
    };

    tbody.innerHTML += `
      <tr class="bg-gray-100 font-bold">
        <td class="px-4 py-2">Grand Total</td>
        <td class="px-4 py-2 text-center">${totals.jumlah}</td>
        <td class="px-4 py-2 text-center">${totals.k1}</td>
        <td class="px-4 py-2 text-center">${totals.k2}</td>
        <td class="px-4 py-2 text-center">${totals.p1}</td>
        <td class="px-4 py-2 text-center">${totals.p2}</td>
        <td class="px-4 py-2 text-center">${totals.q}</td>
      </tr>`;
    
    // ==================== Kad Ringkasan ====================
    document.getElementById("countJumlahCZ").textContent = totals.jumlah;

    const kategoriMap = {
      k1: ["countKualiti1","percentKualiti1"],
      k2: ["countKualiti2","percentKualiti2"],
      p1: ["countPertahanan1","percentPertahanan1"],
      p2: ["countPertahanan2","percentPertahanan2"],
      q:  ["countKuantiti","percentKuantiti"]
    };

    Object.keys(kategoriMap).forEach(k=>{
      const [idCount,idPercent] = kategoriMap[k];
      const count = totals[k];
      const percent = totals.jumlah ? ((count/totals.jumlah)*100).toFixed(1)+"%" : "0%";
      document.getElementById(idCount).textContent = count;
      document.getElementById(idPercent).textContent = percent;
    });
  }

  // ‚úÖ Akhir sekali, papar kategori default
  switchCombatZoneCategory("kualiti1");
}




  // di sini cikgu boleh terus update Kad ringkasan / Jadual Pecahan ikut kelas


function switchCombatZoneCategory(kat){
  const keyMap = {
    kualiti1: "k1",
    kualiti2: "k2",
    pertahanan1: "p1",
    pertahanan2: "p2",
    kuantiti: "q"
  };
  const key = keyMap[kat];

  // ‚úÖ Tukar gaya butang aktif
  ['kualiti1','kualiti2','pertahanan1','pertahanan2','kuantiti'].forEach(id=>{
    const btn = document.getElementById("combatZoneTab-"+id);
    if(!btn) return;
    if(id===kat){
      btn.classList.add("bg-blue-600","text-white","font-semibold");
      btn.classList.remove("bg-gray-200","text-gray-700");
    }else{
      btn.classList.remove("bg-blue-600","text-white","font-semibold");
      btn.classList.add("bg-gray-200","text-gray-700");
    }
  });

  // Dapatkan senarai murid kategori ini
  const tbody = document.getElementById("combatZoneCategoryStudentTable");
  tbody.innerHTML = "";

  const list = muridDataCZ.filter(m=>m.kategori===key);

  if(list.length===0){
    tbody.innerHTML = `<tr>
      <td colspan="4" class="p-4 text-gray-400 text-center">Tiada data</td>
    </tr>`;
    return;
  }

  // Susun ikut GP (rendah ‚Üí tinggi)
  list.sort((a,b)=>parseFloat(a.gp)-parseFloat(b.gp));

  // Isi jadual
  list.forEach((m,i)=>{
    tbody.innerHTML += `
      <tr class="border-b">
        <td class="px-4 py-2">${i+1}</td>
        <td class="px-4 py-2 text-left">${m.nama}</td>
        <td class="px-4 py-2 text-center">${m.kelas}</td>
        <td class="px-4 py-2 text-center">${m.gp}</td>
      </tr>`;
  });
}



  // ‚úÖ Update Kad Ringkasan
  function updateCard(idCount, idPercent, val){
    document.getElementById(idCount).textContent = val;
    document.getElementById(idPercent).textContent = jumlah ? ((val/jumlah)*100).toFixed(1)+"%" : "0%";
  }
  updateCard("countKualiti1","percentKualiti1",kualiti1);
  updateCard("countKualiti2","percentKualiti2",kualiti2);
  updateCard("countPertahanan1","percentPertahanan1",pertahanan1);
  updateCard("countPertahanan2","percentPertahanan2",pertahanan2);
  updateCard("countKuantiti","percentKuantiti",kuantiti);
  document.getElementById("countJumlahCZ").textContent = jumlah;

  // ‚úÖ Hasilkan jadual pecahan mengikut kelas (ikut kelas & subjek dipilih)
  renderCombatZoneClassBreakdown(data, subjekTerpilih, kelasTerpilih);

  // ‚úÖ Paparkan Kad Combat Zone
  document.getElementById("kadCombatZoneSection")?.classList.remove("hidden");



function renderCombatZoneClassBreakdown(data, subjekTerpilih, kelasTerpilih) {
  const kelasHeader = cariKolum("kelas");
  const namaHeader  = cariKolum("nama");

  const byClass = {};
  let grandTotal = { jumlah:0, k1:0, k2:0, p1:0, p2:0, q:0 };

  data.forEach(row => {
    const kelas = (row[kelasHeader]||"").trim();
    const nama  = (row[namaHeader]||"").trim();
    if(!kelas || !nama || /^\d+$/.test(nama)) return;

    if(!byClass[kelas]){
      byClass[kelas] = { jumlah:0, k1:0, k2:0, p1:0, p2:0, q:0 };
    }

    let gredList = [];
    subjectColumns.forEach(c=>{
      if(subjekTerpilih && !c.startsWith(subjekTerpilih+" ")) return;
      const g = (row[c]||"").toUpperCase();
      if(gradeValueMapping.hasOwnProperty(g)) gredList.push(g);
    });

    if(!gredList.length) return;
    byClass[kelas].jumlah++;
    grandTotal.jumlah++;

    const countA = gredList.filter(g=>["A+","A","A-"].includes(g)).length;
    const countG = gredList.filter(g=>g==="G").length;

    if(countA >= 5){
      byClass[kelas].k1++; grandTotal.k1++;
    }else if(countA >= 3){
      byClass[kelas].k2++; grandTotal.k2++;
    }else if(countA === 0 && countG === 0){
      byClass[kelas].p1++; grandTotal.p1++;
    }else if(countG > 0 && countG <= 2){
      byClass[kelas].p2++; grandTotal.p2++;
    }else if(countG >= 3){
      byClass[kelas].q++; grandTotal.q++;
    }
  });

  // Paparkan dalam jadual
  const tbody = document.getElementById("combatZoneClassBreakdownTable");
  tbody.innerHTML = "";

  // ‚úÖ Senarai kelas ikut keadaan
  let kelasList = Object.keys(byClass).sort();

  // Jika pilih kelas tertentu ‚Üí hanya papar kelas itu
  if(kelasTerpilih && kelasTerpilih !== "SEMUA KELAS"){
    kelasList = kelasList.filter(k => k === kelasTerpilih);
  }

  // Jika pilih subjek ‚Üí hanya kelas yang ada murid ambil subjek (jumlah > 0)
  if(subjekTerpilih && subjekTerpilih !== "SEMUA SUBJEK"){
    kelasList = kelasList.filter(k => byClass[k].jumlah > 0);
  }

  kelasList.forEach(kelas=>{
    const d = byClass[kelas];
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td class="px-4 py-2 text-left font-medium">${kelas}</td>
      <td class="px-4 py-2 text-center">${d.jumlah}</td>
      <td class="px-4 py-2 text-center">${d.k1}</td>
      <td class="px-4 py-2 text-center">${d.k2}</td>
      <td class="px-4 py-2 text-center">${d.p1}</td>
      <td class="px-4 py-2 text-center">${d.p2}</td>
      <td class="px-4 py-2 text-center">${d.q}</td>
    `;
    tbody.appendChild(tr);
  });

  // ‚úÖ Tambah baris Grand Total (hanya kalau ada data)
  if(kelasList.length > 0){
    const trTotal = document.createElement("tr");
    trTotal.classList.add("bg-gray-100", "font-bold");
    trTotal.innerHTML = `
      <td class="px-4 py-2 text-left">Jumlah Besar</td>
      <td class="px-4 py-2 text-center">${grandTotal.jumlah}</td>
      <td class="px-4 py-2 text-center">${grandTotal.k1}</td>
      <td class="px-4 py-2 text-center">${grandTotal.k2}</td>
      <td class="px-4 py-2 text-center">${grandTotal.p1}</td>
      <td class="px-4 py-2 text-center">${grandTotal.p2}</td>
      <td class="px-4 py-2 text-center">${grandTotal.q}</td>
    `;
    tbody.appendChild(trTotal);
  }

  document.getElementById("combatZoneClassBreakdownSection")?.classList.remove("hidden");
}


    // ================== (TAMAT SCRIPT) ==================
  </script>
</body>
</html>

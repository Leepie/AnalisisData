<!DOCTYPE html>
<html lang="ms">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Analisis Subjek — Dashboard Ringkas</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    /* Header jadual ringkas (reuse gaya simple dari permintaan terdahulu) */
    .card { border-radius: 14px; box-shadow: 0 1px 0 rgba(17,24,39,.04); }
    .kpi h3 { font-size: .85rem; color:#374151 }
    .kpi p { font-size: 1.6rem; font-weight: 800; }
    .muted { color:#6b7280 }
    /* Baris jumlah gred bawah carta */
    .totals-row th, .totals-row td { padding:.6rem; border-top:1px solid #e5e7eb; }
  </style>
</head>
<body class="bg-gray-50 text-gray-800">

  <!-- Header ringkas -->
  <header class="bg-white shadow p-4 flex items-center justify-between">
    <div class="flex items-center gap-3">
      <img src="https://upload.wikimedia.org/wikipedia/ms/b/ba/Sekolah_Menengah_Kebangsaan_Dato%27_Kamaruddin.jpg"
           alt="Logo Sekolah" class="w-10 h-10 rounded-full border" />
      <div>
        <h1 class="text-xl font-bold">Analisis Subjek</h1>
        <p class="text-xs text-gray-600">Sistem Analisis Prestasi Akademik — <span class="text-blue-600 font-medium">SMK Dato' Kamaruddin</span></p>
      </div>
    </div>
  </header>

  <main class="max-w-7xl mx-auto p-4 sm:p-6 space-y-6">

    <!-- Penapis -->
    <section class="bg-white card p-4 sm:p-5">
      <div class="grid sm:grid-cols-3 gap-3 items-end">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Pilihan Kelas</label>
          <select id="kelasSelect" class="w-full border rounded-lg px-3 py-2 text-sm">
            <option value="">KESELURUHAN</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Pilihan Subjek</label>
          <select id="subjekSelect" class="w-full border rounded-lg px-3 py-2 text-sm"></select>
        </div>
        <div>
          <button id="btnJana" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-xl py-2.5">
            Jana Analisis
          </button>
        </div>
      </div>
    </section>

    <!-- KPI -->
    <section class="grid md:grid-cols-2 gap-4">
      <div class="bg-white card p-4 sm:p-5">
        <div class="border-b pb-2 font-semibold text-gray-700">Keputusan Matapelajaran</div>
        <div class="grid grid-cols-3 gap-3 pt-3">
          <div class="kpi"><h3>Jumlah Lulus</h3><p id="kpiLulus">--</p></div>
          <div class="kpi"><h3>Jumlah Gagal</h3><p id="kpiGagal">--</p></div>
          <div class="kpi"><h3>% Lulus</h3><p id="kpiPeratus">--%</p></div>
        </div>
        <div class="mt-4 grid grid-cols-4 items-center">
          <div class="col-span-3 px-3 py-2 rounded bg-purple-50 text-purple-800 font-semibold">GRED PURATA</div>
          <div class="text-right text-2xl font-extrabold" id="kpiGP">--</div>
        </div>
      </div>

      <div class="bg-white card p-4 sm:p-5">
        <div class="border-b pb-2 font-semibold text-gray-700">Bilangan Pelajar</div>
        <div class="grid grid-cols-3 gap-3 pt-3">
          <div class="kpi"><h3>Jumlah Calon</h3><p id="kpiCalon">--</p></div>
          <div class="kpi"><h3>Jumlah Hadir</h3><p id="kpiHadir">--</p></div>
          <div class="kpi"><h3>% Hadir</h3><p id="kpiPHadir">--%</p></div>
        </div>
      </div>
    </section>

    <!-- Donut -->
    <section class="grid md:grid-cols-2 gap-4">
      <div class="bg-white card p-4 sm:p-5">
        <div class="font-semibold text-gray-700 mb-3">Lulus vs Gagal</div>
        <canvas id="donutLulus" height="220"></canvas>
        <div class="text-xs muted mt-2">LULUS / GAGAL (% daripada hadir)</div>
      </div>
      <div class="bg-white card p-4 sm:p-5">
        <div class="font-semibold text-gray-700 mb-3">Kehadiran</div>
        <canvas id="donutHadir" height="220"></canvas>
        <div class="text-xs muted mt-2">HADIR / TH (% daripada calon)</div>
      </div>
    </section>

    <!-- Carta bar & jadual jumlah -->
    <section class="bg-white card p-4 sm:p-5">
      <div class="text-center font-semibold text-purple-700 mb-2">JUMLAH GRED</div>
      <canvas id="barGred" height="320"></canvas>
      <div class="overflow-x-auto">
        <table class="w-full text-sm mt-3">
          <thead class="totals-row bg-purple-50 text-gray-700">
            <tr>
              <th class="text-left">Gred</th>
              <th>A+</th><th>A</th><th>A-</th><th>B+</th><th>B</th>
              <th>C+</th><th>C</th><th>D</th><th>E</th><th>G</th><th>TH</th>
            </tr>
          </thead>
          <tbody class="totals-row">
            <tr>
              <td class="text-left">Jumlah</td>
              <td id="tAplus">0</td><td id="tA">0</td><td id="tAminus">0</td><td id="tBplus">0</td><td id="tB">0</td>
              <td id="tCplus">0</td><td id="tC">0</td><td id="tD">0</td><td id="tE">0</td><td id="tG">0</td><td id="tTH">0</td>
            </tr>
          </tbody>
        </table>
      </div>
    </section>

  </main>

  <script>
    // ==== KONFIGURASI CSV ====
    const csvUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTYrHZLkbHUM-5jja039uj6kW8gImj4V3pdg253c8C8wZfjVPusU2XT_0M9qjA6kq-X1wiFI4z2FIDq/pub?gid=22937657&single=true&output=csv";

    // ==== PEMETAAN GRED ====
    const GRADE_MAP = {"A+":0,"A":1,"A-":2,"B+":3,"B":4,"C+":5,"C":6,"D":7,"E":8,"G":9};
    const GRADE_LABELS = ["A+","A","A-","B+","B","C+","C","D","E","G","TH"];

    // ==== DATA GLOBAL ====
    let parsedData = [], headerMap = {}, subjectColumns = [];
    let donut1=null, donut2=null, bar1=null;

    // ==== UTIL CSV ====
    function parseCSV(csv){
      const lines = csv.trim().split('\n');
      const lineSubjek = lines[1].split(',').map(s=>s.trim());
      const lineJenis  = lines[2].split(',').map(s=>s.trim());
      let cur=""; const headers = lineSubjek.map((s,i)=>{ if(s) cur=s; return lineJenis[i]?`${cur} ${lineJenis[i]}`.trim():cur; });
      headers.forEach(h=> headerMap[h.toLowerCase()] = h);
      subjectColumns = headers.filter(h => /\b(G|GRED|GRADE)\b/i.test(h));
      return lines.slice(3).map(row=>{
        const v=row.split(','); const obj={}; headers.forEach((h,i)=>obj[h]= (v[i]??"").trim()); return obj;
      });
    }
    const getHeader = k => Object.values(headerMap).find(h=>h.toLowerCase().includes(k)) || "";

    // ==== POPULATE DROPDOWN ====
    function populateDropdowns(){
      const kelasH = getHeader("kelas");
      const kelasSel = document.getElementById("kelasSelect");
      const kelasSet = new Set(parsedData.map(r=>r[kelasH]?.trim()).filter(x=>x && x.toUpperCase()!=="KESELURUHAN"));
      [...kelasSet].sort((a,b)=>a.localeCompare(b,'ms',{numeric:true})).forEach(k=>{
        const opt = document.createElement('option'); opt.value=k; opt.textContent=k; kelasSel.appendChild(opt);
      });

      const subjects = [...new Set(subjectColumns.map(c=>c.split(" ")[0]))]
        .filter(s=>s.toUpperCase()!=="GRED" && s!=="G")
        .sort((a,b)=>a.localeCompare(b,'ms',{numeric:true}));
      const subSel = document.getElementById("subjekSelect");
      subjects.forEach(s=>{ const o=document.createElement('option'); o.value=s; o.textContent=s; subSel.appendChild(o); });
    }

    // ==== KIRAAN MENGIKUT PILIHAN ====
    function computeForSelection(){
      const kelasH = getHeader("kelas");
      const subjek = document.getElementById("subjekSelect").value;
      const kelas  = document.getElementById("kelasSelect").value;
      const col = subjectColumns.find(c=>c.startsWith(subjek+" "));
      if(!col){ return null; }

      const rows = (!kelas ? parsedData : parsedData.filter(r=>r[kelasH]===kelas));
      const totals = { "A+":0,"A":0,"A-":0,"B+":0,"B":0,"C+":0,"C":0,"D":0,"E":0,"G":0,"TH":0 };

      let calon = rows.length;
      let hadir = 0, sumGP = 0, lulus = 0, gagal = 0;

      rows.forEach(r=>{
        const g = (r[col]||"").toUpperCase();
        if(g==="TH"){ totals["TH"]++; return; } // tidak hadir
        if(GRADE_MAP.hasOwnProperty(g)){
          totals[g]++; hadir++;
          sumGP += GRADE_MAP[g];
          if(g==="G") gagal++; else lulus++;
        }
      });

      const gp = hadir ? (sumGP/hadir).toFixed(2) : "--";
      const pLulus = hadir ? ((lulus/hadir)*100).toFixed(2) : "0.00";
      const pHadir = calon ? ((hadir/calon)*100).toFixed(2) : "0.00";

      return {subjek, kelas, calon, hadir, lulus, gagal, gp, pLulus, pHadir, totals};
    }

    // ==== RENDER UI ====
    function renderKPI(stats){
      document.getElementById('kpiLulus').textContent = stats.lulus;
      document.getElementById('kpiGagal').textContent = stats.gagal;
      document.getElementById('kpiPeratus').textContent = `${stats.pLulus}%`;
      document.getElementById('kpiGP').textContent = stats.gp;
      document.getElementById('kpiCalon').textContent = stats.calon;
      document.getElementById('kpiHadir').textContent = stats.hadir;
      document.getElementById('kpiPHadir').textContent = `${stats.pHadir}%`;
    }

    function renderDonuts(stats){
      const ctx1 = document.getElementById('donutLulus').getContext('2d');
      const ctx2 = document.getElementById('donutHadir').getContext('2d');
      if(donut1) donut1.destroy(); if(donut2) donut2.destroy();

      donut1 = new Chart(ctx1,{
        type:'doughnut',
        data:{ labels:['LULUS','GAGAL'],
               datasets:[{ data:[stats.lulus, stats.gagal] }] },
        options:{ plugins:{ legend:{ position:'bottom' }}, cutout:'55%' }
      });

      donut2 = new Chart(ctx2,{
        type:'doughnut',
        data:{ labels:['HADIR','TH'], datasets:[{ data:[stats.hadir, stats.calon - stats.hadir] }] },
        options:{ plugins:{ legend:{ position:'bottom' }}, cutout:'55%' }
      });
    }

    function renderBar(stats){
      const ctx = document.getElementById('barGred').getContext('2d');
      if(bar1) bar1.destroy();
      const dataSeq = ["A+","A","A-","B+","B","C+","C","D","E","G","TH"].map(k=>stats.totals[k]);

      bar1 = new Chart(ctx,{
        type:'bar',
        data:{ labels: GRADE_LABELS, datasets:[{ label:'Bil.', data: dataSeq }] },
        options:{
          plugins:{ legend:{ display:false } },
          scales:{ x:{ ticks:{ maxRotation:0, minRotation:0 } }, y:{ beginAtZero:true, precision:0 } }
        }
      });

      // update baris jumlah
      document.getElementById('tAplus').textContent = stats.totals["A+"];
      document.getElementById('tA').textContent     = stats.totals["A"];
      document.getElementById('tAminus').textContent= stats.totals["A-"];
      document.getElementById('tBplus').textContent = stats.totals["B+"];
      document.getElementById('tB').textContent     = stats.totals["B"];
      document.getElementById('tCplus').textContent = stats.totals["C+"];
      document.getElementById('tC').textContent     = stats.totals["C"];
      document.getElementById('tD').textContent     = stats.totals["D"];
      document.getElementById('tE').textContent     = stats.totals["E"];
      document.getElementById('tG').textContent     = stats.totals["G"];
      document.getElementById('tTH').textContent    = stats.totals["TH"];
    }

    function jana(){
      const stats = computeForSelection();
      if(!stats) return;
      renderKPI(stats);
      renderDonuts(stats);
      renderBar(stats);
    }

    // ==== MULA ====
    fetch(csvUrl).then(r=>r.text()).then(csv=>{
      parsedData = parseCSV(csv);
      populateDropdowns();
      // Jana kali pertama (keseluruhan + subjek pertama)
      jana();
    });

    document.getElementById('btnJana').addEventListener('click', jana);
    // jana automatik bila tukar pilihan
    document.getElementById('kelasSelect').addEventListener('change', jana);
    document.getElementById('subjekSelect').addEventListener('change', jana);
  </script>

</body>
</html>

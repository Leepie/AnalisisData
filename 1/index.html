<!DOCTYPE html>
<html lang="ms">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Data Analisis ‚Äî SMK Dato' Kamaruddin</title>

  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Chart.js CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    .sort-btn{display:inline-flex;flex-direction:column;align-items:center;justify-content:center;margin-left:4px;cursor:pointer}
    .sort-btn svg{width:12px;height:12px;fill:#9ca3af}
    .sort-btn.asc .up{fill:#2563eb}
    .sort-btn.desc .down{fill:#2563eb}

    /* Pembayang di tepi kawasan scroll (opsyenal) */
    .scroll-shadow{position:relative}
    .scroll-shadow::after{
     /* content:"";pointer-events:none;position:absolute;top:0;right:0;height:100%;width:24px;
      background:linear-gradient(to left, rgba(255,255,255,1), rgba(255,255,255,0)) */
      display:none !important;
    }

/* Tinggi carta lebih sesuai */
    #gradeChart{height:320px !important;}        /* desktop */
    @media (max-width:1024px){
      #gradeChart{height:300px !important;}      /* tablet */
    }
    @media (max-width:640px){
      #gradeChart{height:260px !important;}      /* telefon */
    }

  </style>
</head>
<body class="bg-gray-50 text-gray-800">

  <!-- Header -->
  <header class="bg-white shadow p-4 sm:p-5 flex items-center justify-between">
    <div class="flex items-center gap-3">
      <img src="https://upload.wikimedia.org/wikipedia/ms/b/ba/Sekolah_Menengah_Kebangsaan_Dato%27_Kamaruddin.jpg"
           alt="Logo Sekolah" class="w-10 h-10 sm:w-12 sm:h-12 rounded-full border" />
      <div>
        <h1 class="text-base sm:text-xl font-bold">PPSA</h1>
        <p class="text-xs sm:text-sm text-gray-600">Sistem Analisis Prestasi Akademik<br>
          <span class="font-medium text-blue-600">SMK Dato' Kamaruddin</span>
        </p>
      </div>
    </div>
    <p class="text-[10px] sm:text-xs text-gray-500">Data Percubaan SPM 2025</p>
  </header>

  <!-- Kandungan -->
  <main class="p-4 sm:p-6 max-w-7xl mx-auto space-y-6 sm:space-y-8">

    <!-- Card Analisis (sticky di hphone) -->
    <div class="bg-white rounded-xl shadow p-4 sm:p-6 sticky top-0 z-20">
      <h2 class="text-base sm:text-lg font-semibold flex items-center gap-2 mb-3 sm:mb-4">üìä Analisis Keseluruhan</h2>

      <div class="grid grid-cols-1 md:grid-cols-4 gap-3 sm:gap-4 items-end">
        <!-- Kelas -->
        <div>
          <label class="block text-xs sm:text-sm font-medium text-gray-700 mb-1">Kelas</label>
          <select id="kelasFilter" class="w-full border rounded-lg px-3 py-2 text-sm">
            <option value="">Pilih Kelas</option>
            <option>SEMUA KELAS</option>
          </select>
        </div>

        <!-- Bidang -->
        <div>
          <label class="block text-xs sm:text-sm font-medium text-gray-700 mb-1">Bidang</label>
          <select id="bidangFilter" class="w-full border rounded-lg px-3 py-2 text-sm">
            <option value="Semua Bidang">Semua Bidang</option>
            <option value="Bahasa">Bahasa</option>
            <option value="Kemanusiaan">Kemanusiaan</option>
            <option value="Sains & Matematik">Sains & Matematik</option>
            <option value="Teknik & Vokasional">Teknik & Vokasional</option>
          </select>
        </div>

        <!-- Murid Terbaik -->
        <div class="px-2 pb-2 text-[11px] text-gray-500 sm:hidden mobile-hint">
  ‚ÜîÔ∏è Seret untuk lihat semua lajur
       </div>

        <div>
          <label class="block text-xs sm:text-sm font-medium text-gray-700 mb-1">Murid Terbaik</label>
          <select id="topStudentsCount" class="w-full border rounded-lg px-3 py-2 text-sm">
            <option value="5">Top 5</option>
            <option value="10">Top 10</option>
            <option value="20">Top 20</option>
          </select>
        </div>

        <!-- Butang -->
        <div>
          <button onclick="generateOverallAnalysis()"
                  class="w-full bg-blue-600 hover:bg-blue-700 active:scale-[.99] text-white px-4 py-3 sm:py-2 rounded-xl font-semibold text-sm sm:text-base">
            Jana Analisis
          </button>
        </div>
      </div>
    </div>

    <!-- Kad Statistik -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 sm:gap-6">
      <div class="bg-blue-50 rounded-xl p-5 sm:p-6 shadow flex items-center justify-between">
        <div>
          <p class="text-sm text-blue-700">Gred Purata</p>
          <p class="text-3xl sm:text-4xl font-extrabold text-blue-800" id="schoolGPS">--</p>
        </div>
        <span class="text-blue-400 text-3xl">üìä</span>
      </div>
      <div class="bg-green-50 rounded-xl p-5 sm:p-6 shadow flex items-center justify-between">
        <div>
          <p class="text-sm text-green-700">Layak Sijil</p>
          <p class="text-3xl sm:text-4xl font-extrabold text-green-800" id="footerCertificatePercent">--%</p>
        </div>
        <span class="text-green-400 text-3xl">üéì</span>
      </div>
      <div class="bg-purple-50 rounded-xl p-5 sm:p-6 shadow flex items-center justify-between">
        <div>
          <p class="text-sm text-purple-700">Jumlah Murid</p>
          <p class="text-3xl sm:text-4xl font-extrabold text-purple-800" id="studentCount">--</p>
        </div>
        <span class="text-purple-400 text-3xl">üë•</span>
      </div>
    </div>

    <!-- Murid Terbaik (jadual desktop + boleh seret di telefon) -->
    <div id="muridTerbaikSection" class="hidden bg-white rounded-xl shadow p-4 sm:p-6">
      <h2 class="text-base sm:text-lg font-semibold mb-3 sm:mb-4">üèÜ Murid Terbaik</h2>

      <div class="scroll-shadow overflow-x-auto -mx-2 sm:mx-0">
        <div class="px-2 pb-2 text-[11px] text-gray-500 sm:hidden">‚ÜîÔ∏è Seret untuk lihat semua lajur</div>

        <table class="w-full text-xs sm:text-sm border-collapse min-w-[900px]">
          <thead>
            <tr class="bg-gradient-to-r from-purple-500 to-indigo-500 text-white">
              <th class="px-2 py-2">Ked.</th>
              <th class="px-2 py-2 text-left">Nama</th>
              <th class="px-2 py-2">Kelas</th>
              <th class="px-2 py-2">GP Murid</th>
              <th class="px-2 py-2">A+</th>
              <th class="px-2 py-2">A</th>
              <th class="px-2 py-2">A-</th>
              <th class="px-2 py-2">B+</th>
              <th class="px-2 py-2">B</th>
              <th class="px-2 py-2">C+</th>
              <th class="px-2 py-2">C</th>
            </tr>
          </thead>
          <tbody id="muridTerbaikBody" class="divide-y"></tbody>
        </table>
      </div>
    </div>

    <!-- Carta Taburan Gred -->
    <div id="gradeChartSection" class="hidden bg-white rounded-xl shadow p-4 sm:p-6">
      <h2 class="text-base sm:text-lg font-semibold mb-3 sm:mb-4">üìà Carta Taburan Gred</h2>
      <div class="w-full">
        <canvas id="gradeChart" class="w-full" height="340"></canvas>
      </div>
    </div>

    <!-- Jadual Analisis Mata Pelajaran (desktop + seret di telefon) -->
    <div id="analisisSubjekSection" class="hidden bg-white rounded-xl shadow p-4 sm:p-6">
      <h2 class="text-base sm:text-lg font-semibold mb-3 sm:mb-4">üìö Jadual Analisis Mata Pelajaran</h2>

      <div class="scroll-shadow overflow-x-auto -mx-2 sm:mx-0">
        <div class="px-2 pb-2 text-[11px] text-gray-500 sm:hidden">‚ÜîÔ∏è Seret untuk lihat semua lajur</div>

        <table class="w-full text-xs sm:text-sm border-collapse whitespace-nowrap min-w-[1100px]">
          <thead>
            <tr class="bg-green-600 text-white">
              <th class="px-2 py-2 text-left">Mata Pelajaran</th>
              <th class="px-2 py-2">Hadir</th>
              <th class="px-2 py-2">TH</th>
              <th class="px-2 py-2">A+</th>
              <th class="px-2 py-2">A</th>
              <th class="px-2 py-2">A-</th>
              <th class="px-2 py-2">B+</th>
              <th class="px-2 py-2">B</th>
              <th class="px-2 py-2">C+</th>
              <th class="px-2 py-2">C</th>
              <th class="px-2 py-2">D</th>
              <th class="px-2 py-2">E</th>
              <th class="px-2 py-2">G</th>
              <th class="px-2 py-2">%Lulus</th>
              <th class="px-2 py-2">%Gagal</th>
              <th class="px-2 py-2 flex items-center justify-center">
                GPMP
                <span id="gpmpSortBtn" class="sort-btn ml-1">
                  <svg class="up" viewBox="0 0 24 24"><path d="M7 14l5-5 5 5z"/></svg>
                  <svg class="down" viewBox="0 0 24 24"><path d="M7 10l5 5 5-5z"/></svg>
                </span>
              </th>
            </tr>
          </thead>
          <tbody id="analisisSubjekBody" class="divide-y"></tbody>
        </table>
      </div>
    </div>
  </main>

  <!-- Footer -->
  <footer class="text-center text-[10px] sm:text-xs p-4 text-gray-500 bg-white border-t">
    XCode Mr LePaK | SMK Dato' Kamaruddin | Percubaan SPM 2025
  </footer>

  <script>
    const csvUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTYrHZLkbHUM-5jja039uj6kW8gImj4V3pdg253c8C8wZfjVPusU2XT_0M9qjA6kq-X1wiFI4z2FIDq/pub?gid=22937657&single=true&output=csv";

    let parsedData = [], headerMap = {}, subjectColumns = [], chartInstance = null;
    let currentSubjectStats = [], originalSubjectStats = [];
    let sortState = "none"; // none ‚Üí asc ‚Üí desc

    const gradeValueMapping = { "A+":0,"A":1,"A-":2,"B+":3,"B":4,"C+":5,"C":6,"D":7,"E":8,"G":9 };
    const gradeLabels = ["A+","A","A-","B+","B","C+","C","D","E","G"];

    // Nama subjek
    const subjectNameMap = {
      "BM":"BAHASA MELAYU","BI":"BAHASA INGGERIS","BT":"BAHASA TAMIL","KT":"KESUSASTERAAN TAMIL",
      "M":"MATEMATIK","SN":"SAINS","MT":"MATEMATIK TAMBAHAN",
      "PAI":"PENDIDIKAN ISLAM","TAS":"TASAWWUR ISLAM","PAIM":"PENDIDIKAN ISLAM MPAK",
      "PM":"PENDIDIKAN MORAL","SEJ":"SEJARAH","GEO":"GEOGRAFI","PSV":"PENDIDIKAN SENI VISUAL",
      "PJK":"PENDIDIKAN JASMANI DAN KESIHATAN",
      "BIO":"BIOLOGI","KIM":"KIMIA","FIZ":"FIZIK",
      "SS":"SAINS SUKAN","SK":"SAINS KOMPUTER","SRT":"SAINS RUMAH TANGGA",
      "PER":"PERTANIAN","SPER":"SAINS PERTANIAN","PP":"PERNIAGAAN","PA":"PRINSIP PERAKAUAN","RC":"REKA CIPTA"
    };

    // Kumpulan Bidang ‚Üí kod subjek
    const subjectGroupMap = {
      "Bahasa": ["BM","BI","BT","KT"],
      "Kemanusiaan": ["PAI","TAS","PJK","PM","SEJ","GEO","PSV","PAIM"],
      "Sains & Matematik": ["M","SN","MT","FIZ","BIO","KIM"],
      "Teknik & Vokasional": ["SPER","PA","RC","PP","SRT","SK","PER","SS"]
    };

    function parseCSV(csv){
      const lines = csv.trim().split('\n');
      const lineSubjek = lines[1].split(',').map(h=>h.trim());
      const lineJenis  = lines[2].split(',').map(h=>h.trim());
      let currentSubjek = "";
      const headers = lineSubjek.map((subjek,i)=>{
        if(subjek) currentSubjek = subjek;
        return lineJenis[i] ? `${currentSubjek} ${lineJenis[i]}`.trim() : currentSubjek;
      });
      headers.forEach(h=>{ headerMap[h.toLowerCase()] = h; });

      // Kenal pasti kolum gred (cth: "BM G", "BI G", atau "GRED")
      subjectColumns = headers.filter(h => /\b(G|GRED|GRADE)\b/i.test(h));

      return lines.slice(3).map(line=>{
        const values = line.split(',');
        let obj={}; headers.forEach((h,i)=>obj[h]=values[i]?.trim()||''); return obj;
      });
    }

    function cariKolum(keyword){
      return Object.values(headerMap).find(h=>h.toLowerCase().includes(keyword));
    }



  function autoIsiDropdownKelas(data){
    const kelasHeader = cariKolum("kelas");
    if(!kelasHeader) return;

    // Dapatkan senarai unik kelas & tapis
    const kelasSet = new Set(
      data.map(r => (r[kelasHeader] || "").trim())
          .filter(k => 
            k && 
            k.toUpperCase() !== "SEMUA KELAS" && 
            k !== "1"                // üö´ buang kelas '1'
          )
    );

    const kelasFilter = document.getElementById("kelasFilter");
    kelasFilter.innerHTML = "";

    // Tambah option default + SEMUA KELAS
    const optDefault = document.createElement("option");
    optDefault.value = "";
    optDefault.textContent = "Pilih Kelas";
    kelasFilter.appendChild(optDefault);

    const optAll = document.createElement("option");
    optAll.value = "SEMUA KELAS";
    optAll.textContent = "SEMUA KELAS";
    kelasFilter.appendChild(optAll);

    // Susun ikut abjad dan masukkan
    [...kelasSet].sort((a,b)=>a.localeCompare(b,'ms',{numeric:true}))
      .forEach(k => {
        const opt = document.createElement("option");
        opt.value = k;
        opt.textContent = k;
        kelasFilter.appendChild(opt);
      });
  }



  function loadData(){
    fetch(csvUrl)
      .then(r => r.text())
      .then(csv => {
        parsedData = parseCSV(csv);
        autoIsiDropdownKelas(parsedData);   // ‚Üê isi dropdown dari CSV
      });
  }




    function filterSubjectsByBidang(subjects){
      const bidang = document.getElementById("bidangFilter").value;
      if(!bidang || bidang==="Semua Bidang") return subjects;
      const allowed = subjectGroupMap[bidang]||[];
      return subjects.filter(sub=>allowed.includes(sub));
    }

    function loadData(){
      fetch(csvUrl).then(r=>r.text()).then(csv=>{
        parsedData=parseCSV(csv);
        autoIsiDropdownKelas(parsedData);
      });
    }

    function generateOverallAnalysis(){
      const kelasHeader=cariKolum("kelas"), namaHeader=cariKolum("nama");
      const kelasTerpilih=document.getElementById("kelasFilter").value;

      let dataTapis=(!kelasTerpilih||kelasTerpilih==="SEMUA KELAS")? parsedData : parsedData.filter(r=>r[kelasHeader]===kelasTerpilih);

      let muridList=[]; let jumlahMurid=0,jumlahGredNilai=0,jumlahSubjek=0,muridLayak=0;

      dataTapis.forEach(row=>{
        const nama=row[namaHeader]; let gredList=[];
        subjectColumns.forEach(c=>{
          const g=row[c]?.toUpperCase();
          if(gradeValueMapping.hasOwnProperty(g)){
            gredList.push(g); jumlahGredNilai+=gradeValueMapping[g]; jumlahSubjek++;
          }
        });
        if(gredList.length){
          jumlahMurid++;
          const adaG=gredList.includes("G");
        //  if(gredList.length>=6 && !adaG) muridLayak++;

// Semak lulus BM & SEJ
const bm = row["BM G"]?.toUpperCase();
const sej = row["SEJ G"]?.toUpperCase();
if (bm && sej && bm !== "G" && sej !== "G") {
  muridLayak++;
}

          
          const gp=(gredList.reduce((a,g)=>a+gradeValueMapping[g],0)/gredList.length).toFixed(2);
          muridList.push({nama, kelas:row[kelasHeader], gp,
            counts: gradeLabels.reduce((acc,g)=>{acc[g]=gredList.filter(x=>x===g).length; return acc;},{})
          });
        }
      });

      const GPS=(jumlahSubjek? (jumlahGredNilai/jumlahSubjek).toFixed(2):"--");
      const peratusLayak=(jumlahMurid? ((muridLayak/jumlahMurid)*100).toFixed(1)+"%":"--%");

      document.getElementById("schoolGPS").textContent=GPS;
      document.getElementById("footerCertificatePercent").textContent=peratusLayak;
      document.getElementById("studentCount").textContent=jumlahMurid;

      // Murid terbaik
      muridList.sort((a,b)=>a.gp-b.gp);
      const top=document.getElementById("topStudentsCount").value;
      const body=document.getElementById("muridTerbaikBody"); body.innerHTML="";
      muridList.slice(0,top).forEach((m,i)=>{
        body.innerHTML += `
          <tr class="text-center">
            <td class="px-2 py-2">${i+1}</td>
            <td class="px-2 py-2 text-left">${m.nama}</td>
            <td class="px-2 py-2">${m.kelas}</td>
            <td class="px-2 py-2 font-bold text-blue-600">${m.gp}</td>
            ${["A+","A","A-","B+","B","C+","C"].map(g=>{
              const val=m.counts[g]||0;
              return `<td class="px-2 py-2">${val}</td>`;
            }).join("")}
          </tr>`;
      });
      document.getElementById("muridTerbaikSection").classList.remove("hidden");

      updateGradeChartBySubject(dataTapis);
      document.getElementById("gradeChartSection").classList.remove("hidden");

      updateSubjectAnalysis(dataTapis);
    }

    function updateGradeChartBySubject(dataTapis){
      const ctx=document.getElementById("gradeChart").getContext("2d");

      let subjects=[...new Set(subjectColumns.map(c=>c.split(" ")[0]))]
        .filter(s=>s.toUpperCase()!=="GRED" && s!=="G");
      subjects = filterSubjectsByBidang(subjects);

      const countsPerSubject={}; subjects.forEach(sub=>{countsPerSubject[sub]=Object.fromEntries(gradeLabels.map(g=>[g,0]))});

      dataTapis.forEach(row=>{
        subjectColumns.forEach(col=>{
          const gred=row[col]?.trim().toUpperCase();
          if(gradeValueMapping.hasOwnProperty(gred)){
            const subjek=col.split(" ")[0];
            if(subjek.toUpperCase()!=="GRED" && subjek!=="G" && subjects.includes(subjek)){
              countsPerSubject[subjek][gred]++;
            }
          }
        });
      });

      const gradeColors={"A+":"#16a34a","A":"#22c55e","A-":"#86efac","B+":"#eab308","B":"#facc15","C+":"#fb923c","C":"#f97316","D":"#f87171","E":"#ef4444","G":"#991b1b"};

      const datasets=gradeLabels.map(g=>({label:g,data:subjects.map(sub=>countsPerSubject[sub][g]),backgroundColor:gradeColors[g],stack:"Stack 0"}));

      if(chartInstance) chartInstance.destroy();
      chartInstance = new Chart(ctx,{
        type:"bar",
        data:{labels:subjects,datasets},
        options:{
          responsive:true,
          maintainAspectRatio:false,
          plugins:{legend:{position:"top"}},
          scales:{x:{ticks:{maxRotation:0,minRotation:0}}}
        }
      });
    }

    function updateSubjectAnalysis(dataTapis){
      let subjects=[...new Set(subjectColumns.map(c=>c.split(" ")[0]))]
        .filter(s=>s.toUpperCase()!=="GRED" && s!=="G");
      subjects = filterSubjectsByBidang(subjects);

      currentSubjectStats = subjects.map(sub=>{
        let counts=Object.fromEntries(gradeLabels.map(g=>[g,0]));
        let hadir=0,th=0,totalNilai=0;
        dataTapis.forEach(row=>{
          const col=subjectColumns.find(c=>c.startsWith(sub+" "));
          const gred=row[col]?.toUpperCase();
          if(gradeValueMapping.hasOwnProperty(gred)){counts[gred]++; hadir++; totalNilai+=gradeValueMapping[gred];}
          else if(gred==="TH"){th++;}
        });
        const lulus=hadir-(counts["G"]||0);
        const gagal=(counts["G"]||0);
        const peratusLulus=hadir?((lulus/hadir)*100).toFixed(1):"0.0";
        const peratusGagal=hadir?((gagal/hadir)*100).toFixed(1):"0.0";
        const gpmp=hadir?(totalNilai/hadir).toFixed(2):"--";
        return {sub, counts, hadir, th, peratusLulus, peratusGagal, gpmp};
      });

      originalSubjectStats=[...currentSubjectStats];
      renderSubjectTable();
      document.getElementById("analisisSubjekSection").classList.remove("hidden");
    }

    function renderSubjectTable(){
      const body=document.getElementById("analisisSubjekBody"); body.innerHTML="";
      let stats=[...currentSubjectStats];

      if(sortState==="asc"){stats.sort((a,b)=>(parseFloat(a.gpmp)||99)-(parseFloat(b.gpmp)||99));}
      else if(sortState==="desc"){stats.sort((a,b)=>(parseFloat(b.gpmp)||-1)-(parseFloat(a.gpmp)||-1));}
      else {stats=[...originalSubjectStats];}

      stats.forEach(s=>{
        const label=subjectNameMap[s.sub]?`[${s.sub}] - ${subjectNameMap[s.sub]}`:s.sub;
        body.innerHTML += `
          <tr class="text-center">
            <td class="px-2 py-2 text-left font-medium">${label}</td>
            <td class="px-2 py-2 text-blue-600">${s.hadir}</td>
            <td class="px-2 py-2">${s.th}</td>
            ${["A+","A","A-","B+","B","C+","C","D","E","G"].map(g=>{
              const cls=(g==="A+"||g==="A"||g==="A-")?"bg-green-50":(g==="B+"||g==="B")?"bg-yellow-50":"bg-red-50";
              return `<td class="px-2 py-2 ${cls}">${s.counts[g]}</td>`;
            }).join("")}
            <td class="px-2 py-2 text-green-600 font-medium">${s.peratusLulus}%</td>
            <td class="px-2 py-2 text-red-600 font-medium">${s.peratusGagal}%</td>
            <td class="px-2 py-2 text-purple-600 font-bold">${s.gpmp}</td>
          </tr>`;
      });
    }

    document.getElementById("gpmpSortBtn").addEventListener("click",()=>{
      if(sortState==="none"){sortState="asc";}
      else if(sortState==="asc"){sortState="desc";}
      else {sortState="none";}
      document.getElementById("gpmpSortBtn").classList.remove("asc","desc");
      if(sortState!=="none"){document.getElementById("gpmpSortBtn").classList.add(sortState);}
      renderSubjectTable();
    });

    window.onload = loadData;
  </script>
</body>
</html>

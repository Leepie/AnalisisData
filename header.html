<!DOCTYPE html>
<html lang="ms">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Header PPSA â€” Janalytics</title>

  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    header{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    /* Titik nadi hijau */
    .pulse-dot{position:relative}
    .pulse-dot::after{
      content:"";
      position:absolute;inset:-6px;
      border-radius:9999px;border:2px solid rgba(34,197,94,.4);
      animation:pulse 1.6s cubic-bezier(.4,0,.2,1) infinite;
    }
    @keyframes pulse{
      0%{transform:scale(.6);opacity:.9}
      70%{transform:scale(1.4);opacity:0}
      100%{transform:scale(1.4);opacity:0}
    }
  </style>
</head>
<body class="bg-gray-50 text-gray-800">

  <!-- Header (susun atur mengikut spesifikasi) -->
  <header class="bg-white shadow-sm border-b">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
      <div class="flex items-center justify-between">
        <!-- Kiri -->
        <div class="flex items-center space-x-4">
          <img src="https://upload.wikimedia.org/wikipedia/ms/b/ba/Sekolah_Menengah_Kebangsaan_Dato%27_Kamaruddin.jpg"
               alt="SMK Dato' Kamaruddin Logo" class="h-16 w-16 object-contain rounded-full border"/>
          <div>
            <h1 class="text-2xl font-bold text-gray-900">XCode Mr LePaK</h1>
            <p class="text-sm text-gray-600">--</p>
            <p class="text-sm font-medium text-gray-800">SMK Dato` Kamaruddin</p>
            <div class="flex items-center space-x-2 mt-1">
              <div class="w-2 h-2 bg-green-500 rounded-full pulse-dot"></div>
              <span class="text-xs text-gray-600">XCode Mr LePaK</span>
            </div>
          </div>
        </div>

        <!-- Kanan: KPI -->
        <div class="flex space-x-6">
          <div class="text-center">
            <div class="text-3xl font-bold text-blue-600" id="gpsValue">-</div>
            <div class="text-sm text-gray-600">Gred Purata Sekolah</div>
          </div>
          <div class="text-center">
            <div class="text-3xl font-bold text-green-600" id="layakSijilValue">-</div>
            <div class="text-sm text-gray-600">Peratus Layak Sijil</div>
          </div>
        </div>
      </div>
    </div>
  </header>

  <script>
    // === KONFIG CSV (guna pautan rujukan yang cikgu beri sebelum ini) ===
    const csvUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTYrHZLkbHUM-5jja039uj6kW8gImj4V3pdg253c8C8wZfjVPusU2XT_0M9qjA6kq-X1wiFI4z2FIDq/pub?gid=22937657&single=true&output=csv";

    // Pemetaan nilai gred untuk kiraan GPS
    const gradeValueMapping = { "A+":0,"A":1,"A-":2,"B+":3,"B":4,"C+":5,"C":6,"D":7,"E":8,"G":9 };

    let headerMap = {}, subjectColumns = [];

    // Cari nama kolum (case-insensitive)
    function cariKolum(keyword){
      const k = keyword.toLowerCase();
      return Object.values(headerMap).find(h => (h||"").toLowerCase().includes(k));
    }
    // Cari kolum gred bagi subjek (cth "BM G", "SEJ G", atau variasi)
    function cariKolumGredSubjek(kod){
      const upper = kod.toUpperCase();
      return Object.values(headerMap).find(h => {
        const H = (h||"").toUpperCase();
        return H.startsWith(upper + " ") && /\b(G|GRED|GRADE)\b/.test(H);
      });
    }

    function parseCSV(csv){
      const lines = csv.trim().split(/\r?\n/);
      // Fail rujukan guna baris 2 = subjek, baris 3 = jenis, data bermula baris 4
      const lineSubjek = (lines[1]||"").split(',').map(s=>s.trim());
      const lineJenis  = (lines[2]||"").split(',').map(s=>s.trim());

      let currentSubjek = "";
      const headers = lineSubjek.map((subjek,i)=>{
        if(subjek) currentSubjek = subjek;
        return lineJenis[i] ? `${currentSubjek} ${lineJenis[i]}`.trim() : currentSubjek;
      });

      // Peta header asal
      headerMap = {};
      headers.forEach(h => headerMap[(h||"").toLowerCase()] = h);

      // Kenal pasti kolum gred (cth: "BM G", "SEJ G", "M GRED", dll.)
      subjectColumns = headers.filter(h => /\b(G|GRED|GRADE)\b/i.test(h||""));

      // Data bermula baris ke-4
      const dataRows = lines.slice(3).map(row => {
        const vals = row.split(',');
        const obj = {};
        headers.forEach((h, i) => obj[h] = (vals[i]||"").trim());
        return obj;
      });
      return dataRows;
    }

    async function kiraDanPaparkan(){
      const gpsEl = document.getElementById('gpsValue');
      const sijilEl = document.getElementById('layakSijilValue');

      try{
        const res = await fetch(csvUrl);
        const csv = await res.text();
        const data = parseCSV(csv);

        // Kiraan GPS (purata semua gred sah di semua subjek)
        let jumlahNilai = 0, bilGred = 0;
        data.forEach(row=>{
          subjectColumns.forEach(col=>{
            const g = (row[col]||"").toUpperCase();
            if(gradeValueMapping.hasOwnProperty(g)){
              jumlahNilai += gradeValueMapping[g];
              bilGred += 1;
            }
          });
        });
        const gps = bilGred ? (jumlahNilai / bilGred).toFixed(2) : "-";
        gpsEl.textContent = gps;

        // Peratus Layak Sijil:
        // Kaedah rujukan: Layak jika BM & SEJ bukan "G".
        const bmCol  = cariKolumGredSubjek("BM");
        const sejCol = cariKolumGredSubjek("SEJ");

        let jumlahMurid = 0, layak = 0;
        data.forEach(row=>{
          // Kira murid yang ada sekurang-kurangnya satu gred sah
          const adaGred = subjectColumns.some(col => gradeValueMapping.hasOwnProperty((row[col]||"").toUpperCase()));
          if(!adaGred) return;

          jumlahMurid++;
          const bm  = (bmCol ? row[bmCol]  : "").toUpperCase();
          const sej = (sejCol? row[sejCol] : "").toUpperCase();

          if(bm && sej && bm!=="G" && sej!=="G"){ layak++; }
        });

        const peratusLayak = jumlahMurid ? ((layak / jumlahMurid) * 100).toFixed(1) + "%" : "-";
        sijilEl.textContent = peratusLayak;

      }catch(err){
        console.error(err);
        gpsEl.textContent = "-";
        sijilEl.textContent = "-";
      }
    }

    window.addEventListener('load', kiraDanPaparkan);
  </script>
</body>
</html>
